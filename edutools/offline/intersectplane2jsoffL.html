<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    
    <title>intersectplane2.cdy</title>
    <style type="text/css">
        * {
            margin: 0px;
            padding: 0px;
        }

        #CSConsole {
            background-color: #FAFAFA;
            border-top: 1px solid #333333;
            bottom: 0px;
            height: 200px;
            overflow-y: scroll;
            position: fixed;
            width: 100%;
        }
    </style>
    <link rel="stylesheet" href="ketcindyjs/CindyJS.css">
   <script type="text/javascript" src="ketcindyjs/Cindy.js"></script>

<script id="csinit" type="text/x-cindyscript">
Invert(x):=reverse(x);
Op(n,object):=( //  16.05.25
  regional(out);
  if(islist(object),
    out=object_n;
  ,
    if(isstring(object),
      out=substring(object,n-1,n);
    );
  );
  out;
);
Toupper(str):=(
  regional(alphabet,out,tmp,tmp1);
  alphabet="abcdefghijklmnopqrstuvwxyz";
  out="";
  forall(1..(length(str)),
    tmp=substring(str,#-1,#);
    tmp1=indexof(alphabet,tmp);
    if(tmp1>0,
      out=out+unicode(text(tmp1+64),base->10);
    ,
      out=out+tmp;
    );
  );
  out;
);
Bracket(str):=Bracket(str,"()");
Bracket(str,br):=(
  regional(ph,pt,out,noL,ncL,nall,level,tmp);
  ph=substring(br,0,1);
  pt=substring(br,1,2);
  noL=Indexall(str,ph);
  ncL=Indexall(str,pt); // 16.05.22until
  nall=sort(concat(noL,ncL));
  level=0;
  out=[];
  forall(nall,
    if(contains(noL,#),
      level=level+1;
      tmp=[#,level];
    ,
      tmp=[#,-level];
      level=level-1;
    );
    out=append(out,tmp);
  );
  out;
);
Indexall(str,key):=(
  regional(rest,out,flg,tmp,tmp1,);
  out=[];
  rest=str;
  flg=0;
  forall(1..(length(str)),
    if(flg==0,
      tmp=indexof(rest,key);
      if(tmp>0,
        tmp1=tmp+length(str)-length(rest);
        out=append(out,tmp1);
        rest=substring(rest,tmp,length(rest));
      ,
        flg=1;
      );
    );
  );
  out;
);
Listplot(list):=Listplot(list,[]);
Listplot(Arg1,Arg2):=(
  regional(name,list,options,str);
  if(isstring(Arg1),
    name=Arg1;
    list=Arg2;
    Listplot(name,list,[]);
  ,
    list=Arg1;
    options=Arg2;
    name="";
    forall(list, // 16.10.07from
       name=name+#.name;
    );// 16.10.07until
    Listplot(name,list,options);
  );
);
Listplot(nm,list,options):=(
  regional(name,cutend,tmp,tmp1,tmp2,ptlist,Ltype,opcindy,Noflg,eqL,Msg,color,color4);
  if(substring(nm,0,1)=="-",  // 16.01.27 from
    name=substring(nm,1,length(nm));
  ,
    name="sg"+nm;
  ); // upto
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  eqL=tmp_5;
  color=tmp_(length(tmp)-2); color4=Colorrgb2cmyk(color); //200618
  opcindy=tmp_(length(tmp));
  Msg="Y";  //190206
 Msg="N"; //
  cutend=[0,0];//180719
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1));
    if(tmp1=="M",
      Msg=Toupper(substring(tmp_2,0,1));
    );
    if(tmp1=="C",//180719from
      tmp2=replace(tmp_2,"[","");
      tmp2=replace(tmp2,"]","");
      cutend=tokenize(tmp2,",");
      if(length(cutend)==1,cutend=[cutend_1,cutend_1]);     
    );//180719to
  );
  if(Noflg<3,
    if(Msg=="Y", //190206
      println("generate Listplot "+name);
    );
    if(isstring(list_1),tmp=apply(list,parse(#)),tmp=list); // 15.03.24
    ptlist=apply(tmp,Pcrd(#));
    if(|cutend|>0,//180719from
      tmp=ptlist_(length(ptlist))-ptlist_1;
      tmp=tmp/|tmp|;
      ptlist_1=ptlist_1+tmp*cutend_1;
      ptlist_(length(ptlist))=ptlist_(length(ptlist))-tmp*cutend_2;
    );//180719to
    tmp=name+"="+Textformat(ptlist,5)+";"; //190415
    parse(tmp);
  );
  if(Noflg<3, //190818
    if(isstring(Ltype),
      Ltype=Getlinestyle(text(Noflg)+Ltype,name);
    ,
      if(Noflg==1,Ltype=0);
    );
    GCLIST=append(GCLIST,[name,Ltype,opcindy]);
  );
  tmp1=apply(list,Lcrd(#));
  tmp1;
);
Divoptions(options):=(
  regional(Ltype,Noflg,Inflg,Outflg,eqL,realL,strL,
      color,opstr,opcindy,flg,tmp,tmp1,tmp2);
  Ltype="dr";  // 2015.01.13
  Noflg=0;
  Inflg=0;
  Outflg=0;
  eqL=[];
  realL=[];
  strL=[];
  color=Colorcmyk2rgb(KCOLOR); //200513
  opstr="";
  opcindy="";
  forall(options,
    flg=0;
    if(flg==0,
      if(isreal(#) % ispoint(#) % islist(#),
        realL=append(realL,#);
        opstr=opstr+","+text(#);
        flg=1;
      );
    );
    if(flg==0,
      if(indexof(#,"=")>0,
        tmp=Strsplit(#,"="); //180602from
        tmp1=Toupper(tmp_1);
        tmp2=tmp_2;
        if(tmp1=="COLOR",
          if(indexof(tmp2,"[")>0, //180928
            tmp1=parse(tmp2);
            color=tmp1;
            if(length(tmp1)==4,
              tmp1=Colorcmyk2rgb(tmp1);
            );
          ,
            color=Colorname2cmyk(tmp2);//200425
            tmp1=Colorcmyk2rgb(color); ;//200425
          );
          tmp="color->"+text(tmp1);
          opcindy=opcindy+","+tmp;
        ,
          eqL=append(eqL,#);
        );//180602to
        flg=1; 
      );
    );
    if(flg==0,
      if(indexof(#,"no")+indexof(#,"No")>0,
        if(indexof(#,"tex")>0,Noflg=1);
        if(indexof(#,"disp")>0,Noflg=2);
        if(indexof(#,"data")>0,Noflg=3);
        flg=1;
      );
    );
    if(flg==0,
      if(indexof(#,"->")>0,
        opcindy=opcindy+","+#;
        flg=1; 
      );
    );
    if(flg==0,
      if(indexof(#,"out")+indexof(#,"Out")>0,
        if(indexof(#,"-")==0,
          Outflg=1;
        ,
          Outflg=2;
        );
        flg=1;
      );
    );
    if(flg==0,
      if(indexof(#,"in")+indexof(#,"In")>0,
        if(indexof(#,"-")==0,
          Inflg=1;
        ,
          Inflg=2;
        );
        flg=1;
      );
    );
    if(flg==0,
      tmp=substring(#,0,2);
      tmp1=indexof(tmp,"dr")+indexof(tmp,"Dr");
      tmp1=tmp1+indexof(tmp,"da")+indexof(tmp,"Da");
      tmp1=tmp1+indexof(tmp,"id")+indexof(tmp,"Id");
      tmp1=tmp1+indexof(tmp,"do")+indexof(tmp,"Do");
      tmp1=tmp1+indexof(tmp,"dp")+indexof(tmp,"Dp");
      if(tmp1>0,
        Ltype=#;
        flg=1;
      );
      if(flg==0,
        if(length(#)>0, //180408
          strL=append(strL,#);
          opstr=opstr+","+Dq+#+Dq;
        );
      );
    );
  );
  if(indexof(opcindy,"color->")==0,// 16.10.07from
    tmp=Colorcmyk2rgb(KCOLOR); //200513[2lines]
    opcindy=opcindy+",color->"+text(tmp);
  );
  [Ltype,Noflg,Inflg,Outflg,eqL,realL,strL,color,opstr,opcindy];
);
Strsplit(str,key):=( // 210422 renewed
  regional(tmp,out);
  tmp=tokenize(str,key);
  out=apply(tmp,if(!isstring(#),Textformat(#,10),#));
  out;
);
Textformat(value,dig):=(
  regional(vv,tmp,tmp1);
  if(islist(value),
    tmp1="[";
    forall(value,
      tmp1=tmp1+Textformat(#,dig)+",";
    );
    if(length(tmp1)>1, //18.01.29from
      tmp1=substring(tmp1,0,length(tmp1)-1);
    );
    tmp1=tmp1+"]"; //18.01.29until
  ,
    if(ispoint(value) % isstring(value),
      if(isstring(value),tmp1=Dq+value+Dq,tmp1=text(value)); // 15.10.02
    ,
      tmp1=format(value,dig);
    );
  );
  tmp1;
);
Colorname2cmyk(name):=( //181212
  regional(dL,code,tmp);
  dL=[
    ["greenyellow",[0.15,0,0.69,0]],["yellow",[0,0,1,0]],
    ["goldenrod",[0,0.1,0.84,0]],["dandelion",[0,0.29,0.84,0]],
    ["apricot",[0,0.32,0.52,0]],["peach",[0,0.5,0.7,0]],
    ["melon",[0,0.46,0.5,0]],["yelloworange",[0,0.42,1,0]],
    ["orange",[0,0.61,0.87,0]],["burntorange",[0,0.51,1,0]],
    ["bittersweet",[0,0.75,1,0.24]],["redorange",[0,0.77,0.87,0]],
    ["mahogany",[0,0.85,0.87,0.35]],["maroon",[0,0.87,0.68,0.32]],
    ["brickred",[0,0.89,0.94,0.28]],["red",[0,1,1,0]],
    ["orangered",[0,1,0.5,0]],["rubinered",[0,1,0.13,0]],
    ["wildstrawberry",[0,0.96,0.39,0]],["salmon",[0,0.53,0.38,0]],
    ["carnationpink",[0,0.63,0,0]],["magenta",[0,1,0,0]],
    ["violetred",[0,0.81,0,0]],["rhodamine",[0,0.82,0,0]],
    ["mulberry",[0.34,0.9,0,0.02]],["redviolet",[0.07,0.9,0,0.34]],
    ["fuchsia",[0.47,0.91,0,0.08]],["lavender",[0,0.48,0,0]],
    ["thistle",[0.12,0.59,0,0]],["orchid",[0.32,0.64,0,0]],
    ["darkorchid",[0.4,0.8,0.2,0]],["purple",[0.45,0.86,0,0]],
    ["plum",[0.5,1,0,0]],["violet",[0.79,0.88,0,0]],
    ["royalpurple",[0.75,0.9,0,0]],["blueviolet",[0.86,0.91,0,0.04]],
    ["periwinkle",[0.57,0.55,0,0]], ["cadetblue",[0.62,0.57,0.23,0]],
    ["cornflowerblue",[0.65,0.13,0,0]],
    ["midnightblue",[0.98,0.13,0,0.43]],
    ["navyblue",[0.94,0.54,0,0]],["royalblue",[1,0.5,0,0]],
    ["blue",[1,1,0,0]],["cerulean",[0.94,0.11,0,0]],
    ["cyan",[1,0,0,0]],["processblue",[0.96,0,0,0]],
    ["skyblue",[0.62,0,0.12,0]],["turquoise",[0.85,0,0.2,0]],
    ["tealblue",[0.86,0,0.34,0.02]],["aquamarine",[0.82,0,0.3,0]],
    ["bluegreen",[0.85,0,0.33,0]],["emerald",[1,0,0.5,0]],
    ["junglegreen",[0.99,0,0.52,0]],["seagreen",[0.69,0,0.5,0]],
    ["green",[1,0,1,0]],["forestgreen",[0.91,0,0.88,0.12]],
    ["pinegreen",[0.92,0,0.59,0.25]],["limegreen",[0.5,0,1,0]],
    ["yellowgreen",[0.44,0,0.74,0]],["springgreen",[0.26,0,0.76,0]],
    ["olivegreen",[0.64,0,0.95,0.4]],["rawsienna",[0,0.72,1,0.45]],
    ["sepia",[0,0.83,1,0.7]],["brown",[0,0.81,1,0.6]],
    ["tan",[0.14,0.42,0.56,0]],["gray",[0,0,0,0.5]],
    ["lightgray",[0,0,0,0.15]], //190429,0809
    ["cindycolor",[0.125,0.083,0,0.247]], //201027
    ["black",[0,0,0,1]],["white",[0,0,0,0]],
    ["offwhite",[0,0,0,0.03]] //190809
  ];
  tmp=select(dL,#_1==name);
  if(length(tmp)>0,
    tmp=tmp_1;
    code=tmp_2;
  ,
    println("    "+name+" not found");
    code=Assign(name); //190323
  );
);
Assign(str):=( //190125from
  regional(tmp);
  tmp=[];
  forall(VLIST,tmp=concat(tmp,[#_1,#_2]));
  Assign(str,tmp);
); //190125to
Assign(funstr,vrL):=Assign(funstr,vrL,6);
Assign(funstr,Arg1,Arg2):=( //190813from
  regional(vrL,precise,nn,out,tmp);
  if(islist(Arg1),
    vrL=Arg1; precise=Arg2;
    nn=length(vrL)/2;
    out=funstr;
    forall(1..nn,
      out=Assign(out,vrL_(2*#-1),vrL_(2*#),precise);
    );
  , 
    out=Assign(funstr,Arg1,Arg2,6);
  );
  out;
); //190813to
Assign(funstr,varname,rep,precision):=(
  regional(repstr,ii,jj,tmp,tmp1,tmp2,Notvar,Flg);
  if(isstring(rep),repstr=rep,repstr="("+Textformat(rep,precise)+")"); //190811to
  tmp=[46];  // 12.20
  tmp=concat(tmp,48..57);
  tmp=concat(tmp,65..90);
  tmp=concat(tmp,97..122);
  Notvar=apply(tmp,unicode(text(#),base->10));
  tmp2="";
  forall(1..100,
    ii=indexof(funstr,varname);
    if(ii>0,
      Flg=0;
      if(ii>1,
        tmp=substring(funstr,ii-2,ii-1);
        if(contains(Notvar,tmp),
          tmp2=tmp2+substring(funstr,0,ii);
          funstr=substring(funstr,ii,length(funstr));
          Flg=1;
        );
      );
      if(Flg==0,
        jj=ii-1+length(varname);
        if(jj<length(funstr),
          tmp=substring(funstr,jj,jj+1));
          if(contains(Notvar,tmp),
          tmp2=tmp2+substring(funstr,0,jj);
          funstr=substring(funstr,jj,length(funstr));
          Flg=1;
        );
      );
      if(Flg==0,
        tmp2=tmp2+substring(funstr,0,ii-1)+repstr;
        funstr=substring(funstr,jj,length(funstr));
      );
    );
  );
  funstr=tmp2+funstr;
  funstr;
);
Colorcmyk2rgb(clr):=(
  regional(clrnew,tmp,black);
  if(length(clr)==4,  //200618
    black=clr_4;
    tmp=apply(clr,1-min(1,#*(1-black)+black));
    clrnew=tmp_(1..3);
  ,
    clrnew=clr;  //200618
  );
  clrnew;
);
Colorrgb2cmyk(clr):=(
  regional(clrnew,tmp,black);
  if(length(clr)==3, //200618
    tmp=apply(clr,1-#);
    black=min(tmp);
    if(black!=1, //181112from
      tmp=apply(clr,(1-#-black)/(1-black));
      clrnew=append(tmp,black);
    ,
      clrnew=[0,0,0,1];  //200618
    ); //181112to
  ,
    clrnew=clr;
  );
  clrnew;
);
Pcrd(pt):=(
  regional(tmp);
  if(ispoint(pt),
    tmp=pt.xy;
  ,
    tmp=[pt_1*SCALEX,pt_2*SCALEY];
  );
 re(tmp); //191231
);
Getlinestyle(str,name):=(
  regional(noflg,tmp,tmp1,tmp2,Dop,Ltype,subflg);
  Ltype=-1;
  Dop="";
  tmp1=indexof(str,",");
  if(tmp1>0,
    Dop=","+substring(str,tmp1,length(str));
  );
  noflg=parse(substring(str,0,1));
  if(substring(name,0,3)=="sub",subflg=1,subflg=0);  // 16.02.29
  if(noflg<=1, //1900818from
    tmp1=Toupper(substring(str,1,3));
  ,
    tmp1="NO";
  ); //1900818to
  tmp2=""; //190119from
  tmp=indexof(str,",");
  if(tmp>0,
    tmp2=substring(str,tmp,length(str));
  ); //190119to
  if(tmp1=="DR",
    if(length(tmp2)==0,tmp2="1"); //190125
    Ltype=[0,tmp2];  //190119
    if(noflg==0 & subflg==0, // 16.02.29
    );
  );
  if(tmp1=="DA",
    if(length(tmp2)==0,tmp2="1,1"); //190125
    if(indexof(tmp2,",")==0,tmp2=tmp2+",1"); //200911
    Ltype=[1,tmp2];  //190119
    if(noflg==0 & subflg==0, // 16.02.29
    );
  );
  if(tmp1=="ID",
    if(length(tmp2)==0,tmp2="1,1"); //190125
    if(indexof(tmp2,",")==0,tmp2=tmp2+",1"); //200911
    Ltype=[2,tmp2];  //190119
    if(noflg==0 & subflg==0, // 16.02.29
    );
  );
  if(tmp1=="DO",
    if(length(tmp2)==0,tmp2="1,1"); //190125
    if(indexof(tmp2,",")==0,tmp2=tmp2+",1"); //200911
    Ltype=[3,tmp2];  //190119
    if(noflg==0 & subflg==0, // 16.02.29
    );
  );
  if(tmp1=="DP",
    if(length(tmp2)==0,tmp2="1"); //190125
    Ltype=[0,tmp2];  //190119
    tmp1=parse(name);
    tmp2="";
    forall(tmp1,
      tmp2=tmp2+Textformat(#_1,5)+",";
    );
    tmp2=substring(tmp2,0,length(tmp2)-1);
    if(noflg==0,
    );
  );
  if(tmp1=="NO", //190818from
    Ltype=[-1,"0"];
  );  //190818to
  Ltype;
);
Lcrd(pt):=(
  regional(tmp);
  if(ispoint(pt),
    tmp=[pt.x/SCALEX,pt.y/SCALEY];
  ,
    tmp=pt;
  );
  re(tmp); //191231
);
Shade(plist):=Shade(plist,[]); 
Shade(Arg1,Arg2):=(
  if(!isstring(Arg1),
    Shade(text(SHADECTR),Arg1,Arg2); //190222
  ,
    Shade(Arg1,Arg2,[]);
  );
);
Shade(nm,plistorg,options):=(
  regional(name,plist,jj,nn,trim,first,tmp,tmp1,tmp2,Noflg,
     opstr,opcindy,eqL,reL,Str,G2,flg,encflg,startpt,color,color4,ctr,ptshade);
  if(substring(nm,0,1)=="-", //200513from
    name=substring(nm,1,length(nm));
  ,
    name="shade"+nm;
  ); //200513to
  plist=plistorg;
  tmp=Divoptions(options);
  Noflg=tmp_2; //200512
  eqL=tmp_5; 
  reL=tmp_6;
  color=tmp_(length(tmp)-2); color4=Colorrgb2cmyk(color); //200618
  opstr=tmp_(length(tmp)-1);
  opcindy=tmp_(length(tmp));
  encflg=0; //201029
  tmp=select(plist,indexof(#,"Invert")>0); //180929from
  trim="N";
  first="N"; //191007
  ptshade="N"; //200513
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(tmp_1);
    tmp2=Toupper(tmp_2);
    if(substring(tmp1,0,1)=="E",
      if(substring(tmp2,0,1)=="Y",
        encflg=1;
      );
    );
    if(substring(tmp1,0,1)=="T",
      trim=substring(tmp2,0,1);
    );
    if(substring(tmp1,0,1)=="F",
      first=substring(tmp2,0,1);
    );
    if(substring(tmp1,0,1)=="P", //200513[3lines]
      ptshade=Toupper(substring(tmp2,0,1));
    );
  );
  startpt=[];
  forall(reL,
    if(islist(#),
      startpt=#;
    );
  ); //180929to
  flg=0; ctr=1;
  if(encflg==1, //180929from
    if(length(startpt)==2,
      Enclosing(nm,plist,[startpt,"nodisp"]);
    ,
      Enclosing(nm,plist,["nodisp"]);
    );
    plist=["en"+nm];
  ); //180929to
  if((length(plist)==1)&(trim=="Y"), //190220from,109224
    plist=[Shadein(plist)];
  ); //190220to
  forall(1..(length(plist)),jj, //180613from
    if(flg==0,
      tmp1=plist_jj;
      if(isstring(tmp1),tmp=parse(tmp1),tmp=tmp1);
      if(!islist(tmp),
         flg=1;
      ,
        if(!isstring(tmp1),
          tmp2=[];
          forall(tmp1,if(ispoint(#),tmp=#.xy,tmp=#);
            tmp2=append(tmp2,tmp);
          );
          Listplot("-"+name+text(ctr),tmp2,["nodisp"]); //190520
          plist_jj=name+text(ctr);
          ctr=ctr+1;
        );
      ); 
    );
  );//180613to
  if(flg==1,
    println("    Shade : some data not defined properly");
 ,
    if(Noflg<2, //200512
      G2=Joincrvs("1",plist,["nodata"]);
      G2=apply(G2,Pcrd(#));
      tmp1="fillpoly("+Textformat(G2,10)+opcindy+");";
      if(ptshade=="N", //200513from
        tmp=select(1..(length(GCLIST)),contains(plist,GCLIST_#_1)); //200715from
        if(length(tmp)>0,
          nn=min(tmp);
        ,
          nn=length(GCLIST)+1;
        );
        tmp2=GCLIST_(1..(nn-1));
        tmp2=append(tmp2,[tmp1,[5,0]]);
        GCLIST=concat(tmp2,GCLIST_(nn..(length(GCLIST))));
      ,
        PTSHADElist=append(PTSHADElist,[name,tmp1]);
      ); //200513to
    );
  );
  SHADECTR=SHADECTR+1;
);
Enclosing(nm,plist):=Enclosing2(nm,plist,[]);//180706[2lines]
Enclosing(nm,plistorg,options):=Enclosing2(nm,plistorg,options);
Enclosing2(nm,plist):=Enclosing2(nm,plist,[]);
Enclosing2(nm,plistorg,options):=(
  regional(name,plist,AnsL,Start,Eps,Eps1,Eps2,flg,Fdata,Gdata,KL,
      t1,t2,tst,ss,ii,nn,nxtno,Ltype,Noflg,realL,eqL,opstr,opcindy,
      tmp,tmp1,tmp2,tmp3,tmp4,color,color4,p1,p2);
  if(substring(nm,0,1)=="-",  //201110from
    name=substrin(nm,1,length(nm));
  ,
    name="en"+nm;
  );  //201110to
  plist=plistorg;
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  eqL=tmp_5;
  realL=tmp_6;
  color=tmp_(length(tmp)-2);color4=Colorrgb2cmyk(color); //200629
  opstr=tmp_(length(tmp)-1);
  opcindy=tmp_(length(tmp));
  Eps=10^(-5); // 16.12.05
  Eps1=0.01;
  Eps2=0.1;
  Start=[];
  flg=0;
  forall(realL,
    if(isList(#) % ispoint(#),
      Start=Lcrd(#); // 18.02.02
    ,
      if(flg==1,Eps1=#);
      if(flg==2,Eps2=#);
      flg=flg+1;
    );
  );
  flg=0;
  AnsL=[];
  if(length(plist)==1,
    Fdata=parse(plist_1);
    tmp1=Fdata_1;
    tmp2=Fdata_(length(Fdata));
    if(|tmp1-tmp2|<Eps,
      AnsL=Fdata;
    ,
      AnsL=append(Fdata,tmp1);
    );
    flg=1;
  );
  if(flg==0,
    Fdata=plist_1;
    Gdata=plist_(length(plist));
    KL=Intersectcurvespp(Fdata,Gdata);
   if(length(KL)==0,
      tmp=parse(Gdata);
      tmp1=LLcrd(Op(length(tmp),tmp)); //18.02.02from
      tmp=parse(Fdata);
      tmp2=LLcrd(Op(1,tmp));
      tmp=Listplot(name,[tmp1,tmp2],["nodisp"]);
      plist=append(plist,"sg"+name);
      Start=tmp2;
      tst=1; //18.02.02to
      p1=Start;
    ,
      if(length(KL)==1,
        tst=KL_1_2;
        Start=Pointoncurve(tst,Fdata);
      );
      if(length(KL)>1,
        KL=sort(KL,[#_2]);
        if(Start==[],
          tst=KL_1_2;
          Start=Pointoncurve(tst,Fdata);
        ,
          tmp=apply(KL,|#_1-Start|);
          tmp=min(tmp);
          tmp1=select(KL,|#_1-Start|<tmp+Eps1);//180718
          tst=tmp1_1_2;
          Start=Pointoncurve(tst,Fdata);
        );
      );
    );
  );
  if(flg==0,
    t1=tst;
    p1=Pointoncurve(t1,Fdata); //180713
    println("Start point of enclosing is "+text(Start));
    forall(1..(length(plist)),nn,
      Fdata=plist_nn;
      if(nn==length(plist),nxtno=1,nxtno=nn+1);
      Gdata=plist_nxtno;
      tmp1=parse(Fdata); //200803from
      tmp2=parse(Gdata);
      if(|tmp2_1-tmp1_(-1)|<Eps,
        if(nn<length(plist), //211217from
          AnsL=concat(AnsL,tmp1);
        ,
          tmp3=Partcrv("",AnsL_(-1),tmp2_1,tmp1,["nodata"]);
          AnsL=concat(AnsL,tmp3);
        );  //211217fto
      ,  //200803to
        KL=Intersectcurvespp(Fdata,Gdata);
        if(length(KL)==0, 
          tmp2=Prepend(Op(length(tmp1),tmp),tmp2);
          Gdata=replace(Gdata,"(","");
          Gdata=replace(Gdata,")","");
          tmp=Gdata+"="+Textformat(tmp2,10)+";"; //190415
          parse(tmp);
          plist_nxtno=Gdata;
          t2=Length(tmp1);
          p2=Pointoncurve(t2,Fdata); //180713
          ss=1; //18.02.02to
        ,
          KL=sort(KL,[#_2]);//180706
          tmp=parse(Fdata);
          tmp1=t1+Eps;
          tmp=select(KL,(#_2>tmp1)%((#_2>t1)&(|#_1-p1|>Eps1))); //210411from
          if(length(tmp)>0,
            KL=tmp;
          ,
            KL=KL;  //211002,1014
          ); //210411to
          t2=KL_1_2;
          ss=KL_1_3;
          if(abs(t2-t1)<Eps,//180707
            if(length(KL)>1,
              t2=KL_2_2;
              ss=KL_2_3;
            ,
              println(text(nn)+" and "+text(nxtno)+" not intersect");
              flg=1;
            );
          );
        );
        if(flg==0,
          tmp=Partcrv("",t1,t2,Fdata,["nodata"]);
          if(nn==1,
            AnsL=tmp;
          ,
            AnsL=concat(AnsL,tmp_(2..(length(tmp))));
          );
        );
        t1=ss;//180706
        p1=Pointoncurve(t1,Gdata); //180713
      );
    );
    if(flg==0,
      AnsL=apply(1..(length(AnsL)),Pcrd(AnsL_#));
    );
  );
  AnsL=Unscaling(AnsL); //201110
  if(Noflg<3,
    println("generate Enclosing "+name);
    tmp=name+"="+Textformat(AnsL,10)+";"; //190415
    parse(tmp);
    tmp=parse(name); //210530[2lines]
    tmp=apply(tmp,LLcrd(#));
    Listplot("-"+name,tmp,["nodisp"]); //210421
  );
  if(Noflg<3, //190818
    if(isstring(Ltype),
      Ltype=Getlinestyle(text(Noflg)+Ltype,name);
    ,
      if(Noflg==1,Ltype=0);
    );
    GCLIST=append(GCLIST,[name,Ltype,opcindy]);
  );
  AnsL; //201110
);
Intersectcurvespp(crv1org,crv2org):=Intersectcurvespp(crv1org,crv2org,[]);
Intersectcurvespp(crv1org,crv2org,options):=(
  regional(Eps,Eps1,Eps2,Dist,crv1,crv2,ii,jj,seg1,seg2,self,loopL,out,
          flg,tmp,tmp1,tmp2);
  Eps=10^(-4);
  Eps1=0.01;
  Eps2=0.1;
  Dist=10*Eps2;
  if(length(options)>0,
    Eps1=options_1;
    if(length(options)>1,
      Eps2=options_2;
      Dist=10*Eps2;
      if(length(options)>2,
        Dist=options_3;
      );
    );
  );
  if(isstring(crv1org),tmp1=parse(crv1org),tmp1=crv1org);//18.01.05from
  if(isstring(crv2org),tmp2=parse(crv2org),tmp2=crv2org);
  tmp1=apply(tmp1,LLcrd(#));
  tmp2=apply(tmp2,LLcrd(#));
  crv1=[tmp1_1];
  forall(tmp1,
    tmp=crv1_(length(crv1));
    if(|tmp-#|>Eps,
      crv1=append(crv1,#);
    );
  );
  crv2=[tmp2_1];
  forall(tmp2,
    tmp=crv2_(length(crv2));
    if(|tmp-#|>Eps,
      crv2=append(crv2,#);
    );
  );//18.01.05until
  if(crv1==crv2,
    self=1;
  ,
    self=0;
  );
  out=[];
  forall(1..(length(crv1)-1),ii,
    if(self==0,
      loopL=1..(length(crv2)-1);
    ,
      loopL=(ii+2)..(length(crv2)-1);
    );
    forall(loopL,jj,
      tmp=Intersectpartseg(crv1,crv2,ii,jj,Eps1,Eps2,Dist);
      if(length(tmp)>0,
        if(length(out)==0,
          out=[tmp];
        ,
          tmp1=out_(length(out));
          if(|tmp1_1-tmp_1|>Eps1,
            out=append(out,tmp);
          );
        );
        if(self==1,
          tmp=[tmp_1,tmp_3,tmp_2,tmp_4,tmp_5];
          out=append(out,tmp);
        );
      );
    );
  );
  tmp2=out;
  out=[];
  tmp1=tmp2;
  flg=0;
  forall(1..(length(tmp2)),
    if(flg==0,
      tmp=Collectsameseg(tmp1);
      out=append(out,tmp_1);
      if(length(tmp_2)==0,
        flg=1;
      ,
        tmp1=tmp_2;
      );
    );
  );
  forall(1..(length(out)),ii,
    tmp1=out_ii;
    if(length(tmp1)==1,
      out_ii=tmp1_1;
    ,
      tmp=apply(tmp1,#_4);
      dst=min(tmp);
      tmp1=select(tmp1,#_4<dst+Eps);
      tmp=apply(tmp1,#_1);
      tmp=sum(tmp)/length(tmp);
      tmp2=[tmp];
      tmp=Nearestpt(tmp2_1,crv1org);
      tmp2=append(tmp2,tmp_2);
      tmp=Nearestpt(tmp2_1,crv2org);
      tmp2=append(tmp2,tmp_2);
      tmp2=concat(tmp2,[dst,tmp1_1_5]);
      out_ii=tmp2;
    );
  );
  if(length(out)>0,  //190221from
    out=sort(out,[#_2]);
  );  //190221to
  out;
);
LLcrd(pt):=(
  regional(tmp);
  if(ispoint(pt),
    tmp=pt.xy
  ,
    tmp=pt;
  );
  tmp=[tmp_1/SCALEX,tmp_2/SCALEY];
  re(tmp); //191231
);
Intersectpartseg(crv1,crv2,ii,jj,Eps1,Eps2):=(
  Intersectpartseg(crv1,crv2,ii,jj,Eps1,Eps2,10*Eps2);
);
Intersectpartseg(crv1org,crv2org,ii,jj,Eps1,Eps2,Dist):=(
  regional(crv1,crv2,Eps,dst,kk,ll,seg1,seg2,snang,
     p0,p1,p2,p3,os1,os2,out,tmp,tmp1,tmp2,flg);
  crv1=crv1org; crv2=crv2org;
  if(isstring(crv1),crv1=parse(crv1));
  if(isstring(crv2),crv2=parse(crv2));
  Eps=10^(-4);
  out=[];
  seg1=[crv1_ii,crv1_(ii+1)];
  seg2=[crv2_jj,crv2_(jj+1)];
  tmp1=seg1_2-seg1_1;
  tmp2=seg2_2-seg2_1;
  snang=abs(Crossprod(tmp1,tmp2))/(Norm(tmp1)*Norm(tmp2));
  tmp=Intersectseg(seg1,seg2,Eps1);
  dst=tmp_1;
  if(dst<Eps,
    out=[tmp_2,ii+tmp_3,jj+tmp_4,dst,snang];
  ,
    if(dst<Eps2,
      if((length(crv1)==2)%(|seg1_2-seg1_1|>Dist-Eps),
        os1=seg1;
      ,
        p1=seg1_1; p2=seg1_2;
        if(ii==1,
          p3=crv1_3;
          tmp=p2-p1;
          tmp=(p1+p2)/2+[tmp_2,-tmp_1];
          p0=Reflectpoint(p3,[(p1+p2)/2,tmp]);
        ,
          if(ii==length(crv1)-1,
            p0=crv1_(ii-1);
            tmp=p2-p1;
            tmp=(p1+p2)/2+[tmp_2,-tmp_1];
            p3=Reflectpoint(p0,[(p1+p2)/2,tmp]);
          ,
            p0=crv1_(ii-1); p3=crv1_(ii+2);
          );
        );
        os1=Osplineseg([p0,p1,p2,p3]);
      );
      if((length(crv2)==2)%(|seg2_2-seg2_1|>Dist-Eps), //18.01.05
        os2=seg2;
      ,
        p1=seg2_1; p2=seg2_2;
        if(jj==1,
          p3=crv2_3;
          tmp=p2-p1;
          tmp=(p1+p2)/2+[tmp_2,-tmp_1];
          p0=Reflectpoint(p3,[(p1+p2)/2,tmp]);
        ,
          if(jj==length(crv2)-1,
            p0=crv2_(jj-1);
            tmp=p2-p1;
            tmp=(p1+p2)/2+[tmp_2,-tmp_1];
            p3=Reflectpoint(p0,[(p1+p2)/2,tmp]);
          ,
            p0=crv2_(jj-1); p3=crv2_(jj+2);
          );
        );
        os2=Osplineseg([p0,p1,p2,p3]);
      );
      tmp2=[];
      forall(1..(length(os1)-1),kk,
        forall(1..(length(os2)-1),ll,
          seg1=[os1_kk,os1_(kk+1)];
          seg2=[os2_ll,os2_(ll+1)];
          tmp=Intersectseg(seg1,seg2,Eps1);
          if((tmp_1<Eps1)&(length(tmp)>1), //18.02.06
            if(tmp_1<dst+Eps,
              dst=tmp_1;
              tmp2=select(tmp2,#_1<dst);
              tmp2=append(tmp2,[dst,tmp_2]);
            );
          );
        );
      );
      if(length(tmp2)>0,
        tmp=apply(tmp2,#_2_1);
        tmp1=[sum(tmp)/length(tmp2)];
        tmp=apply(tmp2,#_2_2);
        tmp1=append(tmp1,sum(tmp)/length(tmp2));
        out=[tmp1];
        p1=crv1_ii; p2=crv1_(ii+1);
        tmp=[Op(2,p2-p1),-Op(1,p2-p1)];
        tmp=Intersectline(out_1,tmp,p1,p2-p1);
        tmp=min([max([tmp_3,0]),1]);
        out=[tmp1,ii+tmp];
        p1=crv2_jj; p2=crv2_(jj+1);
        tmp=[Op(2,p2-p1),-Op(1,p2-p1)];
        tmp=Intersectline(out_1,tmp,p1,p2-p1);
        tmp=min([max([tmp_3,0]),1]);
        out=concat(out,[jj+tmp,dst,snang]);
      );
    );
  );
  out;
);
Crossprod(a,b):=(
  regional(tmp1,tmp2,tmp3,Out);
  if(length(a)==3,
    tmp1=a_2*b_3-a_3*b_2;
    tmp2=a_3*b_1-a_1*b_3;
    tmp3=a_1*b_2-a_2*b_1;
    Out=[tmp1,tmp2,tmp3];
  ,
    Out=a_1*b_2-a_2*b_1;
  );
  Out;
);
Norm(v1):=(  // 16.09.01
  regional(out,tmp,tmp1,tmp2);
  out=0;
  forall(1..(length(v1)),
    out=out+(v1_#)^2;
  );
  out=sqrt(out);
  out;
);
Norm(v1,v2):=(
  Norm(v2-v1);
);
Reflectpoint(point,symL):=(
  regional(X1,X2,Y1,Y2,Us,Vs,Pt1,Pt2,Cx,Cy,flg,tmp);
  tmp=Lcrd(point);
  X1=tmp_1; Y1=tmp_2;
  if(!islist(symL), //210104from
    Pt1=Lcrd(symL);
    Pt2=Pt1;
  ,
    if(length(symL)==1,
      Pt1=Lcrd(symL_1);
      Pt2=Pt1;
    ,
      if(isreal(symL_1),
        Pt1=Lcrd(symL);
        Pt2=Pt1;
      ,
        Pt1=Lcrd(symL_1);
        Pt2=Lcrd(symL_2);
      );
    );
  ); //210104to
  Us=Pt2_1-Pt1_1;
  Vs=Pt2_2-Pt1_2;
  if(Pt1==Pt2,
    X2=2*Pt1_1-X1;
    Y2=2*Pt1_2-Y1;
  ,
    X2=(Us^2-Vs^2)/(Us^2+Vs^2)*X1+2*Us*Vs/(Us^2+Vs^2)*Y1
              -2*Vs*(Us*Pt1_2-Vs*Pt1_1)/(Us^2+Vs^2);
    Y2=2*Us*Vs/(Us^2+Vs^2)*X1-(Us^2-Vs^2)/(Us^2+Vs^2)*Y1
              +2*Us*(Us*Pt1_2-Vs*Pt1_1)/(Us^2+Vs^2);
  );
  [X2,Y2];
);
Osplineseg(list):=Osplineseg(list,[]);
Osplineseg(ptlist,optionsorg):=(
  regional(tmp,tmp1,tmp2,list,ptL,ctrL,Eps,Eps0,
      p0,p1,p2,p3,pQ,pR,cc,p01,p02,p11,p12,p21,p22,p31,p32,out);
  Eps=10^(-2);
  Eps0=10^(-6);
  if(isstring(ptlist),list=parse(ptlist),list=ptlist);
  p0=list_1; p1=list_2; p2=list_3; p3=list_4;
  tmp=1+sqrt((1+Dotprod(p2-p0,p3-p1)/|p2-p0|/|p3-p1|)/2);
  cc=4*|p2-p1|/3/(|p2-p0|+|p3-p1|)/tmp;
  pQ=p1+cc*(p2-p0); // 15.09.21  // 16.08.16
  pR=p2+cc*(p1-p3);  // 16.08.16
  ctrL=[pQ,pR];
  options=optionorg;
  options=concat(options,["Num=20","nodata"]);
  out=Bezier("",[p1,p2],ctrL,options);
  out;
);
Dotprod(vec1,vec2):=(
  regional(v1,v2,tmp);
  if(ispoint(vec1),v1=vec1.xy,v1=vec1);
  if(ispoint(vec2),v2=vec2.xy,v2=vec2);
  v1*v2;
);
Bezier(ptctrlist):=Beziercurve(ptctrlist_3,ptctrlist_1,ptctrlist_2,[]);
Bezier(Arg1,Arg2):=( //190202from
  regional(nm,ptctrlist,options);
  if(islist(Arg1),
    ptctrlist=Arg1; options=Arg2;
    Beziercurve(ptctrlist_3,ptctrlist_1,ptctrlist_2,options);
  ,
    nm=Arg1; ptctrlist=Arg2;
    Beziercurve(nm,ptctrlist_1,ptctrlist_2,[]);
  );
); //190202to
Bezier(nm,ptlist,ctrlist):=Beziercurve(nm,ptlist,ctrlist,[]);
Bezier(nm,ptlist,ctrlist,options):=Beziercurve(nm,ptlist,ctrlist,options);
Beziercurve(nm,ptlist,ctrlist):=Beziercurve(nm,ptlist,ctrlist,[]);
Beziercurve(nm,ptlistorg,ctrlistorg,options):=(
  regional(name,Ltype,Noflg,opstr,opcindy,Num,msgflg,
    ptlist,ctrlist,tmp,tmp1,tmp2,ii,st,out,list,color,color4);
  name="bz"+nm;
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  color=tmp_(length(tmp)-2); color4=Colorrgb2cmyk(color); //200618
  opstr=tmp_(length(tmp)-1);
  opcindy=tmp_(length(tmp));
  Num=10;
  msgflg="Y";
  tmp1=tmp_5;
  forall(tmp1,     // 14.12.31
    if(substring(#,0,1)=="N",
      tmp2=indexof(#,"=");
      Num=parse(substring(#,tmp2,length(#)));
      opstr=opstr+","+Dq+#+Dq;
    );
    if(substring(#,0,1)=="M",
      tmp2=indexof(#,"=");
      msgflg=Toupper(substring(#,tmp2,tmp2+1));
    );  );
  ptlist=apply(ptlistorg,Lcrd(#)); // 16.08.16
  ctrlist=[];  // 14.12.31
  if(length(ctrlistorg)==length(ptlist)-1,
    forall(1..(length(ctrlistorg)),ii, //190202
      tmp1=apply(ctrlistorg_ii,Lcrd(#));  //190202
      if(Measuredepth(tmp1)==0,tmp=[tmp1],tmp=tmp1);
      ctrlist=append(ctrlist,tmp);
    );
  ,
    forall(1..(length(ptlist)-1),ii,
      tmp=ctrlistorg_((2*ii-1)..(2*ii));
      tmp=apply(tmp,Lcrd(#)); // 16.08.16
      ctrlist=append(ctrlist,tmp);
    );
  );
  if(!islist(Num),
    Num=apply(ctrlist,Num);
  );
  list=[];
  forall(1..(length(ptlist)-1),ii,
    tmp1=ptlist_(ii..(ii+1));
    tmp2=ctrlist_ii;
    if(ii==1,st=0,st=1);
    forall(st..Num_ii,
      tmp=Bezierpt(#/Num_ii,tmp1,tmp2);
      list=append(list,tmp);
    );
  );
  if(Noflg<3,
    if(msgflg=="Y",println("generate Bezier "+name));
    out=apply(list,Pcrd(#));
    tmp=name+"="+Textformat(out,10)+";"; //190415
    parse(tmp);
  );
  if(Noflg<3, //190818
    if(isstring(Ltype),
      Ltype=Getlinestyle(text(Noflg)+Ltype,name);
    ,
      if(Noflg==1,Ltype=0);
    );
    GCLIST=append(GCLIST,[name,Ltype,opcindy]);
  );
  BezierCtrL=ctrlist; //181001
  list;
);
Measuredepth(list):=( //190423
  regional(str,nn,tmp,tmp1,tmp2);
  str=text(list);
  tmp1=Indexall(str,"[");
  tmp2=select(tmp1,!contains(tmp1,#+1));
  nn=tmp2_1;
  tmp1=substring(str,nn,length(str));
  tmp=indexof(tmp1,",");
  tmp1=substring(tmp1,0,tmp-1);
  if(!ispoint(parse(tmp1)),
    nn=nn-1;
  );
  nn;
);
Bezierpt(t,ptlist,ctrlist):=(
  regional(flg3,p0,p1,p2,p3,p4,p5,p6,p7,p8,p9);
  p0=ptlist_1;
  p3=ptlist_2;
  p1=ctrlist_1;
  if(length(ctrlist)==1,
    p2=p3;
    flg3=0;
  ,
    p2=ctrlist_2;
    flg3=1;
  );
  if(length(p0)<3,  // 15.02.08
    p0=Lcrd(p0);
    p3=Lcrd(p3);
    p1=Lcrd(p1);
    p2=Lcrd(p2);
  );
  p4=(1-t)*p0+t*p1;
  p5=(1-t)*p1+t*p2;
  p6=(1-t)*p2+t*p3;
  p7=(1-t)*p4+t*p5;
  p8=(1-t)*p5+t*p6;
  p9=(1-t)*p7+t*p8;
  if(flg3==0,p7,p9);
);
Intersectseg(seg1,seg2):=Intersectseg(seg1,seg2,0.01);
Intersectseg(seg1org,seg2org,Eps1):=(
  regional(Eps,seg1,seg2,p1,p2,q1,q2,t,s,pt,n,pts,out,dist,
    tmp,tmp1,tmp2,tmp3);
  Eps=10^(-4);
  seg1=seg1org;
  seg2=seg2org;
  if(isstring(seg1),seg1=parse(seg1));
  if(isstring(seg2),seg2=parse(seg2));
  out=[];
  p1=seg1_1; q1=seg1_2;
  p2=seg2_1; q2=seg2_2;
   if((|q1-p1|<Eps)%(|q2-p2|<Eps),
    out=[-1];
  ,
    tmp=Intersectline(p1,q1-p1,p2,q2-p2);
    if((islist(tmp))&(length(tmp)==3),
      pt=tmp_1; t=tmp_2; s=tmp_3;
      if((t*(t-1)<Eps)&(s*(s-1)<Eps),
        out=[0,pt,t,s];
      ,
        t=min([max([t,0]),1]);
        s=min([max([s,0]),1]);
        tmp3=[|p1-p2|,|p1-q2|,|q1-p2|,|q1-q2|]; //18.01.30from
        tmp1=[Op(2,q2-p2),-Op(1,q2-p2)];
        tmp=Intersectline(p1,tmp1,p2,q2-p2);
        if(islist(tmp_1),
          if(tmp_3*(tmp_3-1)<Eps,
            tmp3=append(tmp3,|tmp_1-p1|);
          );
        );
        tmp=Intersectline(q1,tmp1,p2,q2-p2);
        if(islist(tmp_1),
          if(tmp_3*(tmp_3-1)<Eps,
            tmp3=append(tmp3,|tmp_1-q1|);
          );
        );
        tmp1=[Op(2,q1-p1),-Op(1,q1-p1)];
        tmp=Intersectline(p2,tmp1,p1,q1-p1);
        if(islist(tmp_1),
          if(tmp_3*(tmp_3-1)<Eps,
            tmp3=append(tmp3,|tmp_1-p2|);
          );
        );
        tmp=Intersectline(q2,tmp1,p1,q1-p1);
        if(islist(tmp_1),
          if(tmp_3*(tmp_3-1)<Eps,
            tmp3=append(tmp3,|tmp_1-q2|);
          );
        );
        out=[min(tmp3),pt,t,s]; //18.01.30until
      );
    ,
      dist=tmp_1;
      tmp1=q1-p1;      
      n=[tmp1_2,-tmp1_1]/|tmp1|;
      pts=[];
      tmp=Intersectline(p1,n,p2,q2-p2);
      if(tmp_3*(tmp_3-1)<Eps,
        tmp1=(1-tmp_3)*p2+tmp_3*q2;
        pts=append(pts,[tmp1,0,tmp_3]);
      );
      tmp=Intersectline(q1,n,p2,q2-p2);
      if(tmp_3*(tmp_3-1)<Eps,
        tmp1=(1-tmp_3)*p2+tmp_3*q2;
        pts=append(pts,[tmp1,1,tmp_3]);
      );
      tmp=Intersectline(p2,n,p1,q1-p1);
      if(tmp_3*(tmp_3-1)<Eps,
        tmp1=(1-tmp_3)*p1+tmp_3*q1;
        pts=append(pts,[tmp1,tmp_3,0]);
      );
      tmp=Intersectline(q2,n,p1,q1-p1);
      if(tmp_3*(tmp_3-1)<Eps,
        tmp1=(1-tmp_3)*p1+tmp_3*q1;
        pts=append(pts,[tmp1,tmp_3,2]);
      );
      if(length(pts)==0,
        tmp1=min([|p2-p1|,|q2-p1|,|p2-q1|,|q2-q1|]);
        out=[tmp1];
      ,
        if(dist>Eps1,
          out=[dist];
        ,
          tmp=apply(pts,#_1_1);
          tmp1=sum(tmp)/(length(pts));
          tmp=apply(pts,#_1_2);
          tmp2=sum(tmp)/(length(pts));
          tmp3=[tmp1,tmp2];
          tmp1=seg1_2-seg1_1;
          tmp=Dotprod(tmp3-seg1_1,tmp1)/Norm(tmp1)^2;
          if((tmp>0)%(tmp<1),
            tmp=[seg1_1+tmp*tmp1,1+tmp];
          ,
            if(tmp<0,tmp=[seg1_1,1],tmp2=[seg1_2,2]);
          );
          tmp1=tmp_2;
          tmp2=seg2_2-seg2_1;
          tmp=Dotprod(tmp3-seg2_1,tmp2)/Norm(tmp2)^2;
          if((tmp>0)%(tmp<1),
            tmp=[seg2_1+tmp*tmp2,1+tmp];
          ,
            if(tmp<0,tmp=[seg2_1,1],tmp=[seg2_2,2]);
          );
          tmp2=tmp_2;
          out=[dist,tmp3,tmp1,tmp2];
        );
      );
    );
  );
  out;
);
Intersectline(p1,v1,p2,v2):=(
  regional(Eps,d,dt,ds,t,s,pt,out,tmp,tmp1,tmp2,tmp3);
  Eps=10^(-5);
  out=[];
  tmp=Dotprod(v1,v2);
  tmp1=[tmp,|v1|^2];
  tmp2=[-|v2|^2,-tmp];
  tmp3=[Dotprod(p2-p1,v2),Dotprod(p2-p1,v1)];
  d=Crossprod(tmp1,tmp2);
  tmp=abs(Crossprod(v1,v2));
  if(tmp>Eps,
    dt=Crossprod(tmp3,tmp2);
    ds=Crossprod(tmp1,tmp3);
    t=dt/d;
    s=ds/d;
    pt=p1+v1*t;
    out=[pt,t,s];
  ,
    tmp1=Crossprod(p2-p1,v1)/|v1|; //18.01.05
    out=[abs(tmp1)]; //18.01.05
  );
  out;
);
Collectsameseg(ptdL):=(
  regional(Eps,gL,rL,numL,ii,jj,flg,tmp,tmp1,tmp2,tmp1md,
       dst,kk,s1,e1,s2,e2);
  Eps00=10^(-8);
  if(length(ptdL)==0,
    gL=[];rL=[];
  ,
    tmp1md=[ptdL_1];
    rL=ptdL_(2..(length(ptdL)));
    tmp1=tmp1md_1;
    kk=floor(tmp1_2);
    if(tmp1_2<kk+Eps00,
      s1=kk-1-Eps00; e1=s1+2+2*Eps00;
    ,
      s1=kk-Eps00; e1=s1+1+2*Eps00;
    );
    kk=floor(tmp1_3);
    if(tmp1_3<kk+Eps00,
      s2=kk-1-Eps00; e2=s2+2+2*Eps00;
    ,
      s2=kk-Eps00; e2=s2+1+2*Eps00;
    );
    numL=[];
    forall(1..(length(rL)),ii,
      tmp=rL_ii;
      tmp1=tmp_2;tmp2=tmp_3;
      if((tmp1>s1)&(tmp1<e1)&(tmp2>s2)&(tmp2<e2),
        tmp1md=append(tmp1md,tmp);
        numL=append(numL,ii);
      );
    );
    gL=[];
    tmp=apply(tmp1md,#_4);
    dst=min(tmp);
    forall(tmp1md,
      if(#_4<dst+Eps00,
        gL=append(gL,#);
      );
    ); 
    rL=remove(rL,rL_(numL));
  );
  [gL,rL];
);
Nearestpt(pt,plotstr):=(
  regional(ptL,Eps,dtL,dt,nn,pt1,pt2,dv,nv,tmp,tmp1,tmp2);
  if(isstring(plotstr),ptL=parse(plotstr),ptL=plotstr);
  Eps=10^(-6);
  dtL=[];
  forall(1..(length(ptL)-1),nn,
    pt1=ptL_nn;
    pt2=ptL_(nn+1);
    if(|pt2-pt1|<Eps,
      dt=[pt1,nn,|pt1-pt|];
    ,
      dv=pt2-pt1;
      nv=[-dv_2,dv_1];
      tmp1=Intersectline(pt1,dv,pt,nv);
      if(length(tmp1)>1, //210319from
        if((tmp1_2>=0)&(tmp1_2<=1),
          dt=[tmp1_1,nn+tmp1_2,|tmp1_1-pt|];
        ,
          if(tmp1_2<0,
            dt=[pt1,nn,|pt1-pt|];
          ,
            dt=[pt2,nn+1,|pt2-pt|];
          );
        );
      ,
      ); //210319to
    );
    dtL=append(dtL,dt);
  );
  dtL=select(dtL,length(#)>=3); //220115
  dtL=sort(dtL,[#_3,#_2]);
  dtL_1;
);
Partcrv(nm,pA,pB,PkLstr):=Partcrv(nm,pA,pB,PkLstr,[]);
Partcrv(nm,pAorg,pBorg,PkLstr,options):=(
  regional(pA,pB,PkL,PkLL,Ans,Eps,Npt,Out1,Out2,tmp,tmp1,tmp2,Flg,nS,nE,
        PPL,pP,opcindy,Ta,Tb,name,Ltype,Noflg,eqL,msg,DepthFlg,color,color4);
  if(substring(nm,0,1)=="-", //201106from
    name=substring(nm,1,length(nm));
  ,
    name="part"+nm;
  ); //201106to
  pA=pAorg; pB=pBorg; //201031
  if(isstring(PkLstr),PkL=parse(PkLstr),PkL=PkLstr);
  DepthFlg=0;
  if(Measuredepth(PkL)==2,
    PkL=PkL_1;
    DepthFlg=1;
  );
  PkLL=apply(PkL,LLcrd(#)); //201031
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  eqL=tmp_5;
  color=tmp_(length(tmp)-2);color4=Colorrgb2cmyk(color); //200626
  opcindy=tmp_(length(tmp));
  msg="Y";
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1));
    tmp2=Toupper(substring(tmp_2,0,1));
    if(tmp1=="M",
      msg=tmp2;
    );
  );
  Eps=10^(-4);
  Flg=0;
  if(isreal(pA),
    if(pA>pB+Eps,
      Npt=Numptcrv(PkL);
      Out1=Partcrv("",pA,Npt,PkLstr,["nodata"]);
      Out2=Partcrv("",1,pB,PkLstr,["nodata"]);
      tmp=Ptstart(PkL)-Ptend(PkL);
      if(|tmp|<Eps,
        Ans=Joincrvs("",[Out1,Out2],["nodata"]);
      ,
        Ans=[apply(Out1,Pcrd(#)),apply(Out2,Pcrd(#))];
      );
      Flg=1;
    );
    if(Flg==0,
      nS=ceil(pA);
      nE=floor(pB);
      PPL=[];
      if(pA<nS-Eps,
        pP=(nS-pA)*PkL_(nS-1)+(1-nS+pA)*PkL_nS;
        PPL=[pP];
      );
      PPL=concat(PPL,PkL_(nS..nE));
      if(pB>nE+Eps,
        pP=(1-pB+nE)*PkL_nE+(pB-nE)*PkL_(nE+1);
        PPL=concat(PPL,[pP]);
      );
      Ans=PPL;
      Flg=1;
    );
  );
  if(Flg==0,
    pA=Pcrd(pA); //201031from
    pB=Pcrd(pB); 
    tmp=Nearestpt(LLcrd(pA),PkLL); //201031to
    Ta=tmp_2;
    tmp=Nearestpt(LLcrd(pB),PkLL); // 15.09.12
    Tb=tmp_2;
    Ans=Partcrv("",Ta,Tb,PkL,["nodata"] );
  );
  if(Noflg<3,
    tmp1=apply(Ans,Pcrd(#)); //201030
    tmp=name+"="+Textformat(Ans,5)+";"; //190415
    parse(tmp);
    if(DepthFlg==0,
      tmp=PkLstr;
    ,
      tmp=PkLstr+"(1)";
    );
    tmp1=name+"=Partcrv("+Textformat(Lcrd(pA),5)
         +","+Textformat(Lcrd(pB),5)+","+tmp+")"; // 16.04.03
  );
  if(Noflg<3, //190818
    if(isstring(Ltype),
      Ltype=Getlinestyle(text(Noflg)+Ltype,name);
    ,
      if(Noflg==1,Ltype=0);
    );
    GCLIST=append(GCLIST,[name,Ltype,opcindy]);
  );
  Ans;
);
Numptcrv(Fig):=(
  regional(tmp);
  if(isstring(Fig),tmp=parse(Fig),tmp=Fig);  // 15.12.23
  length(tmp);
);
Ptstart(Fig):=(
  regional(tmp);
  if(isstring(Fig),tmp=parse(Fig),tmp=Fig);  // 16.01.21
  tmp_1;
);
Ptend(Fig):=(
  regional(tmp);
  if(isstring(Fig),tmp=parse(Fig),tmp=Fig);
  tmp_(length(tmp)); // 15.04.12
);
Joincrvs(nm,plotstrL):=Joincrvs(nm,plotstrL,[]);
Joincrvs(nm,plotstrL,options):=(
  regional(plotlist,PtL,Eps,QdL,Flg,Ni,Qd,pP,pS,pQ,pR,rMN,
        opcindy,tmp,tmp1,tmp2,str,name,Ltype,Noflg,color,color4);
  name="join"+nm;
  plotlist=[];
  forall(plotstrL,str,
    if(isstring(str),
      tmp=parse(str);
      tmp=apply(tmp,LLcrd(#));
    ,
      tmp=str;
    );
    plotlist=append(plotlist,tmp);
  );
  Eps=10^(-4);
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  color=tmp_(length(tmp)-2);color4=Colorrgb2cmyk(color); //200629
  opcindy=tmp_(length(tmp));
  tmp1=tmp_6;
  if(length(tmp1)>0,Eps=tmp1_1);
  QdL=[];
  forall(plotlist,Qd,
    if(ispoint(Qd_1) % !islist(Qd_1_1),
      QdL=concat(QdL,[Qd]);
    ,
      forall(Qd,
        QdL=concat(QdL,[#]);
      );
    );
  );
  Flg=0;
  if(length(QdL)==0,
    PtL=[];
    Flg=1;
  );
  if(Flg==0,
    PtL=QdL_1;
    forall(2..(length(QdL)),Ni,
      Qd=QdL_Ni;
      if(Numptcrv(Qd)>1,
        pP=Ptend(PtL);
        pS=Ptstart(PtL);
        pQ=Ptstart(Qd);
        pR=Ptend(Qd);
        rMN=min([|pP-pQ|,|pP-pR|,|pS-pQ|,|pS-pR|]);
        if(rMN==|pP-pR|,
          Qd=reverse(Qd);
        ,
          if(rMN==|pS-pQ|,
            PtL=reverse(PtL);
          ,
            if(rMN==|pS-pR|,
              PtL=reverse(PtL);
              Qd=reverse(Qd);
            );
          );
        );
      );
      if(rMN>Eps,
        PtL=concat(PtL,Qd);
      ,
        PtL=concat(PtL,Qd_(2..(length(Qd))));
      );
    );
  );
  if(Noflg<3,
    println("generate joincurve "+name);
    tmp1=apply(PtL,Pcrd(#));
    tmp=name+"="+Textformat(tmp1,5)+";";
    parse(tmp);
    tmp1="";
    forall(plotstrL,
        tmp1=tmp1+#+",";
    );
    tmp1=substring(tmp1,0,length(tmp1)-1);
  );
  if(Noflg<3, //190818
    if(isstring(Ltype),
      Ltype=Getlinestyle(text(Noflg)+Ltype,name);
    ,
      if(Noflg==1,Ltype=0);
    );
    GCLIST=append(GCLIST,[name,Ltype,opcindy]);
  );
  PtL;
);
Pointoncurve(tTorg,Gdata):=(
  regional(tT,Out,Eps,nN,sS,Pa,Pb,PtL);
  if(isstring(Gdata),PtL=parse(Gdata),PtL=Gdata);
  if(length(PtL)==1,PtL=PtL_1);
  tT=max([tTorg,1]); //18.01.04
  tT=min([tT,length(PtL)]); //18.01.04
  Eps=10^(-5); //18.01.04
  nN=floor(tT+Eps);
  sS=max([tT-nN,0]);
  if(nN==length(PtL),
    Out=PtL_nN;
  ,
    Pa=PtL_nN;
    Pb=PtL_(nN+1);
    Out=(1-sS)*Pa+sS*Pb;
  );
  Out;
);
Unscaling(pdata):=(
  regional(Level,Out);
  Out=[];
  if(!islist(pdata_1),
    Out=[pdata_1/SCALEX,pdata_2/SCALEY];
  ,
    forall(pdata,
      Out=append(Out,Unscaling(#))
    );
  );
  Out;
);
Shadein(pstrorg):=( //190220
  regional(pstr,ptL,pL,crv,nn,
      tmp,tmp1,tmp2,pm1,pm2,p1,p2,flg);
  if(islist(pstrorg),pstr=pstrorg_1,pstr=pstrorg);
  crv=[];
  Framedata(["nodisp"]);
  ptL=Intersectcurvespp(pstr,frwin);
  if(length(ptL)>0,
    pL=apply(ptL,#_2);
    forall(1..(length(pL)),nn,
      if(nn<length(pL),
       tmp1=pL_nn;
       tmp2=pL_(nn+1);
       tmp=Pointoncrv((tmp1+tmp2)/2,pstr);
      ,
        tmp1=pL_nn;
        tmp2=pL_1;
        tmp=parse(pstr);
        if(pL_nn==length(tmp),
          tmp=tmp_1;
        ,
          tmp=tmp_(length(tmp));
        );
      );
      if(Inwindow(tmp),
        tmp=Partcrv("",tmp1,tmp2,pstr,["nodata"]);
      ,
        tmp1=Pointoncrv(tmp1,pstr);
        tmp2=Pointoncrv(tmp2,pstr);
        pm1=Paramoncrv(tmp1,frwin);
        pm2=Paramoncrv(tmp2,frwin);
        if(floor(pm1)==floor(pm2),
          tmp=Listplot("",[tmp1,tmp2],["nodata"]);
        ,
          tmp=floor(pm1);
          p1=Pointoncrv(tmp,"frwin");
          p2=Pointoncrv(mod(tmp,4)+1,"frwin");
          tmp=p1-10*(p2-p1);
          Listplot("frwin",[p1,tmp],["nodisp","Msg=n"]);
          tmp=Intersectcurvespp("sgfrwin",pstr);
          if(mod(length(tmp),2)==0, //190223from
            if(pm2<pm1,pm2=pm2+4); 
            tmp=[tmp1];
            pm1=floor(pm1)+1;
            flg=0;
            forall(1..3,
              if(flg==0,
                if(pm1<pm2,
                  p1=Pointoncrv(mod(pm1-1,4)+1,"frwin");
                  tmp=append(tmp,p1);
                  pm1=pm1+1;
                ,
                  flg=1;
                );
              );
            );
            if(pm1-1<pm2,tmp=append(tmp,tmp2));
          ,
            if(pm2>pm1,pm2=pm2-4);
            tmp=[tmp1];
            pm1=floor(pm1);
            flg=0;
            forall(1..3,
              if(flg==0,
                if(pm1>pm2,
                  p1=Pointoncrv(mod(pm1-1,4)+1,"frwin");
                  tmp=append(tmp,p1);
                  pm1=pm1-1;
                ,
                  flg=1;
                );
              );
            );
            if(pm1+1>pm2,tmp=append(tmp,tmp2));
          ); //190223to
        );
      );
      if(length(crv)==0,
        crv=tmp;
      ,
        crv=Joincrvs("",[crv,tmp],["nodata"]);
      );
    );
  ,
    if(Inwindow(parse(pstr+"_1")),crv=pstr,crv=frwin);
  );
  crv;
);
Framedata():=Framedata(["dr"]);//16.10.29from
Framedata(list):=(
  regional(pA,pB);
  if(Measuredepth(list)==0,
    pA=LLcrd((SW+NE)/2); // 15.09.17
    pB=LLcrd(NE);
    Framedata("win",[pA,pB],list);
  ,
    Framedata(list,[]);
  );
);//16.10.29until
Framedata(Arg1,Arg2):=(
  regional(name,list,options,str);
  if(isstring(Arg1),
    name=Arg1;
    list=Arg2;
    Framedata(name,list,[]);
  ,
    list=Arg1;
    options=Arg2;
    name="";// 16.10.07from
    forall(list, 
       name=name+#.name;
    );// 16.10.07until
    Framedata(name,list,options);
  );
);
Framedata(nm,list,optionsorg):=( //190424modified
  regional(name,options,Out,tmp,tmp1,x1,x2,y1,y2,dx,dy,
      Ltype,Noflg,strL,cent,dx,dy,color,strL,corner);
  name="fr"+nm;
  options=optionsorg;
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  strL=tmp_7; //191126
  color=tmp_(length(tmp)-2);
  corner=0; //191126from
  forall(strL,
    tmp=substring(Toupper(#),0,1);
    if(tmp=="C",
      tmp=Lcrd(list_1); tmp1=Lcrd(list_2); //191227
      cent=(tmp+tmp1)/2;
      dx=abs(tmp1_1-tmp_1)/2;
      dy=abs(tmp1_2-tmp_2)/2;
      corner=1;
      options=remove(options,[#]);
    );
  );
  if(corner==0,
    if(length(list)==2,  // 15.05.12
      cent=Lcrd(list_1); tmp=Lcrd(list_2);
      dx=abs(tmp_1-cent_1); dy=abs(tmp_2-cent_2);
    ,
      cent=Lcrd(list_1);
      dx=list_2; dy=list_3;
    );
  );  //191126to
  x1=cent_1-dx; x2=cent_1+dx;
  y1=cent_2-dy; y2=cent_2+dy;
  Listplot("-"+name,[[x1,y1],[x2,y1],[x2,y2],[x1,y2],[x1,y1]],options);
);
Framedata(nm,cent,dx,dy):=Framedata(nm,[cent,dx,dy],[]);
Framedata(nm,cent,dx,dy,options):=Framedata(nm,[cent,dx,dy],options);
Paramoncrv(pP,Gdata):=Paramoncurve(pP,Gdata);//180723
Paramoncurve(point,Gdata):=(
  regional(Tmp,PtL,pP);
  if(ispoint(point),pP=point.xy,pP=point);
  if(isstring(Gdata),PtL=parse(Gdata),PtL=Gdata);
  Tmp=Nearestpt(pP,PtL);
  Tmp_2;
);
Paramoncurve(pP,nN,plist):=(
  regional(PtL,Out,Pa,Pb,vV,vW,sS);
  if(isstring(plist),PtL=parse(plist),PtL=plist);
  PtL=apply(PtL,LLcrd(#));//16.10.16
  if(nN==length(PtL),
    Out=nN;
  ,
    Pa=PtL_nN;
    Pb=PtL_(nN+1);
    vV=Pb-Pa;
    vW=pP-Pa;
    sS=vV*vW/|vV|^2;
    sS=min([max([sS,0]),1]);
    Out=nN+sS;
  );
  Out;
);
Pointoncrv(tT,PtL):=Pointoncurve(tT,PtL);
Inwindow(point):=Inwindow(point,[XMIN,XMAX],[YMIN,YMAX]);
Inwindow(point,xrng,yrng):=(
  regional(Eps,pt,x,y,xmin,xmax,ymin,ymax,tmp);
  Eps=10.0^(-6);
  if(ispoint(point),pt=point.xy,pt=point);
  x=pt_1; y=pt_2;
  xmin=xrng_1; xmax=xrng_2;
  ymin=yrng_1; ymax=yrng_2;
  tmp=(x>xmin-Eps)&(x<xmax+Eps)&(y>ymin-Eps)&(y<ymax+Eps);
  if(tmp,true,false);
);
Dqq(str):=DqDq(str); //18.02.11
DqDq(str):=(
  unicode("0022")+str+unicode("0022");
);
Seteditable(no):=Seteditable(no,[]); //200524
Seteditable(no,optionorg):=(
);
Totexform(str):=( //210803from[renew]
  regional(plv,funL,repL,parL,out,head,flg,rep,fun,pre,post,ctr,clv,nn,
      tmp,tmp1,tmp2,tmp3,tmp4);
  tmp1="\displaystyle\int"; //210831from
  tmp2="\displaystyle\lim";
  tmp3="\displaystyle\sum"; //210831to
  repL=[ //190515from
    ["^(",["^{xx}"]], //210805
    ["_(",["_{xx}"]], //210831
    ["tx(",["\text{xx}"]], //210907
    ["tfr(",["","\frac{xx}{yy}"]], //210831,220523
    ["fr(",["","\dfrac{xx}{yy}"]], //210228from
    ["log(",["\log xx ","\log_{xx} yy"]], //210405
    ["ln(",["\ln xx "]], //210903
    ["sq(",["\sqrt{xx}","\sqrt[xx]{yy}"]],
    ["po(",["","{xx}^{yy}"]],
    ["sin(",["\sin xx ","\sin^{xx}\! yy "]], //200823[3lines]  //210405
    ["cos(",["\cos xx ","\cos^{xx}\! yy "]], //210405
    ["tan(",["\tan xx ","\tan^{xx}\! yy "]],  //210228to  //210405
    ["lim(", ["",tmp2+"_{xx \to yy} ",tmp2+"_{xx \to yy} zz"]], //210831from
    ["int(", [tmp1+" ",tmp1+" xx dyy ",tmp1+" yy dzz ",tmp1+"_{xx}^{yy} zz dww "]],  //211027
    ["sum(", ["",tmp3+"_{xx}^{yy} ", tmp3+"_{xx}^{yy} zz"]], //210831to
    ["diff(", ["d ","\frac{dxx}{dyy}"]], //210913
    ["par(", ["\partial ","\frac{\partial xx}{\partial yy}"]] ,//210913
    ["br(", ["","","\Bigl[xx\Bigr]_{yy}^{zz}"]] //210923,1019
  ];
  parL=["log(","sin(","cos(","tan(","lim(","int(","sum("]; //210901
  out=replace(str,"pi","{\pi}"); //210805
  head="";
  flg=0;
  plv=Bracket(out,"()");
  if(length(plv)>0,
    if(plv_1_2==0,
      head=substring(out,0,plv_1_1);
      out=substring(out,plv_1_1,length(out));
      if(substring(out,0,1)=="*",out=substring(out,1,length(out)));
      plv=Bracket(out,"()");
    );
    if(length(plv)>0, //210806
      tmp=plv_(-1);
      if(tmp_2!=-1,
        out=str;
        flg=1;
      );
    );  //210806
  );
  if(flg==0,
    forall(repL,rep,
      fun=rep_1;
      ctr=1;
      tmp=indexof(out,fun);
      while((tmp>0)&(ctr<40),
        pre=substring(out,0,tmp-1);
        out=substring(out,tmp-1,length(out));
        plv=Bracket(out,"()");
        tmp=select(plv,#_2==-1);
        tmp=tmp_1;
        post=substring(out,tmp_1,length(out));
        out=substring(out,0,tmp_1);
        clv=Getlevel(out);
        clv=select(clv,#_2==1);
        nn=length(clv)+1;
        if(nn==1,
          tmp1=substring(out,plv_1_1,length(out)-1);
          if(contains(parL,fun), //210901from
            tmp1=Addpar(tmp1); //211029
          ); //210901to
          out=replace(rep_2_1,"xx",tmp1);
        );
       if(nn==2,
          tmp1=substring(out,plv_1_1,clv_1_1-1);
          tmp2=substring(out,clv_1_1,length(out)-1);
          if(contains(parL,fun), //210901from
            tmp2=Addpar(tmp2); //211029
          ); //210901to
          tmp=replace(rep_2_2,"xx",tmp1);
          out=replace(tmp,"yy",tmp2);
        );
        if(nn==3, //210831from
          tmp1=substring(out,plv_1_1,clv_1_1-1);
          tmp2=substring(out,clv_1_1,clv_2_1-1);
          tmp3=substring(out,clv_2_1,length(out)-1);
          if(contains(parL,fun), //210901from
            tmp3=Addpar(tmp3); //211029
          ); //210901to
          tmp=replace(rep_2_3,"xx",tmp1);
          tmp=replace(tmp,"yy",tmp2);
          out=replace(tmp,"zz",tmp3);
          println(out);
        );
        if(nn==4,
          tmp1=substring(out,plv_1_1,clv_1_1-1);
          tmp2=substring(out,clv_1_1,clv_2_1-1);
          tmp3=substring(out,clv_2_1,clv_3_1-1);
          if(contains(parL,fun), //210901from
            tmp3=Addpar(tmp3); //211029
          ); //210901to
          tmp4=substring(out,clv_3_1,length(out)-1);
          tmp=replace(rep_2_4,"xx",tmp1);
          tmp=replace(tmp,"yy",tmp2);
          tmp=replace(tmp,"zz",tmp3);
          out=replace(tmp,"ww",tmp4);
        );  //210831to
        out=pre+out+post;
        tmp=indexof(out,fun);
        ctr=ctr+1;
      );
    );
  );
  out=head+out;
  out=replace(out,"*"," ");
  out;
);
Getlevel(str):=Getlevel(str,",");
Getlevel(str,Arg):=Getlevel(str,Arg,"()");
Getlevel(str,Arg,bra):=(
  regional(nL,parL,n,tmp,tmp1,tmp2,out);
  if(islist(Arg),
    nL=Arg;
  ,
    nL=Indexall(str,Arg);
  );
  parL=Bracket(str,bra);
  if(length(parL)==0, //210907from
    tmp="("+str+")"; //210926from
    tmp1=Getlevel(tmp);
    out=apply(tmp1,[#_1-1,#_2-1]); //210926to
  ,
    out=[];
    forall(nL,n,
      if((n<parL_1_1)%(n>parL_(-1)_1),
        tmp=0;
      ,
        tmp2=select(parL,#_1<n);
        tmp2=tmp2_(-1);
        if(tmp2_2>=0,tmp=tmp2_2,tmp=-tmp2_2-1);
      );
      out=append(out,[n,tmp]);
    );
  );  //210907to
  out;
);
Addpar(str):=(
  regional(num,out,add,tmp);
  out=str;
  if(length(str)>0,
    if(substring(str,0,1)=="!",
      if(substring(str,1,2)!="!",
        out=substring(str,1,length(str));
      ,
        out="("+substring(str,2,length(str))+")";
      );
    ,
      add=(length(str)>=3)&(str!="{\pi}"); //211118
      num=apply(0..9,text(#));
      tmp=apply(1..(length(str)),str_#);
      tmp=sort(tmp);
      add=add&(common(num,tmp)!=tmp);
      tmp=Indexall(str,"^");
      add=add&(length(tmp)!=1);
      add=add&(str_1!="(");
      forall(["+","-","/"], //210923from
        add=add%(indexof(str,#)>0);
      ); //210923to
      if(add,out="("+out+")");
    );
  );
  out;
);
Tocindyform(str):=(
  regional(plv,funL,repL,out,sub,head,flg,rep,fun,pre,post,ctr,clv,nn,
      sharpL,tmp,tmp1,tmp2,tmp3,tmp4);
  repL=[ //190515from
    ["fr(",["","(xx)/(yy)"]],
    ["log(",["{log}(xx)","{log}(yy)/{log}(xx)"]], //220520
    ["sq(",["{sqrt}(xx)","(yy)^(1/(xx))"]], //190522
    ["po(",["","(xx)^(yy)"]],
    ["sin(",["{sin}(xx)","{sin}(yy)^(xx)"]], //190522from
    ["cos(",["{cos}(xx)","{cos}(yy)^(xx)"]],
    ["tan(",["{tan}(xx)","{tan}(yy)^(xx)"]],
    ["pi(",["{pi}()"]] //190522to
  ];
  out=replace(str,"(!","("); //210816,211118
  out=replace(out,"pi","pi()"); //210805
  out=replace(out,"tfr(","fr("); //220523
  out=replace(out," ",""); //220617
  out=replace(out,"(cross)","*"); //220615
  tmp1=""; //210817from
  flg=0;
  forall(1..(length(out)),
    tmp=out_#;
    if(contains(["[","]"],tmp),
      if(tmp=="[",flg=1);
      if(tmp=="]",flg=0);
    ,
      if(flg==0,tmp1=tmp1+tmp);
    );
  );
  out=tmp1; //210817to
  out=Removespace(out);
  head="";
  flg=0;
  plv=Bracket(out,"()");
  if(length(plv)>0,
    if(plv_1_2==0,
      head=substring(out,0,plv_1_1);
      out=substring(out,plv_1_1,length(out));
      if(substring(out,0,1)=="*",out=substring(out,1,length(out)));
      plv=Bracket(out,"()");
    );
    tmp=plv_(-1);
    if(tmp_2!=-1,
      out=str;
      flg=1;
    );
  );
  sharpL=[];
  ctr=1;
  if(flg==0,
    forall(repL,rep,
      fun=rep_1;
      tmp=indexof(out,fun);
      while((tmp>0)&(ctr<100),
        pre=substring(out,0,tmp-1);
        out=substring(out,tmp-1,length(out));
        plv=Bracket(out,"()");
        tmp=select(plv,#_2==-1);
        tmp=tmp_1;
        post=substring(out,tmp_1,length(out));
        out=substring(out,0,tmp_1);
        clv=Getlevel(out);
        clv=select(clv,#_2==1);
        nn=length(clv)+1;
        if(nn==1,
          tmp1=substring(out,plv_1_1,length(out)-1);
          out=replace(rep_2_1,"xx",tmp1);
        );
        if(nn==2,
          tmp1=substring(out,plv_1_1,clv_1_1-1);
          tmp2=substring(out,clv_1_1,length(out)-1);
          tmp=replace(rep_2_2,"xx",tmp1);
          out=replace(tmp,"yy",tmp2);
        );
        out=pre+out+post;        
        tmp1=indexof(out,"{"); //220520from
        tmp2=indexof(out,"}");
        sub=substring(out,tmp1,tmp2-1);
        tmp="#"+text(ctr)+"#";
        out=replace(out,"{"+sub+"}",tmp); //220520to
        sharpL=append(sharpL,[tmp,sub]);
        tmp=indexof(out,fun); //220513
        ctr=ctr+1;
      );
    );
  );
  out=Addasterisk(out);
  out=replace(out,"()","");
  forall(reverse(sharpL),
    out=replace(out,#_1,#_2);
  );
  out=head+out;
  out=replace(out,"e^","(exp(1))^"); //220610
  out;
);
Removespace(str):=(
  regional(tmp,flg,out);
  tmp=length(str)+1;
  flg=0;
  forall(1..(length(str)),
    if(flg==0,
      if((str_#)!=" ",
        tmp=#;
        flg=1;
      );
    );
  );
  out=substring(str,tmp-1,length(str));
  flg=0;
  tmp=0;
  forall(reverse(1..(length(out))),
    if(flg==0,
      if((out_#)!=" ",
        tmp=#;
        flg=1;
      );
    );
  );
  out=substring(out,0,tmp);
);
Addasterisk(strorg):=(
  regional(str,out,sgnL,numL,alphaL,numalpha,ctr,
      pre,now,tmp,tmp1,tmp2);
  str=Removespace(strorg);
  str=replace(str,"  ","*");
  sgnL=["+","-","*","/","^"];
  numL=append(apply(0..9,text(#)),"."); //210226
  tmp1=32..126;
  tmp=(65..90)++(97..122);
  tmp1=remove(tmp1,tmp);
  alphaL=apply(tmp,unicode(text(#),base->10));
  numalpha=numL++alphaL;
  out=""; pre="@";
  while(length(str)>0,
    now=str_1;
    str=substring(str,1,length(str));
    if(now=="#",
      if(contains(numalpha++[")"],pre),out=out+"*");
      tmp=indexof(str,"#");
      out=out+"#"+substring(str,0,tmp-1);
      str=substring(str,tmp,length(str));
    );    
    if(contains(numL,now),
      if(contains(alphaL++[")"],pre),out=out+"*");
    );
    if(contains(alphaL++["("],now),
      if(contains(numalpha++[")"],pre),out=out+"*");
    );
    out=out+now;
    pre=now;
  );
  out;
);
Drwexpr(pos,str):=Drwexpr(pos,str,[]);
Drwexpr(pos,str,Arg):=(
  regional(sz,clr);
  if(!islist(Arg),sz=Arg;clr=[0,0,0],sz=12;clr=Arg);
  Drwexpr(pos,str,sz,clr);
);
Drwexpr(pos,str,sz,clr):=(
  regional(tmp);
  if(!isstring(str),tmp=text(str),tmp=str);
  drawtext(pos,"$"+tmp+"$",size->sz,color->clr);
);
Htickmark(arglist):=Htickmark(arglist,[]); //190203
Htickmark(arglist,options):=( //190203
  regional(nn,tmp,tmp1,tmp2,mark);
  mark=MARKLEN/SCALEY;
  tmp1=select(1..(length(arglist)),!isstring(arglist_#)); //180710from
  forall(tmp1,nn,
    Listplot("ht"+text(nn),
        [[arglist_nn,mark],[arglist_nn,-mark]],append(options,"Msg=n"));//191101
    if(nn+2<=length(arglist),
      tmp=arglist_(nn+2);
      if(!isstring(tmp),
        Expr([[arglist_nn,0],"s1",arglist_(nn+1)],options); //190203
      ,
        Expr([[arglist_nn,0],arglist_(nn+1),arglist_(nn+2)],options); //190203
      );
    ,
      Expr([[arglist_nn,0],"s1",arglist_(nn+1)],options); //190203
    );
  );//180710to
);
Expr(Pt,Dr,St):=Expr([Pt,Dr,St]);
Expr(list):=Expr(list,[]);
Expr(Pt,Dr,St,options):=Expr([Pt,Dr,St],options); //190409
Expr(listorg,options):=( //16.10.09
  regional(list,str,tmp,tmp1,tmp2);
  list=listorg;
  forall(1..round(length(list)/3),
    str=list_(3*#);
    if(isstring(str), //200526from
      if(!iswindows(),
        str=replace(str,"","\");
      ); 
    ,
      str=format(str,10)
    ); //200526to
    str="$"+str+"$"; //200526
    list_(3*#)=str;
  );
  Letter(list,options);
);
Letter(Pt,Dr,St):=Letter([Pt,Dr,St]);
Letter(list):=Letter(list,[]);
Letter(Pt,Dr,St,options):=Letter([Pt,Dr,St],options);//181218
Letter(list,options):=(
  regional(Nj,Pos,Dir,Str,Off,Xmv,Ymv,Noflg,opcindy,
      opL,aln,sz,clr,bld,ita,tmp,tmp1,tmp2,color,color4,eqL);
  tmp=Divoptions(options);
  eqL=tmp_5; //190209
  Noflg=tmp_2;
  color=tmp_(length(tmp)-2); color4=Colorrgb2cmyk(color); //200618
  opL=select(options,indexof(#,"->")>0); //16.10.09from
  tmp=select(opL,indexof(#,"color"));
  sz=16; //210516
  bld=false;
  ita=false;
  aln="left";
  forall(opL,
    tmp=indexof(#,"->");
    tmp1=Removespace(substring(#,0,tmp-1));
    tmp2=substring(#,tmp+1,length(#));
    if(tmp1=="size",sz=parse(tmp2));
    if(tmp1=="color",clr=parse(tmp2));
    if(tmp1=="bold",bld=parse(tmp2));
    if(tmp1=="ita",ita=parse(tmp2));
  );//16.10.09to
  forall(eqL, //190209from
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1));
    if(tmp1=="S",
      sz=round(parse(tmp_2)*16); //210516
    );
  ); //190209to
  Nj=1;
  if(Ketcindyjsfigure>0,sz=round(sz*Ketcindyjsscale) ); // 
  while(Nj+2<=length(list),
    Pos=list_Nj;
    Dir=list_(Nj+1);
    Str=list_(Nj+2);
    if(!isstring(Str),Str=format(Str,10)); // 16.09.30,10.09
    tmp=replace(Str,".xy","");
    tmp=replace(tmp,".x","(1)");
    Str=replace(tmp,".y","(2)");
    Str=RSslash(Str); // 17.09.24
    Str=replace(Str,"`","'");//180303
    tmp=Dq+","+Dq+Str+Dq+")";
    if(Noflg<2,
      Off=[0,0];
      Xmv=0; Ymv=0;
      aln="mid"; //200530from
      if(indexof(Dir,"c")>0, Off_2=-0.3*sz);
      if(indexof(Dir,"n")>0,Off_2=0;Ymv=Lettermove("n",Dir)); //210601
      if(indexof(Dir,"s")>0, Off_2=-0.85*sz;Ymv=-Lettermove("s",Dir));
      if(indexof(Dir,"e")>0,
        aln="left";
        if(indexof(Dir,"n")+indexof(Dir,"s")==0,Off=[0,-0.3*sz]);
        Xmv=Lettermove("e",Dir);
      );
      if(indexof(Dir,"w")>0,
        aln="right";
        if(indexof(Dir,"n")+indexof(Dir,"s")==0,Off=[0,-0.4*sz]);
        Xmv=-Lettermove("w",Dir);
      );
      Str=list_(Nj+2);  //17.10.17
      Pos=Pos+[Xmv,Ymv]*MARKLEN;//210530to
      if(length(color)==4,color=Colorcmyk2rgb(color)); //200523
      tmp="drawtext("+format(Pcrd(Pos),10)+",offset->"+text(Off)+","+Dqq(Str)+","; 
      tmp1="size->sz,color->colornow,align->"+Dqq(aln)+",bold->"+bld+",italics->"+ita; //210601
      tmp1=Assign(tmp1,["sz",text(sz),"colornow",text(color),"aln",Dqq(aln),"bld",text(bld),"ita",text(ita)]);
      tmp=tmp+tmp1+");";
      GCLIST=append(GCLIST,[tmp,[6,0]]); //201004to
    );
    Nj=Nj+3;
  );
);
Lettermove(dir,str):=(
  regional(Suu,tmp,tmp1,out,nn);
  Suu="+-.0123456789";
  tmp=indexof(str,dir);
  tmp1=substring(str,tmp,length(str));
  out="";
  nn=1;
  while(nn<=length(tmp1),
    tmp=substring(tmp1,nn-1,nn);
    if(indexof(Suu,tmp)>0,
      out=out+tmp;
    ,
      nn=length(str);
    );
    nn=nn+1;
  );
  if(length(out)==0,out=0,out=parse(out));
  out;
);
Vtickmark(arglist):=Vtickmark(arglist,[]); //190203
Vtickmark(arglist,options):=( //190203
  regional(nn,tmp,tmp1,tmp2,mark);
  mark=MARKLEN/SCALEX;
  tmp1=select(1..(length(arglist)),!isstring(arglist_#)); //180710from
  forall(tmp1,nn,
    Listplot("vt"+text(nn),
         [[mark,arglist_nn],[-mark,arglist_nn]],append(options,"Msg=n")); //191101
    if(nn+2<=length(arglist),
      tmp=arglist_(nn+2);
      if(!isstring(tmp),
        Expr([[0,arglist_nn],"w1",arglist_(nn+1)],options); //190203
      ,
        Expr([[0,arglist_nn],arglist_(nn+1),arglist_(nn+2)],options); //190203
      );
    ,
      Expr([[0,arglist_nn],"w1",arglist_(nn+1)],options); //190203
    );
  );//180710to//  tmp=MakeRarg(arglist);
);
Perpplane(name,ptstr,nvec):=
    Perpplane(name,ptstr,nvec,"draw");
Perpplane(name,ptstr,nstr,optionsorg):=(
  regional(options,Eps,eqL,strL,nvec,sgstr,pP,v1,v2,v3,
     gptflg,th,ph,pA3,pB3,tmp,tmp1,tmp2);
  Eps=10^(-4);
  options=optionsorg; //220714from
  if(!islist(options),options=[options]);
  gptflg=0;
  tmp=select(options,Toupper(substring(#,0,1))=="P");
  options=remove(options,tmp);
  if(length(tmp)>0,gptflg=1);
  tmp=select(options,Toupper(substring(#,0,1))=="D");
  options=remove(options,tmp); //220714to
  if(isstring(nstr),nvec=parse(nstr+"3d"),nvec=nstr);
  if(indexof(ptstr,"3d")==0, //181107from
    pP=parse(ptstr+"3d");
  ,
    pP=parse(ptstr);
  ); //181107to
  v3=nvec/|nvec|;
  th=THETA; ph=PHI;
  tmp=Findangle(v3);
  THETA=tmp_1; PHI=tmp_2;
  v1=Cancoordpara([1,0,0]);
  v2=Cancoordpara([0,1,0]);
  THETA=th; PHI=ph;
  tmp=indexof(name,"-");
  tmp1=substring(name,0,tmp-1);
  tmp2=substring(name,tmp,length(name));
  tmp=indexof(pLstr,"-");
  pA3=pP+v1;
  pB3=pP+v2;
  if(gptflg==1, //190714from
    Putpoint3d([tmp1,pA3,tmp2,pB3d],["fix"]);
  ,
    Defvar(tmp1+"3d",pA3); //190714from
    Defvar(tmp2+"3d",pB3); 
    Pointdata3d(tmp1,pA3,options);
    Pointdata3d(tmp2,pB3,options); //190714to
  );
  [pA3,pB3];
);
Findangle(vec):=(
  regional(vec3,vec2,Eps,th,ph,tmp);
  Eps=10^(-4);
  vec3=vec_(1..3);
  vec2=vec_(1..2);
  th=arccos(vec_3/|vec3|);
  if(|vec2|>Eps,
    ph=arccos(vec_1/|vec2|);
    if(vec_2<0,
      ph=2*pi-ph; // 15.03.28
    );
  ,
    if(length(vec)>3,ph=vec_4*pi/180,ph=PHI);
  );
  [th,ph];
);
Cancoordpara(pc):=(
  regional(Xz,Yz,Zz,tmp1,tmp2,tmp3);
  Xz=pc_1; Yz=pc_2; Zz=pc_3;
  tmp1=-Xz*sin(PHI)-Yz*cos(PHI)*cos(THETA)+Zz*cos(PHI)*sin(THETA);
  tmp2=Xz*cos(PHI)-Yz*sin(PHI)*cos(THETA)+Zz*sin(PHI)*sin(THETA);
  tmp3=Yz*sin(THETA)+Zz*cos(THETA);
  [tmp1,tmp2,tmp3];
);
Putpoint3d(ptslist):=Putpoint3d(ptslist,"",0);
Putpoint3d(Arg1,Arg2):=( // 16.03.02 from
  if(islist(Arg1),
    Putpoint3d(Arg1,Arg2,0);
  ,
    Putpoint3d(Arg1,Arg2,"fix");
  );
);
Putpoint3d(Arg1,Arg2,Arg3):=(
  regional(nn,kk,pt,pt3,ptslist,fixstr,tmp,tmp1,tmp2,tmp3); //16.08.19
  if(isstring(Arg1),
    ptslist=[Arg1,Arg2];
    fixstr=Arg3;
  ,
    ptslist=Arg1;
    fixstr=Arg2;
  ); 
  if(islist(fixstr),fixstr=fixstr_1);// 16.03.02 until
  nn=length(ptslist)/2;
  forall(1..nn,kk, // 16.08.19from
    tmp1=ptslist_(2*kk-1);
    pt3=ptslist_(2*kk); // 16.08.19until
    VLIST=select(VLIST,#_1!=tmp1+"3d");
    tmp2=parse(tmp1);
    if(ispoint(tmp2), // 16.05.26from
      if(islist(fixstr),tmp=fixstr_1,tmp=fixstr);
      tmp=Toupper(tmp);
      if(tmp!="FIX", 
        tmp=Xyzcoord(tmp2.xy,parse(tmp1+"z.xy")); //181028
      ,
        tmp=pt3;
      ); 
      Defvar(tmp1+"3d",tmp);
    ,
      Defvar(tmp1+"3d",pt3);
    );   // 16.05.26until
    Defvar(tmp1+"fix",0);
    pt=Parapt(pt3);
    Putpoint(tmp1,pt,parse(tmp1+".xy"));
    inspect(parse(tmp1),"ptsize",3);
    inspect(parse(tmp1),"color",2);
    inspect(parse(tmp1),"textsize",TSIZE);
    if(SUBSCR==1,
      tmp2=tmp1+"z";
      Putpoint(tmp2,Parasubpt(pt3));
      inspect(parse(tmp2),"ptsize",3);
      inspect(parse(tmp2),"color",3);
      inspect(parse(tmp2),"textsize",TSIZEZ);
    );
  );
  if(islist(fixstr),tmp=fixstr_1,tmp=fixstr);
  if(tmp=="fix" % tmp=="Fix",
    Fixpoint3d(ptslist);
  );
);
Xyzcoord(pm,ps):=Xyzcoord(pm_1,pm_2,ps); //181028from
Xyzcoord(X,Y,ps):=(
  regional(pt3d);
  pt3d=Mainsubpt3d([X,Y],ps);
  pt3d;//181028to
);
Mainsubpt3d(pm,psv):=( //181027
  regional(Eps,mv,dp,v,x,y,z);
  Eps=10^(-4);
  mv=NE.x-SW.x;
  dp=pi/24;
  if(abs(cos(THETA))>Eps,
    if(length(psv)>1,v=psv_2, v=psv);
    x=(v*cos(PHI)*sin(THETA)-pm_1*sin(PHI)*cos(THETA)-pm_2*cos(PHI))/cos(THETA);
    y=(v*sin(PHI)*sin(THETA)+pm_1*cos(PHI)*cos(THETA)-pm_2*sin(PHI))/cos(THETA);
    z=v;
  ,
    if(length(psv)>1,v=psv_1, v=psv);
    x=(pm_1*cos(PHI+dp)-(v-mv)*cos(PHI))/sin(dp);
	y=(pm_1*sin(PHI+dp)-(v-mv)*sin(PHI))/sin(dp);
    z=pm_2;
  );
  [x,y,z];
);
Defvar(varstr):=(
  regional(name,value,tmp,tmp1);
  if(isstring(varstr),
    parse(varstr+";");
    tmp=indexof(varstr,"=");
    name=substring(varstr,0,tmp-1);
    value=substring(varstr,tmp,length(varstr));
    value=parse(value);
    tmp1=select(1..length(VLIST),VLIST_#_1==name);
    if(length(tmp1)>0,
      tmp=tmp1_1;
      VLIST_tmp=[name,value];
    ,
      VLIST=prepend([name,value],VLIST);
    );
  ,
    forall(1..(length(varstr)/2), // 16.11.16from
      name=varstr_(2*#-1);
      value=varstr_(2*#);
      Defvar(name,value);
    ); // 16.11.16until
  );
);
Defvar(name,value):=(
  regional(tmp,tmp1);
  if(islist(value),
    tmp1="[";
    forall(value,
      if(isstring(#), // 16.11.14
        tmp1=tmp1+Dq+#+Dq+","; // 16.11.14
      ,
        tmp1=tmp1+format(#,16)+","; //190918
      );
    );
    tmp1=substring(tmp1,0,length(tmp1)-1)+"]";
  ,
    tmp1=format(value,10);
  );
  tmp=name+"="+tmp1+";"; // 15.02.06//190415
  parse(tmp);
  VLIST=select(VLIST,#_1!=name); // 15.02.08
  VLIST=prepend([name,value],VLIST);
);
Parapt(pt):=(
  regional(Xz,Yz);
  Xz=-pt_1*sin(PHI)+pt_2*cos(PHI);
  Yz=-pt_1*cos(PHI)*cos(THETA)-pt_2*sin(PHI)*cos(THETA)+pt_3*sin(THETA);
  [Xz,Yz];
);
Putpoint(name,Pt):=Putpoint(name,Pt,Pt);
Putpoint(name,Ptinit,Pt):=(
  regional(ptstr); 
    ptstr=name+".xy="+Textformat(Pcrd(Pt),10)+";";
    parse(ptstr);
    Ptpos(name,Pcrd([Pt_1,Pt_2])); //200529
);
Ptpos(pt):=Ptpos(pt,[]);
Ptpos(ptorg,pos):=(
  regional(pt,out,tmp);
  if(ispoint(ptorg),pt=ptorg,pt=parse(ptorg));
  if(length(pos)==0,
    tmp=pt.name+"position";
    out=parse(tmp);
    if(!islist(out),
      tmp=tmp+"="+Textformat(pt.xy,12)+";";  //200108 6->12
      parse(tmp);
    );
  ,
    pt.xy=pos;
    tmp=pt.name+"position="+Textformat(pt.xy,12)+";"; //200108 6->12
    parse(tmp);
    out=pt.xy;
  );
  out;
);
Parasubpt(pt):=( //181027
  regional(mv,dp,xs);
  mv=NE.x-SW.x;
  dp=pi/24;
  xs=-pt_1*sin(PHI+dp)+pt_2*cos(PHI+dp);
  [xs+mv,pt_3];
);
Fixpoint3d(ptlist):=(
  regional(name,pt3,pt2,tmp,tmp1,tmp2);
  forall(1..(length(ptlist)/2),
    name=ptlist_(2*#-1);
    Defvar(name+"fix",1);
    pt3=ptlist_(2*#);
    pt2=Parapt(pt3);
    tmp1=textformat(pt2_1,10);
    tmp2=textformat(pt2_2,10);
    tmp=name+".xy=["+tmp1+","+tmp2+"];";
    parse(tmp);
    tmp1=name+".x+NE.x-SW.x";
    tmp2=textformat(pt3_3,10);
    tmp=name+"z.xy=["+tmp1+","+tmp2+"];";
    parse(tmp);
  );
);
Pointdata3d(name,pt3):=Pointdata3d(name,pt3,[]);//181017from
Pointdata3d(name,pt3,optionsorg):=( //181017from
  regional(pt2,ptsub,options,tmp,label);
  label=[];
  options=append(optionsorg,"Disp=n"); //220722from
  tmp=select(options,Toupper(substring(#,0,1))=="L");
  if(length(tmp)>0,
    options=remove(options,tmp);
    label=Strsplit(tmp_1,",");
    if(length(label)==1,label=append(label,"1"));
    if(length(label)==2,label=append(label,"black"));
  ); //220722to
  pt2=Parapt(pt3);//220713from
  if(length(label)>0, //220722from
    tmp=select(options,indexof(#,"Size=")==0);
    tmp=select(tmp,indexof(#,"Color=")==0);
    tmp=concat(tmp,["Size="+label_2,"Color="+label_3]);
    Letter(pt2,label_1,name, tmp);
  ); //220722to
  Pointdata("-"+name+"2d",pt2,options);
  if(SUBSCR==1,
    ptsub=Parasubpt(pt3);
    tmp=append(options,"notex"); //220722
    Pointdata("-"+name+"z2d",ptsub,tmp);
  );
  Defvar(name+"3d",pt3);//220713
);
Pointdata(nm,list):=Pointdata(nm,list,[]);
Pointdata(nm,listorg,optionsorg):=(
  regional(list,name,opstr,opcindy,Msg,options,Ltype,Noflg,eqL,color,color4,
      size,inside,incolor,ratio,tmp,tmp1,tmp2,tmp3,ngc1,ngc2,ng1,ng2,nc1,nc2);
  if(substring(nm,0,1)=="-", //200510[2lines]
    name=substring(nm,1,length(nm));
  ,
    name="pt"+nm;
  );
  options=optionsorg; //200512
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  eqL=tmp_5;
  opstr=tmp_(length(tmp)-1);
  color=tmp_(length(tmp)-2);
  opcindy="";
  size="1";
  dispflg="Y";
  inside="Y"; //200512
  incolor="";
  ratio=0.95; //200708,0813
  border="Y";
  Msg="Y";
 Msg="N"; //
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1));
    if(tmp1=="S",
      size=tmp_2; //190406[2lines]
      tmp1=parse(size);
      options=remove(options,[#]);
    );
    if(tmp1=="D", //181030from
      dispflg=Toupper(substring(tmp_2,0,1));
      options=remove(options,[#]);
    );
    if(tmp1=="I", //190628from
      inside=tmp_2; //201027from
      if(substring(inside,0,1)!="[",
        tmp2=indexof(tmp_2,",");
        if(tmp2>0,
          ratio=parse(substring(tmp_2,tmp2,length(tmp_2)));
          inside=substring(tmp_2,0,tmp2-1); //201027
        ,
          inside=tmp_2; 
        ); 
      ); //201027to
      if(contains(["0","N","NO","1","Y","YES"],Toupper(inside)), //200519from
        if(contains(["0","N","NO"],Toupper(inside)),inside="N",inside="Y");
      ,
        incolor=inside;
        inside="N";
      ); //200519to
      options=remove(options,[#]);
    );
    if(tmp1=="M", //190206from
      Msg=Toupper(substring(tmp_2,0,1));
    ); //190206to
  );
  if(dispflg=="Y", 
    if(Msg=="Y", //190206
      println("generate pointdata "+name);
    );
  ); //181030to
  ngc1=length(GCLIST)+1; //210422[2lines
  ng1=length(GLIST)+1;
  nc1=length(COM2ndlist)+1;
  if(isstring(listorg),
    list=parse(listorg);
  ,
    list=listorg;
  ); //17.10.23
  if(!islist(list),list=[list]); //200510from
  list=apply(list,if(ispoint(#),Lcrd(#),#));
  if(Measuredepth(list)==0,list=[list]);
  tmp1=Textformat(list,6);
  if(length(list)>1,tmp2=apply(list,[#]),tmp2=list); //200524
  tmp2=Textformat(tmp2,6);
  tmp=name+"="+tmp2+";"; //190415
  parse(tmp);
  if(Noflg<3,
    tmp=RSform(tmp1,2);
  );
  if(Noflg<2, //210602
    tmp1=parse(size)*TenSizeInit;
    forall(1..(length(list)),
      if(inside=="N", //210602from
        if(length(incolor)>0, //200519from
          if(isstring(incolor),incolor=Colorname2cmyk(incolor)); // 
          if(length(incolor)==4,incolor=Colorcmyk2rgb(incolor));
          tmp2=opcindy+",color->";
          tmp=["fillcircle("+text(Pcrd(list_#))+","+text(tmp1)+tmp2+text(incolor)+");",[5,0]];
          GCLIST=append(GCLIST,tmp);
          tmp=["drawcircle("+text(Pcrd(list_#))+","+text(tmp1)+tmp2+text(color)+");",[5,0]];
          GCLIST=append(GCLIST,tmp); // 
        );
      ,
        tmp=[tmp3_1,"Msg=n"]; //220722from
        if(Noflg==1,tmp=prepend("notex",tmp));
          if(length(color)==4,color=Colorcmyk2rgb(color)); // 
          tmp2=opcindy+",color->"+text(color); //210609
          tmp=["fillcircle("+text(Pcrd(list_#))+","+text(tmp1)+tmp2+");",[5,0]];
          GCLIST=append(GCLIST,tmp);
          tmp=["drawcircle("+text(Pcrd(list_#))+","+text(tmp1)+tmp2+");",[5,0]];
          GCLIST=append(GCLIST,tmp);  // 
      ); //210602to
      tmp=round(10*sqrt(parse(size))); //201027from (moved)
      if(Noflg==0,options=[Ltype,"Color="+text(color),"Num="+text(tmp)]);
      if(Noflg==1,options=["notex",Ltype,"Color="+text(color),"Num="+text(tmp)]);
      if(Noflg==2,options=["nodisp"]);
      options=concat(options,[tmp3_1,"Msg=n"]);  //201027to
    ); 
  );
  ngc2=length(GCLIST); //210422[5lines]
  ng2=length(GLIST);
  nc2=length(COM2ndlist);
  tmp=[name,list,GCLIST_(ngc1..ngc2),GLIST_(ng1..ng2),COM2ndlist_(nc1..nc2)];  
  PointDataList=append(PointDataList,tmp);
  list;
);
Spaceline(ptlist):=Spaceline(ptlist,[]); // 16.02.22 from
Spaceline(Arg1,Arg2):=(
  regional(name,tmp,tmp1,tmp2);
  if(isstring(Arg1),
    Spaceline(Arg1,Arg2,[]);
  ,
    tmp=Arg1.name; //190505
    tmp=substring(tmp,1,length(tmp)-1);
    name="-"+replace(tmp,",","");
    Spaceline(name,Arg1,Arg2);
  );
); // 16.02.22 to
Spaceline(nm,ptlistorg,optionorg):=(
  regional(name2,name3,options,Out,tmp,tmp1,tmp2,
        opstr,opcindy,Ltype,Noflg,eqL,ptlist, Msg,color,color4);
  ptlist=apply(ptlistorg,if(ispoint(#),parse(#.name+"3d"),#)); // 190505
  ptlist=apply(ptlist,if(isstring(#),parse(#),#)); //190330
  if(substring(nm,0,2)=="bz",
    name2=replace(nm,"bz","bz2d");
    name3=replace(nm,"bz","bz3d");
  ,
    if(substring(nm,0,1)=="-",
      tmp=substring(nm,1,length(nm));
      if(indexof(tmp,"3d")>0,name3=tmp,name3=tmp+"3d");
      name2=replace(name3,"3d","2d");
    ,
      name2="sl2d"+nm;
      name3="sl3d"+nm;
    );
  );
  options=select(optionorg,length(#)>0);  // 160415
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  eqL=tmp_5;
  color=tmp_(length(tmp)-2);color4=Colorrgb2cmyk(color); //200626
  opcindy=tmp_(length(tmp));
  Msg=1;
Msg=0; // 
  forall(eqL,
    tmp=substring(#,0,1);
    if(Toupper(tmp)=="M",
      tmp=indexof(#,"=");
      tmp1=substring(#,tmp,tmp+1);
      if(Toupper(tmp1)=="N",
        Msg=0;
      );
    );
  );
  if(Noflg<3,
    if(Msg==1,
      println("generate Spaceline "+name3);
    );
    tmp=name3+"="+Textformat(ptlist,10)+";"; //190330//190415
    parse(tmp);
    tmp1=Projpara(name3,["nodata"]);
    tmp=name2+"="+Textformat(tmp1,10)+";"; //190415
    parse(tmp);
    tmp="[";
    forall(ptlist, //17.07.13from
      if(isstring(#),
        tmp=tmp+#+",";
      ,
        tmp=tmp+Textformat(#,10)+",";
      );
    );
    tmp=substring(tmp,0,length(tmp)-1)+"]";
    tmp=name3+"=Spaceline("+tmp+")"; //17.07.13to
    GLIST=append(GLIST,tmp);
    tmp=name2+"=Projpara("+name3+")";
    GLIST=append(GLIST,tmp);
  );
  if(Noflg<3, //190818
    if(isstring(Ltype),
      if(color4!=KCOLOR, //180904
        Texcom("{");Com2nd("Setcolor("+color4+")");//180722
      );
	  Ltype=Getlinestyle(text(Noflg)+Ltype,name2);
      if(color4!=KCOLOR, //180904
        Texcom("}");//180722
      );
	,
      if(Noflg==1,Ltype=0);
    );
    GCLIST=append(GCLIST,[name2,Ltype,opcindy]);
  );
  ptlist;
);
Projpara(ptdata):=Projpara(ptdata,[]);
Projpara(ptdata,optionsorg):=(
  regional(options,name2,name3,Ltype,Noflg,eqL,opcindy,
     dtL,ptL,tmp,tmp1,Out,color,color4,msg);
  options=optionsorg;
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  eqL=tmp_5;
  color=tmp_(length(tmp)-2);color4=Colorrgb2cmyk(color); //200626
  opcindy=tmp_(length(tmp));
  msg="Y"; //180602from
msg="N"; //
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1)); //181111
    if(tmp1=="M",
      tmp=substring(tmp_2,0,1);
      msg=Toupper(tmp);
      options=remove(options,[#]);
    );
  );//180602to
  Out=[];
  if(isstring(ptdata),tmp=parse(ptdata),tmp=ptdata);
  if(Measuredepth(tmp)<1,dtL=ptdata,dtL=[ptdata]);
  forall(dtL,name3,
    if(indexof(name3,"3d")>0, //17.05.24
      name2=replace(name3,"3d","2d");
    ,
      name2="para"+name3;
    );  
    ptL=Projcurve(name3);
    ptL=select(ptL,length(#)>1);//17.06.02
    if(length(ptL)==1,
      ptL=ptL_1;
    );
    if(Noflg<3,
      if(msg=="Y", //220206
        println("generate projparadata  "+name2);
      );//180602to
      tmp=name2+"="+Textformat(ptL,6)+";"; //220206
      parse(tmp);
      tmp=name2+"=Projpara("+name3+")";
      GLIST=append(GLIST,tmp);
    );
    if(Noflg<3, //190818
      if(isstring(Ltype),
        if(color4!=KCOLOR, //180904
          Texcom("{");Com2nd("Setcolor("+color4+")");//180722
        );
		Ltype=Getlinestyle(text(Noflg)+Ltype,name2);
        if(color4!=KCOLOR, //180904
          Texcom("}");//180722
        );
	  ,
        if(Noflg==1,Ltype=0);
      );
     GCLIST=append(GCLIST,[name2,Ltype,opcindy]);
    );
    Out=append(Out,ptL);
  );
  if(length(Out)==1,Out=Out_1);
  if(length(Out)==1,Out=Out_1); // 15.02.24
  tmp=[];
  forall(Out,
    if(length(#)>0,tmp=append(tmp,#));
  );
  Out=tmp;
  Out;
);
Projcurve(crv):=(
  regional(CurveL,Curve,Eps,AnsL,Out,sp,cp,st,,ct,ii,pt,
       Xz,Yz,tmp,tmp1,tmp2);
  Eps=10^(-6);
  sp=sin(PHI); cp=cos(PHI);
  st=sin(THETA); ct=cos(THETA);
  if(isstring(crv),CurveL=parse(crv),CurveL=crv);
  if(Measuredepth(CurveL)==1,CurveL=[CurveL]);
  Out=[];
  forall(CurveL,Curve,
    AnsL=[];
    forall(1..length(Curve),ii,
      pt=Curve_ii;
      if(pt_1!="inf",
        Xz=-pt_1*sp+pt_2*cp;
        Yz=-pt_1*cp*ct-pt_2*sp*ct+pt_3*st;
        tmp=[Xz,Yz];
        if(ii==1,
           AnsL=[tmp];
        ,
          tmp1=AnsL_(length(AnsL));
          if(tmp1_1=="inf" % |tmp-tmp1|>Eps,
            AnsL=append(AnsL,tmp);
          );
        );
      ,
        AnsL=append(AnsL,["inf"]);
      );
    );
    tmp1=[];
    tmp2=select(1..length(AnsL),AnsL_#==["inf"]);
    tmp=1;
    forall(tmp2,
      if(#>tmp,
        tmp1=concat(tmp1,[AnsL_(tmp..(#-1))])
      );
      tmp=#+1;
    );
    if(tmp<length(AnsL),
      tmp1=concat(tmp1,[AnsL_(tmp..length(AnsL))]);
    );
    AnsL=tmp1;
    if(length(AnsL)==1,AnsL=AnsL_1);
    Out=append(Out,AnsL);
  );
  if(length(Out)==1,
    Out=Out_1;
  );
  Out;
);
Ketinit():=Ketinit("fig",0.3); //190831from
Ketinit(Arg):=(//181001from
  if(isstring(Arg),
    Ketinit(Arg,0.3);
  ,
    Ketinit("fig",Arg);
  );
);
Ketinit(work,strictsep):=( //200509
 regional(pt,tmp,tmp1,tmp2,letterc,boxc,shadowc,mboxc);
  PenThickInit=8;
  ULEN="1cm";
  MEMORI=0.05;//18.01.15from
  MEMORIInit=MEMORI;
  MEMORINow=MEMORI;
  MARKLEN=0.05;
  MARKLENInit=MARKLEN; //180504
  MARKLENNow= MARKLEN;
  GENTEN=[0,0];//18.01.15to
  TABLECOUNT=0; //190428
  KETPICLAYER=20;
  MilliIn=1/2.54*1000;
  PenThick=round(MilliIn*0.02);
  PenThickInit=PenThick;
  TenSizeInit=0.02;
  TenSize=TenSizeInit;
  YaSize=1; YaAngle=18; YaPosition=1;
  YaCut=0.2; //191203
  YasenStyle="dr,1"; Yajiristyle="tf";
  KETPICCOUNT=1;
  KCOLOR=[0,0,0,1]; //200513,200618
  GLIST=[]; //201005rechanged
  GCLIST=[]; //201005rechanged
  AddGraphList=[]; //210422[2lines]
  PointDataList=[];
  if(!islist(VLISTadd),VLIST=[],VLIST=VLISTadd); //200123
  if(!islist(FUNLISTadd),FUNLIST=[],FUNLIST=FUNLISTadd); //200123
  LETTERlist=[];
  ADDAXES="1";
  AXSTYLE=[["l","x","e","y","n","O","sw","","",""],[]]; //190901
  AXCOUNT=1; //181215
  SHADECTR=1; //190222
  LFmark=unicode("000a"); Bs=unicode("005c");
  CRmark=unicode("000d");//16.12.13
  Dq=unicode("0022");
  Changework(Dircdy+pathsep()+work); //180329to,181001
  ArrowlineNumber=1;  // 15.01.05
  ArrowheadNumber=1;
  BezierNumber=1; //15.01.03
  SCALEX=1;
  SCALEY=1;
  XMIN=-5;
  XMAX=5;
  YMIN=-5;
  YMAX=5;
  StrictSep=strictsep; //190831
  Setwindow("Msg=n"); // 16.05.31
  forall(remove(allpoints(),[SW,NE]),
    Strictmove(#.name);
    Ptpos(#,#.xy); //200529
  ); //190917
);
Setwindow():=Setwindow("Msg=y");
Setwindow(str):=(
  regional(tmp,tmp1,tmp2,msg);
  msg="Y";
  tmp=indexof(str,"="); // 16.02.10
  msg=Toupper(substring(str,tmp,tmp+1));
  Strictmove("SW"); Strictmove("NE");//190927
  if((ispoint(SW)) & (ispoint(NE)),
    tmp1=LLcrd(Ptpos(SW));//190912[2lines]
    tmp2=LLcrd(Ptpos(NE));
    XMIN=tmp1_1; XMAX=tmp2_1;
    YMIN=tmp1_2; YMAX=tmp2_2;
  ,
    if(!ispoint(SW), //191005from
      Putpoint("SW",Pcrd([-5,-5]));
      XMIN=-5; YMIN=-5;
      Ptpos(SW,SW.xy);
    );
    if(!ispoint(NE),
      Putpoint("NE", Pcrd([5,5]));
      XMAX=5; YMAX=5;
      Ptpos(NE,NE.xy);
    ); //191005to
  );
);
Setwindow(xrange,yrange):=Setwindow(xrange,yrange,"Msg=y");
Setwindow(xrange,yrange,msg):=(
  XMIN=xrange_1;
  XMAX=xrange_2;
  YMIN=yrange_1;
  YMAX=yrange_2;
  Ptpos(SW,Pcrd([XMIN,YMIN])); //190927from
  Ptpos(NE,Pcrd([XMAX,YMAX]));
  Strictmove("SW"); Strictmove("NE");
);
Strictmove(pC):=Strictmove(pC,StrictSep); //190831
Strictmove(pCorg,sep):=(
  regional(pC,tmp,tmp1,tmp2);
  pC=pCorg;
  if(ispoint(pC),pC=pC.name);
  tmp1=pC+"position";
  if(!islist(parse(tmp1)),
    tmp=tmp1+"="+Textformat(parse(pC).xy,12)+";"; //200112
    parse(tmp);
  ,
   tmp=parse(pC).xy;
    tmp2=mouse().xy;
    if(|tmp-tmp2|>sep,
      tmp=pC+".xy="+pC+"position";
      parse(pC).xy=parse(pC+"position");
    ,
      tmp=tmp1+"="+Textformat(parse(pC).xy,12)+";"; //200112
      parse(tmp);
    );
  );
);
Ketinit3d():=Ketinit3d(1);
Ketinit3d(subflg):=(
  regional(ctr,tmp,tmp1,tmp2,tmp3,tmp4);
 SUBSCR=0; // 
  Setwindow("Msg=no");
  Addax(0);
  TSIZE=10;
  TSIZEZ=10;
  ErrFlg=0;
  xPos=-5; yTh=tmp-0.5; yPh=tmp-1;
  THETA=(TH.x-xPos)*20*pi/180;
  PHI=(FI.x-xPos)*40*pi/180; //190713to
  Skeleton=1; //210324
);
Addax(param):=(
  ADDAXES=text(param);
);
Start3d():=Start3d([],[]); 
Start3d(Arg):=( //190503from
  regional(tmp);
  tmp=select(Arg,isstring(#)); //190822
  tmp=select(tmp,indexof(#,"=")>0);
  if(length(tmp)==0,
    Start3d(Arg,[]);
  ,
    Start3d([],Arg);
  );
);
Start3d(ptexception,optionjs):=(//190503to
  regional(xPos,yTh,yPh,xmn,xMx,ymn,yMx,pt,pt3,pt2,theta,phi,
    Eps,tmp,tmp1,tmp2,tmp3,tmp4);
  PTEXCEPTION=["LB"];
  SLIDEFLG="Y";
  forall(optionjs,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1));
    if(tmp1=="S",
      SLIDEFLG=Toupper(substring(tmp_2,0,1));
    );
    if(tmp1=="R",
      tmp2=tmp_2;
      if(substring(tmp2,0,1)=="[",tmp2=substring(tmp2,1,length(tmp2)-1));
      tmp2=tokenize(tmp2,",");
      REMOVEPTJS=concat(REMOVEPTJS,tmp2);
    );
  );
  GCLIST=[];
  SEG3dlist=[];
  KETJSOP=[]; //190129
  REMOVEPTJS=[]; SLIDEFLG="Y"; //190504
  KetcindyjsDataList=[]; //190511
  ArrowlineNumber=1;  // 16.01.31
  ArrowheadNumber=1;
  BezierNumber=1; //16.01.31
  BezierNumber3=1; //16.08.19
  Setwindow("Msg=no"); // 16.06.20from
  tmp=round(4*SW.y)/4;
  xPos=-5; yTh=tmp-0.5; yPh=tmp-1; //220126
  Putpoint("LB",[xPos-0.5,yPh]); //220215[2lines]
  inspect(LB,"ptsize",0);
  inspect(LB,"labeled",false);
  if(SLIDEFLG=="Y", // 
    Slider("TH",[xPos,yTh],[xPos+9,yTh],["Color=green"]); //190209
    Slider("FI",[xPos,yPh],[xPos+9,yPh],["Color=green"]); //190209
    THETA=(TH.x-xPos)*20*pi/180;
    PHI=(FI.x-xPos)*40*pi/180; // 16.06.20until
    drawtext([xPos-0.8,yTh-0.1],Sprintf(THETA*180/pi,2),align->"right");
    drawtext([xPos-0.8,yPh-0.1],Sprintf(PHI*180/pi,2),align->"right");  //220208to
  ); // 
  if(Ptselected(TH) % Ptselected(FI), //190505
    if(length(Ch)>0,
      ChNum=Ch_(length(Ch));
      if(ChNum==0, ChNum=1);
    ,
      ChNum=1;
    );
    Ch=[0];
  );
  tmp=ptexception; //181106
  if(!islist(tmp),tmp=[tmp]);  //190209
  PTEXCEPTION=concat(PTEXCEPTION,tmp); //190209 
  Ptseg3data(PTEXCEPTION);//16.08.23
  FuncListC=[]; //220126[2lines]
  SurfList=[];
  LenAddSurf=0; //220202
);
Slider(ptstr,p1,p2):=Slider(ptstr,p1,p2,[]);
Slider(ptstr,p1,p2,options):=(//190120
  regional(pA,pB,pC,color,thick,sep,tmp,tmp1,tmp2);
  color="Color=0.6*[0,0,1]"; //190120from
  thick="size->2";
  sep=0.3; //190824
  forall(options,
    tmp=Toupper(substring(#,0,1));
    if(tmp=="C",
      color=#;
    );
    if(tmp=="T",
      tmp=Strsplit(#,"=");
      thick="size->"+tmp_2;
    );
    if(tmp=="S",//190824from
      tmp=Strsplit(#,"=");
      sep=parse(tmp_2);
    ); //190824to
  );
  tmp=Indexall(ptstr,"-");
  if(length(tmp)>0,
    pA=substring(ptstr,0,tmp_1-1); //190824from
    pC=substring(ptstr,tmp_1,tmp_2-1);
    pB=substring(ptstr,tmp_2,length(ptstr));
    parse(pA).xy=p1;
    parse(pB).xy=p2; //190824to
    tmp1=pC+"position"; //190827from
    if(!islist(parse(tmp1)),
      tmp2=parse(pC).xy;
      if(|tmp2-p1|<0.1,tmp2=p1+0.1*(p2-p1)/|p2-p1|);
      if(|tmp2-p2|<0.1,tmp2=p2+0.1*(p1-p2)/|p1-p2|);
      tmp=tmp1+"="+textformat(tmp2,10)+";";
      parse(tmp);
      parse(pC).xy=tmp2;
    ); //190827to
    PTEXCEPTION=concat(TEXCEPTION,[pA,pC,pB]);
  ,
    pC=ptstr; pA=pC+"l"; pB=pC+"r"; 
    PTEXCEPTION=concat(PTEXCEPTION,[pC]);
  );
  Listplot(pA+pB,[p1,p2],["Msg=n","notex",color,thick]);
  Putonseg(pC,parse("sg"+pA+pB));
);
Putonseg(name,sgstr):=(
  regional(seg,p1,p2);
  if(isstring(sgstr),seg=parse(sgstr),seg=sgstr);
  Putonseg(name,LLcrd(seg_1),LLcrd(seg_2));
);
Putonseg(name,p1,p2):=Putonseg(name,p1,p2,[]);
Putonseg(name,p1org,p2org,options):=(
  regional(Eps,par,p1,p2,dx,dy,p,tmp,tmp1,tmp2);
  Eps=10^(-5);
  par=0.5;
  tmp=Divoptions(options);
  if(length(tmp_6)>0,
    par=tmp_6_1;
  );
  p1=Lcrd(p1org);//16.10.11from
  p2=Lcrd(p2org);
  p1=Pcrd(p1); p2=Pcrd(p2); //190120
  dx=p2_1-p1_1;
  dy=p2_2-p1_2;
  p=parse(name+".xy");
  if(abs(dx)>abs(dy), //190120from
    if(p1_1>p2_1,tmp=p1;p1=p2;p2=tmp);
    if(p_1<p1_1,parse(name+".xy="+Textformat(p1,10));p=p1);
    if(p_1>p2_1,parse(name+".xy="+Textformat(p2,10));p=p2);
    tmp=(p2_2-p1_2)/(p2_1-p1_1)*(p_1-p1_1)+p1_2;
    parse(name+".y="+tmp+";"); //190415
  ,
    if(p1_2>p2_2,tmp=p1;p1=p2;p2=tmp);
    if(p_2<p1_2,parse(name+".xy="+Textformat(p1,10));p=p1);
    if(p_2>p2_2,parse(name+".xy="+Textformat(p2,10));p=p2);
    tmp=(p2_1-p1_1)/(p2_2-p1_2)*(p_2-p1_2)+p1_1;
    parse(name+".x="+tmp+";"); //190415
  ); //190120to
);
Sprintf(value,dig):=(
  regional(vv,tmp,tmp1);
  if(!islist(value),  // 17.03.12from
    if(isstring(value),
      vv=value;
    ,
      vv=Textformat(value,dig);
    );  // 17.03.12from
    if(indexof(vv,".")==0,vv=vv+".");
    vv=vv+"0000000000000000";
    tmp=indexof(vv,".")+dig;
    vv=substring(vv,0,tmp);
  ,
    vv=apply(value,Sprintf(#,dig));
  );
  vv;
);
Ptselected():=Ptselected(allpoints()); //190805
Ptselected(ptlistorg):=(
 regional(ptlist,flg,Eps);
 Eps=(XMAX-XMIN)/10; //190505
 flg=0;
 ptlist=ptlistorg; //190505[2lines]
 if(!islist(ptlist),ptlist=[ptlist]);
 forall(ptlist,
  if(flg==0,
    if(|mouse().xy-#.xy|<Eps,flg=1); // 
  );
 );
 if(flg==0,false,true);
);
Ptseg3data():=Ptseg3data([]);
Ptseg3data(options):=(
  regional(pt,ptz,pt3,plist,plistz,tmp,tmp1,tmp2);
  tmp=remove(allpoints(),options);
  tmp=remove(tmp,[SW,NE,TH,FI]);
  plist=select(tmp,indexof(#.name,"z")==0);
  plistz=select(tmp,indexof(#.name,"z")>0);
  if(Ptselected(TH) % Ptselected(FI),
    forall(plist,pt,
      tmp=select(plistz,#.name==pt.name+"z");
      if(length(tmp)>0,
        ptz=tmp_1;
      ,
        ptz=[];
      );
      tmp=select(VLIST,#_1==pt.name+"3d"); //190506
      if(length(tmp)>0,
        pt3=tmp_1_2;
        pt.xy=Parapt(pt3);
        ptz.xy=Parasubpt(pt3);
      ,
        pt3=Mainsubpt3d(pt.xy,ptz.xy); //181107[2lines]
        Defvar(pt+"3d",pt3);
      );
    );
  ,
    Mkpointlist(options); // 16.12.18
  );
);
Mkpointlist():=Mkpointlist([]); //16.11.12
Mkpointlist(options):=( //181030
  regional(Eps,dp,mv,pos,worklist,plist,pt,ptstr,pt3,ptz,par,
     tmp,tmp1,tmp2,tmp3,tmp4,p1,p2,flg);
  dp=pi/24;
  mv=NE.x-SW.x;
  Eps=10^(-4);
  pos=[NE.x+1,NE.y+0.1];
  worklist=Workprocess(); //181030
  plist=select(worklist,length(#_3)!=2);
  plist=apply(plist,#_1);
  plist=remove(plist,PTEXCEPTION);
  tmp=apply(VLIST,#_1);//181029from
  tmp=select(tmp,indexof(#,"3d")>0);
  tmp2=apply(tmp,replace(#,"3d",""));
  forall(tmp2,ptstr,
    if(!contains(plist,ptstr),
      tmp=select(VLIST,
            (#_1==pt+"3d")%(#_1==pt+"2d")%(#_1==pt+"fix"));
      VLIST=remove(VLIST,tmp);
    );
  ); //181029to
  if(SUBSCR==0,plist=[]);
  forall(plist,ptstr,
    pt=parse(ptstr);
    inspect(pt,"ptsize",3);
    inspect(pt,"color",2);
    inspect(pt,"textsize",TSIZE);
    ptz=pt.name+"z";  //190505
    tmp=Finddef(pt);
    tmp=select(VLIST,#_1==pt.name+"3d"); //190505
    if(length(tmp)==0,
      tmp=parse(ptz); //181108from
      if(ispoint(tmp),
        pt3=Mainsubpt3d(pt.xy,tmp.xy); //181108to
      ,
        if(abs(cos(THETA))>Eps,//181028from
          tmp1=Mainsubpt3d(pt.xy,0); 
          tmp=Parasubpt(tmp1);
          Putpoint(ptz,tmp,[tmp_1,parse(ptz+".y")]);
          pt3=Mainsubpt3d(pt.xy,parse(ptz+".xy"));
        ,
          if(abs(sin(PHI))>abs(cos(PHI)), //181029from
            tmp=Parasubpt([-pt.x/sin(PHI),0,pt.y]);
          ,
            tmp=Parasubpt([0,pt.x/cos(PHI),pt.y]);
          );
          Putpoint(ptz,tmp,[parse(ptz+".x"),pt.y]);//181029
          pt3=Mainsubpt3d(pt.xy,parse(ptz+".xy"));
        );
      ); //181028to
      Defvar(pt.name+"3d",pt3); //190505
      Defvar(pt.name+"fix",0); //190505
    );
    flg=0;
    if(isstring(ptz),ptz=parse(ptz));//181029from
    inspect(ptz,"ptsize",3);
    inspect(ptz,"color",3);
    inspect(ptz,"textsize",TSIZEZ);//181029to
    if(Ptselected(pt),
      if(parse(pt.name+"fix")!=1, //190505
        tmp=select(VLIST,#_1==pt.name+"3d"); //190505
        tmp1=tmp_1_2;
        pt3=Mainsubpt3d(pt.xy,ptz.xy); //181029
        Putpoint(ptz.name,Parasubpt(pt3));
        if(Norm(tmp1-pt3)>Eps,
           Defvar(pt.name+"3d",pt3); //190505
        );
        flg=1;
      );
    );
    if(Ptselected(ptz),//181108from
      tmp=select(VLIST,#_1==pt.name+"3d");  //190505
      tmp1=tmp_1_2;
      tmp=Parasubpt(tmp1); //181108from
      if(abs(cos(THETA))>Eps,
        tmp=ptz.name+".x="+format(tmp_1,10)+";"; //210112
        parse(tmp);
        tmp=Parapt([tmp1_1,tmp1_2,ptz.y]);
        Putpoint(pt.name,tmp); //190505
     ,
        tmp=ptz.name+".y="+format(tmp_2,10)+";";  //190505
        parse(tmp);
        if(abs(sin(PHI+dp))>abs(cos(PHI+dp)), //181108
          tmp=-(ptz.x-mv-tmp1_2*cos(PHI+dp))/sin(PHI+dp);
          tmp=Parapt([tmp,tmp1_2,tmp1_3]);
        ,
          tmp=(ptz.x-mv+tmp1_1*sin(PHI+dp))/cos(PHI+dp); //181109pm
          tmp=Parapt([tmp1_1,tmp,tmp1_3]);
        );
        Putpoint(pt.name,tmp); //190505
      );
      pt3=Mainsubpt3d(pt.xy,ptz.xy); 
      Defvar(pt.name+"3d",pt3); //190505
      flg=2;
    );
    if(Ptselected(TH) % Ptselected(FI), //181029
      tmp=select(VLIST,#_1==pt.name+"3d"); //190505
      if(length(tmp)>0, //17.10.07
        tmp1=Parapt(tmp_1_2);
        Putpoint(pt.name,tmp1);  //190505
        tmp2=Parasubpt(tmp_1_2);//181027[2lines]
        Putpoint(ptz.name,tmp2);  //190505
        flg=3;
      ); //17.10.07
    );
    if(flg==0, //181030from
      pt3=Mainsubpt3d(pt.xy,ptz.xy);
      Defvar(pt.name+"3d",pt3); //190505
    ); //181030to
    if(Ptselected(pt) % Ptselected(ptz),
    );
    if(!contains(["p","q"],pt.name), //190505
      ptL=append(ptL,pt);
    );
  );
);
Workprocess():=Drawprocess(300,["Disp=n"]); //181030
Workprocess(nn):=(
  Drawprocess(nn,["Disp=n"]); 
);
Drawprocess():=Drawprocess(300,["Disp=y"]);
Drawprocess(nn):=Drawprocess(nn,["Disp=y"]);
Drawprocess(nn,options):=(
  regional(All,added,remain,out,flg,dispflg,eqL,tmp,tmp1,tmp2);
  tmp=Divoptions(options); //181030from
  eqL=tmp_5;
  dispflg="Y";
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1));
    tmp2=Toupper(substring(tmp_2,0,1));
    if(tmp1=="D",dispflg=tmp2);
  ); //181030to
  tmp=remove(allpoints(),[NE,SW,TH,FI]);
  tmp1=select(tmp,
    substring(#.name,length(#.name)-1,length(#.name))!="z"); //190505
  tmp1=concat(tmp1,alllines());
  All=apply(tmp1,Dependgeo(#));
  added=select(All,length(#_3)==0);
  out=sort(apply(added,#_1));
  remain=remove(All,added);
  flg=0;
  repeat(nn,
    if(flg==0,
      tmp1=select(remain,remove(#_3,out)==[]);
      tmp2=sort(apply(tmp1,#_1));
      out=concat(out,tmp2);
      remain=remove(remain,tmp1);
      if(length(remain)==0,flg=1);
    );
  );
  if(dispflg=="Y",
    println("Process of drawing");
  );
  tmp1=[];//181030from
  forall(out,
    tmp=Dependgeo(parse(#));
    tmp1=append(tmp1,tmp);
    if(dispflg=="Y",
      println(Dependgeo(parse(#)));
    );
  );
  tmp1;//181030to
);
Dependgeo(geo):=(
  regional(tmp,tmp1,tmp2,out);
  tmp=Finddef(geo);
  if(!iscircle(geo),
    out=[geo.name]; //190505
  ,
    out=[geo];
  );
  if(length(tmp)<3,
    out=concat(out,[tmp_1,[]]);
  ,
    out=concat(out,[tmp_1]);
    tmp1=[tmp_2,tmp_3];
    tmp=parse(tmp1_2);
    if(islist(tmp) % isreal(tmp),
      tmp1=[tmp1_1];
    );
    out=append(out,tmp1);
  );
  out;
);
Finddef(G):=(
  regional(def,tmp,tmp1,tmp2,tmp3);
  if(isstring(G),tmp=parse(G),tmp=G);
  def=text(inspect(tmp,"definition"));
  tmp1=indexof(def,"(");
  tmp2=indexof(def,";");
  tmp3=indexof(def,")");
  tmp=[substring(def,0,tmp1-1)];
  if(tmp2>0,
    tmp=append(tmp,substring(def,tmp1,tmp2-1));
    if(indexof(def,")",tmp3+1)==0,
      tmp=append(tmp,substring(def,tmp2,tmp3-1));
    ,
      tmp=append(tmp,substring(def,tmp2,tmp3));
    );
  ,
    tmp=append(tmp,substring(def,tmp1-1,tmp3));
  );
  tmp;
);
Textedit(no):=(
  regional(tmp,tmp1,tmp2);
  tmp="Text"+text(no)+".currenttext";
  tmp1=parse(tmp);
  tmp1;
);
Textedit(n0,str):=Textedit(n0,str,"="); //210406from
Textedit(n0,str,sep):=( //210208from
  regional(tmp,tmp1,tmp2,out);
  tmp1=str;
tmp1=Textedit(n0); //
  tmp2=tmp1;
  if(length(sep)>0,
    tmp=Strsplit(sep+tmp1,sep);
    tmp2=tmp_(-1);
  ); //210406to
  if(length(tmp2)==0,out=str,out=tmp2);
  out;
); //210208to
Subsedit(no,str):=(
 regional(tmp,tmp1);
 if(isstring(str),
   tmp1=str;
 ,
   tmp1=text(str);
 );
 tmp="Text"+text(no); //210211[2lines]
 parse(tmp).currenttext=tmp1;
);
Xyzax3data(nm,Xrange,Yrange,Zrange):=
          Xyzax3data(nm,Xrange,Yrange,Zrange,[]);
Xyzax3data(nm,Xrange,Yrange,Zrange,optionorg):=(
  regional(name2,name3,Out,tmp,tmp1,tmp2,ops,eqL,reL,strL,msgflg,
    options,opstr,opcindy,Ltype,Noflg,Axname,Arrow,Origin,color,color4);
  name2="ax2d"+nm;
  name3="ax3d"+nm;
  options=optionorg;
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  eqL=tmp_5;
  reL=tmp_6;
  strL=tmp_7;
  color=tmp_(length(tmp)-2);color4=Colorrgb2cmyk(color); //200626
  opcindy=tmp_(length(tmp));
  Axname=1;
  Arrow=[];  // 190505
  Origin=""; // 16.08.14
  if(length(reL)>0,
    Axname=reL_1;
  );
  forall(strL,  // 16.08.14from
    tmp1=Toupper(substring(#,0,1));
    if(tmp1=="A",
      tmp=substring(#,1,length(#));
      if(length(tmp)>0,
        Arrow=tokenize(tmp,","); //190505
        if(length(Arrow)==1,Arrow=append(Arrow,18));
      );
    );
    if(tmp1=="O",
      tmp=indexof(#,",");
      if(tmp>0,
        Origin=substring(#,tmp,length(#));
      ,
        tmp=substring(#,1,length(#));
        if(length(tmp)>0,
          Origin=tmp;
        ,
          Origin="sw";
        );
      );
    );
  ); // 16.08.14to
  options=remove(options,reL);
  options=remove(options,strL);
  msgflg="Y";  //190506from
msgflg="N";  //
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1));
    if(tmp1=="M",
      msgflg=Toupper(substring(tmp_2,0,1));
      options=remove(options,[#]);
    );
  ); //190506to
  tmp1=indexof(Xrange,"=");
  tmp=parse(substring(Xrange,tmp1,length(Xrange)));
  Px=[tmp_1,0,0]; Qx=[tmp_2,0,0];
  tmp1=indexof(Yrange,"=");
  tmp=parse(substring(Yrange,tmp1,length(Yrange)));
  Py=[0,tmp_1,0]; Qy=[0,tmp_2,0];
  tmp1=indexof(Zrange,"=");
  tmp=parse(substring(Zrange,tmp1,length(Zrange)));
  Pz=[0,0,tmp_1]; Qz=[0,0,tmp_2];
  tmp=["nodisp","Msg=n"];
  Spaceline("-axx3d"+nm,[Px,Qx],tmp);
  Spaceline("-axy3d"+nm,[Py,Qy],tmp);
  Spaceline("-axz3d"+nm,[Pz,Qz],tmp);
  Out=[[Px,Qx],[Py,Qy],[Pz,Qz]];
  if(Axname>0,
    Xyzaxparaname(Xrange,Yrange,Zrange,[Axname]);
  );
  if(Noflg<3,
    if(msgflg=="Y",
      tmp="generate axes "+name3;
      tmp=tmp+" : axx3d"+nm+",axy3d"+nm+",axz3d"+nm;
      println(tmp);
    );
    tmp="["+"axx3d"+nm+","+"axy3d"+nm+",";
    tmp=tmp+"axz3d"+nm+"]";
    tmp=name3+"="+tmp;
    parse(tmp);
    tmp1=Projpara([name3],["nodata"]);
    tmp=name2+"="+textformat(tmp1,10)+";"; //190415
    parse(tmp);
    tmp=name3+"=Xyzax3data("+
	  Dq+Xrange+Dq+","+Dq+Yrange+Dq+","+Dq+Zrange+Dq+")";
    GLIST=append(GLIST,tmp);
    tmp=name2+"=Projpara("+name3+")";
    GLIST=append(GLIST,tmp);
  );
  if(Noflg<3, //190818
    if(isstring(Ltype),
      if(color4!=KCOLOR, //180904
        Texcom("{");Com2nd("Setcolor("+color4+")");//180722
      );
	  Ltype=Getlinestyle(text(Noflg)+Ltype,name2);
      if(color4!=KCOLOR, //180904
        Texcom("}");//180722
      );
	,
      if(Noflg==1,Ltype=0);
    );
    GCLIST=append(GCLIST,[name2,Ltype,opcindy]);
    if(Noflg<1,  // 16.08.14from
      if(length(Arrow)==2, //190505from
        tmp1=Parapt(Px); tmp2=Parapt(Qx);
        ops=[Arrow_1,Arrow_2,"Line=n"];
        Arrowhead("ax1",tmp2,tmp2-tmp1,ops); //210521
        tmp1=Parapt(Py); tmp2=Parapt(Qy);
        Arrowhead("ax2",tmp2,tmp2-tmp1,ops); //210521
        tmp1=Parapt(Pz); tmp2=Parapt(Qz);
        Arrowhead("ax3",tmp2,tmp2-tmp1,ops); //210521
      ); //190505to
      if(length(Origin)>0,
        Letter([Parapt([0,0,0]),Origin,"O"]);
      );
    );  // 16.08.14until
    if(SUBSCR==1, //  15.02.11
      Subgraph(name3,opcindy); //181029
    );
  );
  Out;
);
Xyzaxparaname(Xrange,Yrange,Zrange):=
   Xyzaxparaname(Xrange,Yrange,Zrange,[]);
Xyzaxparaname(Xrange,Yrange,Zrange,options):=(
 regional(tmp,tmp1,tmp2,Eps,Dr,Noflg,Xname,Yname,Zname,
     px,qx,py,qy,pz,qz,ph,qh,rr,ch);
  Eps=10.0^(-6);
  Dr=0.19*1000/2.54/MilliIn;
  Noflg=0;
  forall(options,
    if(isreal(#),Dr=Dr*#);
  );
  tmp1=Strsplit(Xrange,"=");
  Xname=tmp1_1;
  tmp=parse(tmp1_2);
  px=[tmp_1,0,0]; qx=[tmp_2,0,0];
  tmp1=Strsplit(Yrange,"=");
  Yname=tmp1_1;
  tmp=parse(tmp1_2);
  py=[0,tmp_1,0]; qy=[0,tmp_2,0];
  tmp1=Strsplit(Zrange,"=");
  Zname=tmp1_1;
  tmp=parse(tmp1_2);
  pz=[0,0,tmp_1]; qz=[0,0,tmp_2];
  COM2ndlist=select(COM2ndlist,indexof(#,Dqq("$"+Xname+"$"))==0);//180608[3lines]
  COM2ndlist=select(COM2ndlist,indexof(#,Dqq("$"+Yname+"$"))==0);
  COM2ndlist=select(COM2ndlist,indexof(#,Dqq("$"+Zname+"$"))==0);
  ph=Parapt(px); qh=Parapt(qx); rr=|ph-qh|;
  if(rr>Eps,
    ch=qh+Dr/rr*(qh-ph);
    Expr(ch,"c",Xname);
  );
  ph=Parapt(py); qh=Parapt(qy); rr=|ph-qh|;
  if(rr>Eps,
    ch=qh+Dr/rr*(qh-ph);
    Expr(ch,"c",Yname);
  );
  ph=Parapt(pz); qh=Parapt(qz); rr=|ph-qh|;
  if(rr>Eps,
    ch=qh+Dr/rr*(qh-ph);
    Expr(ch,"c",Zname);
  );
);
Arrowhead(point,Houkou):=Arrowhead(point,Houkou,[]); //181018from
Arrowhead(Arg1,Arg2,Arg3):=(
  if(isstring(Arg1),
    Arrowhead(Arg1,Arg2,Arg3,[]);
  ,
    Arrowhead(text(ArrowheadNumber),Arg1,Arg2,Arg3);
  );
);
Arrowhead(nm,pointorg,directionorg,optionsorg):=(//191129remade
   regional(Eps,name,Ltype,Noflg,opstr,opcindy,color,eqL,line,direction,
         point,options,pP,Houkou,ptstr,hostr,tmp,tmp1,tmp2,list);
  Eps=10^(-4);
  name="arh"+nm; //181018
  ArrowheadNumber=ArrowheadNumber+1;
  point=Lcrd(pointorg); //210216
  direction=directionorg; //211217from
  if(isstring(direction),
    if(indexof(direction,"Invert")>0,
      tmp=parse(direction);
      direction=replace(direction,[["(",""],[")",""]]);
      Listplot("-"+direction,tmp,["nodisp"]);
    );
  ); //211217to
  options=optionsorg;
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  color=tmp_(length(tmp)-2);
  eqL=tmp_5;
  line="N";
  forall(eqL,
     tmp=Strsplit(#,"=");
     tmp1=substring(tmp_1,0,1);
     tmp2=substring(tmp_2,0,1);
     if(Toupper(tmp1)=="L",
       line=Toupper(tmp2);
       options=remove(options,[#]);
     );
  );
  list=Arrowheaddata(point,direction,options);
  if(length(point)>1, //210724from
    if(!Inwindow(point),Noflg=2);
    if(isstring(direction),
      if(|Ptend(direction)-point|<Eps,point=1);
    );
  ); //210724to
  if(Noflg<3,
    tmp=name+"="+Textformat(list,10)+";"; //210311
    parse(tmp);
    if(isstring(Ltype),
      if(line=="N",
        fillpoly(apply(list,Pcrd(#)),color->color);
        if(Noflg==0,
          if(isstring(direction), //210215,210724
            if(ispoint(point) % islist(point), //201214from
              if(|point-Ptend(direction)|<Eps,point=1);
            );  //201214to
            if(point==1, //191202from
              if(Norm(Ptend(direction)-Ptstart(direction))>Eps,
                tmp=select(GCLIST,#_1==direction); //201106from
                tmp1=tmp_1;
                tmp2=Nearestpt(list_4,direction);
                tmp2=tmp2_1; //201214[2lines]
                Partcrv("-"+direction,Ptstart(direction),tmp2,direction,["nodisp","Msg=n"]);
              ); //201106
            );
          );  //210215
          Listplot("-arh"+nm,list,["dr,0.1","Color="+text(color),"Msg=n"]);//191202
          Shade(["arh"+nm],["Color="+text(color)]);
        );
      ,
        Listplot("-arh"+nm,list_(1..3),concat(options,["Msg=n"]));
      );
   );
  );
  list; //191202
);
Arrowheaddata(point,direction):=
   Arrowheaddata(point,direction,[YaSize,YaAngle,YaPosition,YaCut]);
Arrowheaddata(point,direction,options):=( //191127remade
  regional(scaley,Eps,size,angle,segpos,cut, Houkou,hflg,Str,Ev,Nv,
       reL,pP,vec,pA,pB,pC,par,out,tmp,tmp1,tmp2);
  Eps=10^(-4);
  tmp=Divoptions(options);
  reL=tmp_6;
  size=0.2*YaSize*1/2.54*1000/MilliIn; 
  angle=YaAngle*pi/180;
  segpos=YaPosition;
  cut=YaCut;
  if(length(reL)>=1,
    size=0.2*reL_1*1/2.54*1000/MilliIn; 
  );
  if(length(reL)>=2,
    if(reL_2<2.5,angle=reL_2*YaAngle,angle=reL_2);
    angle=angle*pi/180;
  );
  if(length(reL)>=3,
    segpos=reL_3;
  );
  if(length(reL)>=4,
    cut=reL_4;
  );
  if(ispoint(point),pP=Lcrd(point),pP=point);
  hflg=0; 
  out=[];
  if(ispoint(direction),
    Houkou=direction.xy;
    hflg=2;
  );
  if(hflg==0, //191203from
    if(!isstring(direction), //191207
      if(Measuredepth(direction)==0,
        Houkou=direction;
        hflg=2;
      );
    );  //191207to
  ); //191203to
  scaley=SCALEY;
  SCALEY=1; //200114
  if(hflg==0,
    if(isstring(direction),Houkou=parse(direction),Houkou=direction);
    if(!islist(pP),
      par=1+(length(Houkou)-1)*pP; //191207
      pP=Ptcrv(par,Houkou);
      tmp=floor(tmp); //191203from
    ,
      tmp=Nearestpt(pP,Houkou);
      pP=tmp_1;
      par=tmp_2;
      tmp=floor(par); //191203to
    );
    if(tmp<length(Houkou),
      tmp1=Houkou_tmp;
      tmp2=Houkou_(tmp+1);
    ,
      tmp1=Houkou_(tmp-1);
      tmp2=Houkou_tmp;
    );
    vec=(tmp2-tmp1)/|tmp2-tmp1|;
    gG=Circledata("",[pP,size*cos(angle)],["Num=10","nodata"]);
    tmp1=Intersectcrvspp(Houkou,gG);
    if(length(tmp1)==0,
      println("Arrowhead may be too large (no intersect)");
    ,
      tmp=select(tmp1,#_2<par); //191208from
      if(length(tmp)>0,
        tmp=sort(tmp,[-#_2]);
        pC=tmp_1_1;
      ,
        if(Norm(Ptend(direction)-Ptstart(direction))>Eps,
          tmp=sort(tmp1,[#_2]);
          pC=2*pP-tmp_1_1;
        ,
          tmp=sort(tmp1,[-#_2]);
          pC=tmp_1_1;
        );
      ); //191208to
      Houkou=pP-pC;
      hflg=1;
    );
  );
  if(hflg>=1,
    Ev=-Houkou/|Houkou|;
    Nv=[-Ev_2, Ev_1];    
    pA=pP+size*cos(angle)*Ev+size*sin(angle)*Nv;
    pB=pP+size*cos(angle)*Ev-size*sin(angle)*Nv;
    if(hflg==2,
      pC=(pA+pB)/2;
    );
    pC=pC+cut*(pP-pC);
    tmp=(pP-(pA+pB)/2);
    tmp=(1-segpos)*tmp;
    pP=Translatepoint(pP,tmp);
    pA=Translatepoint(pA,tmp);
    pB=Translatepoint(pB,tmp);
    pC=Translatepoint(pC,tmp);
    SCALEY=scaley;
    out=apply([pA,pP,pB,pC,pA],LLcrd(#));
  );
  out;
);
Ptcrv(Num,Fig):=(
  regional(tmp);
  if(isstring(Fig),tmp=parse(Fig),tmp=Fig);
  tmp_Num;
);
Circledata(cenrad):=Circledata(cenrad,[]);
Circledata(para1,para2):=(
  regional(name,cenrad,options,str,n); 
  if(isstring(para1), 
    name=para1;
    cenrad=para2;
    options=[];
    ,
    cenrad=para1;
    options=para2;
    name="";// 16.10.07from
    forall(cenrad, 
       name=name+#.name;
    );// 16.10.07until
  );
  Circledata(name,cenrad,options);
);
Circledata(nm,cenrad,options):=(
  regional(name,Out,Ctr,Ptcir,ra,Num,Rg,opstr,opcindy,color,color4,Msg,
      tmp,tmp1,tmp2,Th,Ltype,Noflg,eqL,pA,pB,pC,d1,d2,Eps);  
  name="cr"+nm;
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  eqL=tmp_5;
  color=tmp_(length(tmp)-2); color4=Colorrgb2cmyk(color); //200618
  opstr=tmp_(length(tmp)-1);
  opcindy=tmp_(length(tmp));
  Num=50;
  Rg=[0,2*pi];
  Msg="Y";
 Msg="N"; //
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1));
    if(substring(#,0,1)=="N",
      Num=parse(tmp_2);
     opstr=opstr+",'"+#+"'";
    );
    if(substring(#,0,1)=="R",
      Rg=parse(tmp_2);
      opstr=opstr+",'"+#+"'";
    );
    if(tmp1=="M", //190206from
      Msg=Toupper(substring(tmp_2,0,1));
    ); //190206to
  );
  if(length(cenrad)==2,
    Ctr=Lcrd(cenrad_1);
    Ptcir=Lcrd(cenrad_2);
    if(!islist(Ptcir),  //190323from
      Ptcir=Ctr+[Ptcir,0];
    );  //190323to
    ra=dist(Ctr,Ptcir);
  ,
    Eps=10^(-1);
    pA=Lcrd(cenrad_1);
    pB=Lcrd(cenrad_2);
    pC=Lcrd(cenrad_3);
    tmp=pB-pA;
    tmp1=(tmp_2,-tmp_1);
    tmp=pC-pB;
    tmp2=(tmp_2,-tmp_1);
    d1=det([tmp1,tmp2]);
    d2=det([pC-pA,tmp2]);
    if(abs(d1)<Eps & abs(d2)>10*Eps,
      println("points are in a line");
      ra=0;
    ,
      Ctr=1/2*(pA+pB)+1/2*d2/d1*tmp1;
      ra=|pA-Ctr|;
      tmp=name+"center="+Textformat(Ctr,5)+";";
      parse(tmp);
    );
  );
  if(ra>0,
    Out=[];
    forall(0..Num,
      Th=Rg_1+#*(Rg_2-Rg_1)/Num;
      Out=append(Out,Ctr+ra*[cos(Th),sin(Th)]);
    );
  ,
    tmp=100/dist(pA,pB)*(pB-pA);
    Out=Listplot("1",[pA-tmp,pB+tmp],["nodata"]);
  );
  if(Noflg<3,
    if(Msg=="Y", //190206
      println("generate Circledata "+name);
    );
    tmp1=apply(Out,Pcrd(#));
    tmp=name+"="+Textformat(tmp1,10)+";"; //190415,210311
    parse(tmp);
  );
  if(Noflg<3, //190818
    if(isstring(Ltype),
      Ltype=Getlinestyle(text(Noflg)+Ltype,name);
    ,
      if(Noflg==1,Ltype=0);
    );
    GCLIST=append(GCLIST,[name,Ltype,opcindy]);
  );
  Out;
);
Intersectcrvspp(Gr1,Gr2):=Intersectcrvspp(Gr1,Gr2,[]);
Intersectcrvspp(Gr1,Gr2,options):=(
  regional(Out,Eps,Eps2,Eps0,Flg,Data1,Data2,
    Tmp1,Tmp2,Tmp3,Tmp,KL1,KL2,pA,pB,Ni,Nj,
    pP,pQ,rT,Flg,eqL,realL,opstr,Dif);
  Eps=10^(-6); //210730
  Eps2=0.1;
  Dif=0.05; // 2015.05.31
  Flg=0;
  Tmp1=Divoptions(options); // 
  eqL=Tmp1_5;
  realL=Tmp1_6;
  opstr=Tmp1_(length(Tmp1));
  forall(eqL,
    if(substring(#,0,1)=="D",
      Tmp1=indexof(#,"=");
      Dif=parse(substring(#,Tmp1,length(#)));
    );
  );
  Tmp1=length(realL);
  if(Tmp1>0,
    Eps=realL_1;
    if(Tmp1>1,
      Eps2=realL_2;
    );
  );
  Flg=0;
  if(isstring(Gr1),Data1=parse(Gr1),Data1=Gr1);
  if(isstring(Gr2),Data2=parse(Gr2),Data2=Gr2);
  if(Measuredepth(Data1)==2,Data1=Data1_1);
  if(Measuredepth(Data2)==2,Data2=Data2_1);
  Data1=apply(Data1,LLcrd(#));
  Data2=apply(Data2,LLcrd(#));
  if(length(Data1)==length(Data2),
    Tmp1=reverse(Data2); 
    Eps0=10^(-6);
    Tmp2=0;
    forall(1..(length(Data1)),
      Tmp2=Tmp2+abs(Data1_#-Data2_#);
    );
    Tmp3=0;
    forall(1..(length(Data1)),
      Tmp3=Tmp3+abs(Data1_#-Tmp1_#);
    );
    if(Tmp2<Eps0 % Tmp3<Eps0,
      Out=[];
      Flg=1;
    );
  );
  if(Flg==0,
    KL1=[];
    KL2=[];
    forall(1..(length(Data1)-1),Ni,
      pA=Data1_Ni;
      pB=Data1_(Ni+1);
      forall(1..(length(Data2)-1),
        pP=Data2_#; pQ=Data2_(#+1);
        Tmp=Koutenseg(pA,pB,pP,pQ,[Eps,Eps2]);
        if(Tmp!=["inf","inf"],
          if(Tmp_3==0,
            Tmp1=[Tmp_1,Tmp_2,Ni,#];
            KL1=concat(KL1,[Tmp1]);
          ,
            Tmp2=[Tmp_1,Tmp_2,Ni,#];
            KL2=concat(KL2,[Tmp2]);
          );
        );
      );
    );
    Out=[];
    if(length(KL1)>0,
      Tmp=KL1_1;
      pP=Tmp_1;
      rT=Tmp_2;
      Ni=Tmp_3;
      Nj=Tmp_4;
      Tmp=[pP,Ni+rT,Nj];
      Out=[Tmp];
    );
    forall(2..(length(KL1)),Ni, 
      Tmp=KL1_Ni; 
      pP=Tmp_1;
      Tmp2=0;
      Flg=0;
      forall(1..(length(Out)),Nj,
        if(Flg==0,
          Tmp=Out_Nj;
          if(|pP-Tmp_1|<Eps,
            Tmp2=1;
            Flg=1;
          );
        );
      );
      if(Tmp2==0,
        Tmp=KL1_Ni; 
        pP=Tmp_1;
        rT=Tmp_2;
        Tmp1=Tmp_3;
        Tmp2=Tmp_4;
        Tmp=[pP,Tmp1+rT,Tmp2];
        Out=concat(Out,[Tmp]);
      );
    );
    forall(1..(length(KL2)),Ni,
      Tmp=KL2_Ni;  // 15.11.21 Usui
      pP=Tmp_1; 
      Tmp2=0;
      Flg=0;
      forall(1..(length(Out)),Nj,
        if(Flg==0,
          Tmp=Out_Nj;
          if(|pP-Tmp_1|<Eps,
            Tmp2=1;
            Flg=1;
          );
        );
      );
      if(Tmp2==0,
        Tmp=KL2_Ni;
        rT=Tmp_2;
        rT=min([max([rT,0]),1]);  // 15.11.21 Usui
        Tmp=[pP,Tmp_3+rT,Tmp_4];
        Out=concat(Out,[Tmp]);
      );
    );
  );
  Tmp1=Out;  // 15.04.06 from
  Out=[];
  forall(Tmp1,Tmp2,
    Tmp3=select(1..(length(Out)),//16.11.27,
        |Out_#_1-Tmp2_1|<Dif & |Out_#_2-Tmp2_2|<=1& |Out_#_3-Tmp2_3|<=1);
    if(length(Tmp3)==0,
      Out=append(Out,Tmp2);
    ,
      forall(Tmp3, //16.11.27
        Out_#_1=(Out_#_1+Tmp2_1)/2;//17.04.14
      );
    );
  ); // 15.04.06 until
  Out;
);
Koutenseg(pA,pB,pC,pD):=Koutenseg(pA,pB,pC,pD,[]);
Koutenseg(pA,pB,pC,pD,options):=(
  regional(Eps0,Eps,Eps2,pV,Sv2,Out,pP,pQ,Flg,p1,p2,q1,q2,
          em1,eM1,em2,eM2,rT,Tmp1,Tmp2);
  Eps0=10^(-4);
  pV=pB-pA;
  Sv2=|pV|;
  pP=pC-pA; pQ=pD-pA;
  Eps=10^(-3);
  Eps2=0.2;
  Tmp1=0;
  forall(options,
    if(Tmp1==0,
      Eps=#;
      Tmp1=1;
    ,
      Eps2=#;
    );
  );
  Flg=0;
  if(Sv2<10^(-3),
     Out=["inf","inf"];
     Flg=1;
  );
  if(Flg==0,
    Eps=min([Eps2,Eps/Sv2]);
    p1=pP*pV/Sv2^2;
    p2=[pP_2,-pP_1]*pV/Sv2^2;
    q1=pQ*pV/Sv2^2;
    q2=[pQ_2,-pQ_1]*pV/Sv2^2;
    em1=-Eps; eM1=1+Eps;
    em2=-Eps; eM2=Eps;
    if(max([p1,q1])<em1 % min([p1,q1])>eM1,
      Out=["inf","inf"];
      Flg=1;
    );
    if(max([p2,q2])<em2 % min([p2,q2])>eM2,
      Out=["inf","inf"];
      Flg=1;
    );
  );
  if(Flg==0 & p2*q2<0,
    rT=p1-(q1-p1)/(q2-p2)*p2;
    if(rT>em1 & rT<eM1,
      if(rT>-Eps0 & rT<1+Eps0,
        Tmp1=pA+rT*pV;
        Tmp2=min([max([rT,0]),1]);
        Out=[Tmp1,Tmp2,0];
      ,
        Tmp1=pA+rT*pV;
        Tmp2=min([max([rT,0]),1]);
        Out=[Tmp1,Tmp2,1];
      );
      Flg=1;
    );
    if(Flg==0 & (p1<em1 % p1>eM1 % p2<em2 % p2>eM2),
      if(q1<em1 % q1>eM1 % q2<em2 % q2>eM2,
         Out=["inf","inf"];
         Flg=1;
      );
      if(Flg==0,
        rT=min([max([p1,0]),1]);
        Tmp1=pA+rT*pV;
        Out=[Tmp1,rT,1];
        Flg=1;
      );
    );
  );
  if(Flg==0 & (p1 > -Eps0 & p1 < 1 + Eps0 & p2 > -Eps0 & p2 < Eps0),
    rT= p1;
    Tmp1=pA+rT*pV;
    Out= [Tmp1, rT, 0];
    Flg=1;
  );
  if(Flg==0 & (q1 > -Eps0 & q1 < 1 + Eps0 & q2 > -Eps0 & q2 < Eps0),
    rT= q1;
    Tmp1=pA+rT*pV;
    Out=[Tmp1,rT,0];
    Flg=1;
  );
  if(Flg==0 & (p1<em1 %  p1>eM1 % p2<em2 % p2>eM2),
    if(q1<em1 % q1>eM1 % q2<em2 % q2>eM2,
      Out=["inf","inf"];      
      Flg=1;
    );
    if(Flg==0,
      rT=min([max([q1,0]),1]);
      Tmp1=pA+rT*pV;
      Out=[Tmp1,rT,1];
      Flg=1;
    );
  );
  if(Flg==0 & (q1<em1 %  q1>eM1% q2<em2 % q2>eM2),
    rT=min([max([p1,0]),1]);
    Tmp1=pA+rT*pV;
    Out=[Tmp1,rT,1];
    Flg=1;
  );
  if(Flg==0,
    if(abs(p2)<abs(q2),
      rT=min([max([p1,0]),1]);
    ,
      rT=min([max([q1,0]),1]);
    );
    Tmp1=pA+rT*pV;
    Out=[Tmp1,rT,1];
  );
  if(!isstring(Out_1),Out=apply(Out,re(#))); //190802
  Out;
);
Translatepoint(point,mov):=(
  regional(X1,X2,Y1,Y2,Cx,Cy,tmp);
  tmp=Lcrd(point);
  X1=tmp_1; Y1=tmp_2;
  tmp=Lcrd(mov);
  Cx=tmp_1; Cy=tmp_2;
  X2=X1+Cx;
  Y2=Y1+Cy; 
  [X2,Y2];
);
Concatobj(objL):=( //220721
  regional(strflg,ptflg,obj,vL,vnL,fL,vctr,vadd,vtx,
       vnx,vnadd,faces,fnew,face,jj,kk,eps, tmp,tmp1,tmp2);
  if(isstring(objL_1_1),strflg=1,strflg=0);
  if(ispoint(objL_1_1),ptflg=1,ptflg=0);
  eps=10^(-4);
  vL=[];
  fL=[];
  vctr=0;
  forall(objL,obj,
    if(ptflg==1,
      tmp1=apply(obj,parse(#.name+"3d"));
      tmp2=apply(obj,#.name);
    );
    if(strflg==1,
      tmp1=apply(obj,parse(#+"3d"));
      tmp2=apply(obj,#);
    );
    if(ptflg+strflg==0,
      tmp1=obj;
      tmp2=tmp1;
    );
    if(length(tmp1)>2, 
      tmp=1..length(tmp1);
      tmp1=[tmp1,[tmp]];
    );
    vtx=tmp1_1; 
    vnx=tmp2;
    faces=tmp1_2;
    fnew=faces;
    vctr=0;
    vadd=[];
    vnadd=[];
    forall(1..length(vtx),jj,
      tmp1=vtx_jj;
      tmp2=vnx_jj;
      tmp=select(1..length(vL),dist3d(vL_#,tmp1)<eps);
      if(length(tmp)==0,
        vadd=append(vadd,tmp1);
        vnadd=append(vnadd,tmp2);
        vctr=vctr+1;
        tmp2=length(vL)+vctr;
      ,
        tmp2=tmp_1;
      );
      forall(1..length(faces),kk,
        face=faces_kk;
        tmp=select(1..length(face),face_#==jj);
        if(length(tmp)>0,
          tmp1=tmp_1;
          fnew_kk_tmp1=tmp2;
        );
      );
    );
    vL=concat(vL,vadd);
    vnL=concat(vnL,vnadd);
    fL=concat(fL,fnew);   // 16.02.11 until
  );
  tmp2=apply(1..length(fL),1);
  [vnL,fL];
);
Vertexedgeface(nm,vfnL):=Vertexedgeface(nm,vfnL,[]);  // 16.02.10
Vertexedgeface(nm,vfnLorg,optionorg):=(
  regional(name3,namev,namee,namef,vfnL,options,
  Noflg,eqL,strL, Lsize,msgflg,vfinished,objflg,
    Eps,vL,eL,enL,face,edge,vtx,vname,fixflg,
    vtxflg, edgflg,dispflg,tmp,tmp1,tmp2);
  Eps=10^(-5);
  name3="phvef"+nm;
  namev="phv3d"+nm;
  namee="phe3d"+nm;
  namef="phf3d"+nm;
  options=optionorg;
  tmp=Divoptions(options); 
  Noflg=tmp_2;
  eqL=tmp_5;
  strL=tmp_7;
  objflg="Y"; //220721
  fixflg=1;
  vtxflg="N"; //180905
  edgflg="N";
  dispflg=1; //181106
  Lsize="8"; //190331
  msgflg="Y"; //190506
 msgflg="N"; // 
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1));
    tmp2=Toupper(substring(tmp_2,0,1));
    if(tmp1=="L", //190331from
      Lsize=tmp_2;
      if(Lsize=="0",dispflg=0); //190502
      options=remove(options,[#]);
    ); //190331to
    if(tmp1=="M", //190506from
      msgflg=tmp2;
      options=remove(options,[#]);
    ); //190506to
    if(tmp1=="O", //220721from
      objflg=tmp2;
      options=remove(options,[#]);
    ); ///220721to
  );
  vfnL=vfnLorg;  // 16.06.19from
  if(objflg=="N",
    vfnL=Concatobj(vfnL);
  );  
  if(length(vfnL)>2,
    vfnL=[vfnL,[1..length(vfnL)]];
  );
  if(length(vfnL)==1,
    vfnL=[vfnL_1,[1..length(vfnL_1)]];
  );  // 16.06.19to
  vL=[];
  forall(1..length(vfnL_1),nm,
    vtx=vfnL_1_nm;  //220721from
    if(islist(vtx),
      vname="V"+nm;
      Pointdata3d(vname,vtx);
      finished=1; //220721to
    );
    if(isstring(vtx),
      tmp=indexof(vtx,"3d");
      if(tmp>0,
        vname=substring(vtx,0,tmp-1);
        vtx=parse(vtx); //160619
      ,
        vname=vtx; //220721[2lines]
        vtx=parse(vtx+"3d");
      );
      finished=1;
    );
    if(finished==0, //220714
      vtx=parse(vtx);// 16.06.19
      if(ispoint(vtx),
        tmp=parse(vtx.name+"3d"); //190506
        vname=vtx.name;
      ,
        tmp=select(allpoints(),indexof(#.name,"z")==0);
        tmp1=remove(tmp,[SW,NE,TH,FI]);
        tmp=select(tmp1,|#.xy-Parapt(vtx)|<Eps);
        if(length(tmp)>0,
          tmp=tmp_1;
          vname=tmp.name;
        ,
          vname="V"+nm+text(#); //181212
        );
        if(vtxflg=="Y",
          if(fixflg==1,
            Putpoint3d([vname,vtx],"fix");
          ,
            Putpoint3d([vname,vtx]);
          );
        , 
          tmp=vname+"3d="+format(vtx,10)+";"; //190415
          parse(tmp);
          Defvar(vname+"3d",parse(vname+"3d"));
          tmp=vname+"2d=Parapt("+vname+"3d);"; //190415
          parse(tmp);
          Defvar(vname+"2d",parse(vname+"2d"));
        ); //220714
        if(dispflg==1, //181106
          tmp="drawtext(parse(vname+"+Dqq("2d");
          tmp=tmp+"),vname,size->"+Lsize+");";
          parse(tmp); //190331
          draw(parse(vname+"2d"),
              pointsize->3,color->[0,1,0]); //190128
        );
      ); //180905to
    );
    vL=append(vL,vname); // 16.02.10to
  ); 
  eL=[];
  forall(vfnL_2,face,
    forall(1..length(face),
      tmp1=face_#;
      if(#<length(face),
        tmp2=face_(#+1);
      ,
        tmp2=face_1;
      );
      if(tmp2<tmp1,
        tmp=tmp2; tmp2=tmp1; tmp1=tmp;
      );
      tmp1=vL_tmp1+"3d";
      tmp2=vL_tmp2+"3d";
      tmp=select(eL,#==[tmp1,tmp2] % #==[tmp2,tmp1]);
      if(length(tmp)==0,
        eL=append(eL,[tmp1,tmp2]);
      );
    );
  ); 
  if(Noflg<3,
    enL=[];
    forall(eL,edge,
      if(edgflg=="N",
        if(Noflg<2,
          tmp1=parse(edge_1);
          tmp2=parse(edge_2);
          tmp=replace(edge_1+edge_2,"3d","");
          options=append(options,"Msg=no");
          Spaceline("-"+tmp,[tmp1,tmp2],options); //16.02.28
        );
        enL=append(enL,tmp+"3d"); //16.02.29
      ,
        tmp1=replace(edge_1,"3d","");
        tmp2=replace(edge_2,"3d","");
        tmp=tmp1+tmp2;
        tmp=replace(tmp,"V","v");
        create([tmp],"Segment",[parse(tmp1),parse(tmp2)]);
        enL=append(enL,tmp+"3d");//16.02.29
      );
    );
    if(Noflg<3, //190818
      if(msgflg=="Y",
        println("generate "+namev+","+namee+","+namef);
      );
    );
    tmp1="";
    forall(enL,
      tmp1=tmp1+Dq+#+Dq+",";
    );
    tmp1=substring(tmp1,0,length(tmp1)-1);
    tmp=namee+"=["+tmp1+"];"; //190415
    parse(tmp);
    tmp1=apply(vL,Dq+#+"3d"+Dq);
    tmp1=text(tmp1);
    tmp1=substring(tmp1,1,length(tmp1)-1);
    tmp=namev+"=["+tmp1+"];"; //190415
    parse(tmp);
    tmp1=Textformat(vfnL_2,10);
    tmp1=substring(tmp1,1,length(tmp1)-1);
    tmp=namef+"=["+tmp1+"];"; 
    parse(tmp);
  );
  [namev,namee,namef];
);
Nohiddenbyfaces(nm,faceL):=
    Nohiddenbyfaces(nm,Datalist3d(),faceL,[],["do"]);
Nohiddenbyfaces(nm,Arg1,Arg2):=( //190331
  regional(tmp1,tmp2,tmp3,segL,faceL,options);
  tmp1=select(Arg2,indexof(#,"=")>0); //190401from
  tmp2=select(Arg2,indexof(#,",")>0);
  tmp3=select(Arg2,length(#)<=2);
  if(length(tmp1)+length(tmp2)+length(tmp3)==0, //190401to
    segL=Arg1;
    faceL=Arg2;
    options=[];
  ,
    segL=Datalist3d();
    faceL=Arg1;
    options=Arg2;
  );
  Nohiddenbyfaces(nm,segL,faceL,options,["do"]);
);
Nohiddenbyfaces(nm,Arg1,Arg2,Arg3):=( //190413from
  if(islist(Arg1),
    Nohiddenbyfaces(nm,Arg1,Arg2,Arg3,["do"]);
  ,
    Nohiddenbyfaces(nm,Datalist3d(),Arg1,Arg2,Arg3);
  );
); //190413to
Nohiddenbyfaces(nm,segLorg,faceLorg,optionorg,optionsh):=(//190331
  regional(Eps,namen,nameh,options,segL,faceL,rng,vtxL,msgflg,
     ctr,tmp,tmp1,tmp2,tmp3,tmp4,Ltype,Noflg,eqL,color,frnL,frhL);
  namen="frn"+nm;
  nameh="frh"+nm;
  options=optionorg;
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  eqL=tmp_5;
  color=tmp_(length(tmp)-2);
  Eps=10^(-2);
  msgflg="Y";
 msgflg="N"; // 
  forall(eqL, //180815from
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1));
    if(tmp1=="E",
      Eps=parse(tmp_2);
      options=remove(options,[#]);
    );
    if(tmp1=="M", //190506from
      msgflg=Toupper(substring(tmp_2,0,1));
      options=remove(options,[#]);
    ); //190506to
  );//180815to
  tmp1=segLorg; //190331from
  if(!islist(tmp1),tmp1=[tmp1]);
  Changestyle3d(tmp1,["nodisp"]);
  segL=[];
  forall(tmp1,tmp4,  // 190401[seg=>tmp4]
    if(isstring(tmp4),
      tmp3=parse(tmp4);
      if(MeasureDepth(tmp3)==1,tmp3=[tmp3]); //190401
      tmp2=[];
      forall(tmp3,
        if(isstring(#),tmp=parse(#),tmp=#);
        tmp2=append(tmp2,tmp);
      );
    ,
      tmp2=[#];
    );
    segL=concat(segL,tmp2);
  ); 
  tmp1=faceLorg;
  if(!islist(tmp1),tmp1=[tmp1]);
  faceL=[];
  forall(tmp1,tmp4,    // 190401[face=>tmp4]
    if(isstring(tmp4),
      tmp2=parse(tmp4);
      if(indexof(tmp4,"phf")>0,
        tmp=replace(tmp4,"phf","phv");
        vtx=parse(tmp);
        vtx=apply(vtx,parse(#));
        tmp2=apply(tmp2,vtx_#);
      ,
        tmp2=[tmp2]; //190401
      );
    ,
      tmp2=tmp4;
    ); 
    faceL=concat(faceL,tmp2);
  ); //190331to
  ctr=1;
  frnL=[];
  frhL=[]; 
  forall(segL,seg,
    rng=[0,1];
    forall(faceL,face,
	  rng=Nohiddensegs(seg,rng,face,Eps);
    );
    forall(1..length(rng)/2,
      tmp=rng_(2*#-1);
      tmp1=seg_1+tmp*(seg_2-seg_1);
      tmp=rng_(2*#);
      tmp2=seg_1+tmp*(seg_2-seg_1);
      tmp=append(options,"Msg=nodisp");  // 15.06.22
      Spaceline("-"+namen+"n"+text(ctr),[tmp1,tmp2],tmp);
      frnL=append(frnL,namen+"n"+text(ctr)+"3d");
      ctr=ctr+1;
    );
    if(length(rng)==0,
      rng=[0,1];
    ,
      if(rng_1>0+Eps,
        rng=prepend(0,rng);
      ,
        rng=rng_(2..length(rng));
      );
      if(rng_(length(rng))<1-Eps,
        rng=append(rng,1);
      ,
        rng=rng_(1..(length(rng)-1));
      );
    );
    forall(1..length(rng)/2,
      tmp=rng_(2*#-1);
      tmp1=seg_1+tmp*(seg_2-seg_1);
      tmp=rng_(2*#);
      tmp2=seg_1+tmp*(seg_2-seg_1);
      tmp=select(optionsh,indexof(#,"=")>0); //180815from
	  tmp=remove(optionsh,tmp);
      if(length(tmp)==0,tmp=append(optionsh,"do")); //180815to
      tmp=append(tmp,"Msg=nodisp");  // 15.06.22
      Spaceline("-"+nameh+"n"+text(ctr),[tmp1,tmp2],tmp);
      frhL=append(frhL,nameh+"n"+text(ctr)+"3d");
      ctr=ctr+1;
    );
  );
  tmp1=apply(frnL,Dq+#+Dq);
  tmp="frn3d"+nm+"="+text(tmp1)+";"; //190415
  parse(tmp);
  tmp1=apply(frhL,Dq+#+Dq);
  tmp="frh3d"+nm+"="+text(tmp1)+";"; //190415
  parse(tmp);
  if(msgflg=="Y",
    println("generate "+"frn3d"+nm+",frh3d"+nm+""); //190331
  );
  [frnL,frhL]; //181106
);
Datalist3d():=(
  regional(out,tmp,tmp2,tmp3);
  tmp=apply(GCLIST,#_1);
  tmp=select(tmp,indexof(#,"2d")>0);
  tmp2=select(tmp,indexof(#,"sub")==0);
  tmp3=apply(tmp2,replace(#,"2d","3d"));
  out=tmp3;
);
Changestyle3d(nameL,style):=(
  regional(nmL,name,tmp,tmp1,tmp2);
  if(islist(nameL),nmL=nameL,nmL=[nameL]);
  tmp1=[];
  forall(nmL,name,
    tmp=parse(name);
    if(islist(tmp),
      if(length(tmp)>0, //211229
        if(isstring(tmp_1),
          tmp1=concat(tmp1,tmp);
        ,
          tmp1=append(tmp1,name);
        );
      );  //211229
      tmp=apply(tmp1,replace(#,"3d","2d"));
        Changestyle(tmp,style);
        tmp=apply(tmp,"sub"+#); // 15.05.24
        Changestyle(tmp,style);
    );
  );
);
Changestyle3d(nameL,style,styleh):=( //211228from
  regional(nmL,name,tmp,tmp1,tmp2,nm,nmh);
  if(islist(nameL),nmL=nameL,nmL=[nameL]);
  forall(nmL,nm,
    tmp=indexof(nm,"3d");
    nmh=substring(nm,0,tmp-1)+"h"+substring(nm,tmp-1,length(nm));
    if(length(parse(nm))>0,
      Changestyle3d(nm,style);
    );
    tmp1=select(style,indexof(#,"Color")>0);
    tmp2=select(styleh,indexof(#,"Color")>0);
    tmp=styleh;
    if(length(tmp)==0,tmp=["do"]);
    if(length(tmp2)==0,
      tmp=concat(tmp,tmp1);
    );
    if(length(parse(nmh))>0,
      Changestyle3d(nmh,tmp);
    );
  );
); //211228to
Changestyle(nameL,styleorg):=( //210422pt
  regional(nmL,name,style,Ltype,Noflg,color,color4,opcindy,
      dtlist,tmp,tmp1,tmp2,tmp3);
  style=styleorg; //191203from
  tmp=Divoptions(style);
  Ltype=tmp_1;
  Noflg=tmp_2;
  color=tmp_(length(tmp)-2);color4=Colorrgb2cmyk(color); //200626
  opcindy=tmp_(length(tmp));
  if(length(color)==4,
    color=Colorcmyk2rgb(color);
  );
  if(islist(nameL),nmL=nameL,nmL=[nameL]);
  forall(nmL,name,
    if(substring(name,0,2)=="pt",  //210422from
      tmp1=select(PointDataList,name==#_1);
      tmp1=tmp1_1;
      PointDataList=remove(PointDataList,[tmp1]);
      GCLIST=remove(GCLIST,tmp1_3);      
      COM2ndlist=remove(COM2ndlist,tmp1_5);
      tmp=replace(name,"pt","");
      Pointdata(tmp,tmp1_2,style); //210422to
    ,
      tmp=parse(name);
      if(islist(tmp),
        while(Measuredepth(tmp)>1,
          tmp=tmp_1;
        );
        if(length(tmp)==1,pttype="Y",pttype="N");
        tmp=select(GCLIST,indexof(#_1,name)>0);
        GCLIST=remove(GCLIST,tmp);
      );
      if(Noflg<3,
        if(pttype=="Y",
          tmp=select(PTSHADElist,indexof(#_1,name)>0);
          PTSHADElist=remove(PTSHADElist,tmp); 
          tmp1=apply(parse(name),#_1);
          tmp=["Color="+text(color),"Size="+ptsize,"Inside="+inside];
          Pointdata("-"+name,tmp1,tmp);
        ,
          tmp=select(1..(length(GCLIST)),GCLIST_#_1!=parse(name));//220315from
          GCLIST=GCLIST_(tmp);
          if(Noflg==2,tmp1=[name,[-1,0]]);
          if(Noflg==1,tmp1=[name,[0,1]])); //220315to
          if(Noflg==0,
            Ltype=Getlinestyle(text(Noflg)+Ltype,name); //200514[2Lines]
            tmp1=[name,Ltype]; //220315
            if(color4!=KCOLOR, //180904 
              Texcom("}");//180722
            );
          );
          if(Noflg<=3, //220315from
            tmp=select(GCLIST,[#_1,#_2]==tmp1);
            if(length(tmp)==0,
              GCLIST=append(GCLIST,append(tmp1,opcindy));
           ); //220315to
        );
      );
    );
  );  
);
Nohiddensegs(seg,range,face,Eps):=( //190331
  regional(rng,vtx,out,ra,rb,tmp,tmp1,tmp2);
  rng=range;
  out=rng;
  forall(2..(length(face)-1),vtx,
    tmp1=[face_1,face_vtx,face_(vtx+1)];
    forall(1..(length(rng)/2),
      tmp=[rng_(2*#-1),rng_(2*#)];
      out=remove(out,tmp);
      tmp2=Nohiddenseg(seg,tmp,tmp1,Eps);
      if(length(tmp2)>0,
        out=remove(out,tmp);
        out=concat(out,tmp2);
      );
    );
    tmp=sort(out);
    out=[];
    forall(1..(length(tmp)/2),
      ra=tmp_(2*#-1);
      rb=tmp_(2*#);
      if(ra<rb-Eps,
        if(length(out)==0,
          out=[ra,rb];
        ,
          if(out_(length(out))<ra-Eps,
            out=concat(out,[ra,rb]);
          ,
            out_(length(out))=rb;
          );
        );
      );
    );
    rng=out;
  );
  rng;
);
Nohiddenseg(seg,rng,triang,Eps):=(
  regional(pA3,pB3,pC3,pA,pB,pC,sg1,sg2,ss1,ss2,parL,flgL,flg1,flg2,
     veB,veC,sgnoh,sghid,added,tmp,tmp1,tmp2,tmp3,tmp4,tmp5);
  sgnoh=[0,1];
  pA3=triang_1; //180815from
  if(isstring(pA3),
    if(indexof(pA3,"3d")==0,pA3=pA3+"3d");
    pA3=parse(pA3);
  );
  pB3=triang_2;
  if(isstring(pB3),
    if(indexof(pB3,"3d")==0,pB3=pB3+"3d");
    pB3=parse(pB3);
  );
  pC3=triang_3;
  if(isstring(pC3),
    if(indexof(pC3,"3d")==0,pC3=pC3+"3d");
    pC3=parse(pC3);
  ); //180815to
  pA=Parapt(pA3);
  pB=Parapt(pB3);
  pC=Parapt(pC3);
  sg1=seg_1+rng_1*(seg_2-seg_1);
  sg2=seg_1+rng_2*(seg_2-seg_1);
  ss1=Parapt(sg1);
  ss2=Parapt(sg2);
  if(|ss2-ss1|>Eps & abs(Crossprod(pB-pA,pC-pA))>Eps,
    tmp=Intersectcrvspp([ss1,ss2],[pA,pB,pC,pA]);
    parL=apply(tmp,#_2-1);
    parL=sort(parL);
    if(length(parL)==0,
      parL=[0,1];
    ,
      if(parL_1>Eps,parL=prepend(0,parL));
      if(parL_(length(parL))<1-Eps,parL=append(parL,1));
    );
    tmp1=Crossprod(pB3-pA3,pC3-pA3);
    if(abs(Dotprod(tmp1,sg2-sg1))>Eps,
      tmp=IntersectsgpL("",[sg1,sg2],[pA3,pB3,pC3],["Screen=n"]);//181031from
      if(tmp_2&tmp_3,
        tmp1=select(parL,abs(tmp_4-#)<Eps);
        if(length(tmp1)==0,
          parL=sort(append(parL,tmp_4));
        );
      );//181031to
    );
    flgL=[];
    forall(parL,
      tmp1=sg1+#*(sg2-sg1);
      tmp=Projcoordpara(tmp1);
      tmp_3=tmp_3+1;
      tmp2=Cancoordpara(tmp);
      tmp=IntersectsgpL("",[tmp1,tmp2],[pA3,pB3,pC3],["Screen=n"]);//181031
      tmp1=Projcoordpara(tmp1);
      tmp2=Projcoordpara(tmp_1);
      flg1=0;
      if(tmp1_3<tmp2_3-Eps,flg1=-1);
      if(tmp1_3>tmp2_3+Eps,flg1=1);
      flgL=append(flgL,flg1);
    );
    sgnoh=[];
    forall(2..length(flgL),
      added=[];
      flg1=flgL_(#-1);
      flg2=flgL_#;
      if(max([flg1,flg2])==1 % flg1+flg2==0,
        added=[parL_(#-1),parL_#];
      ,
		sghid=[parL_(#-1),parL_#];
        tmp1=ss1+sghid_1*(ss2-ss1);
        tmp2=ss1+sghid_2*(ss2-ss1);
        tmp=Intersectcrvspp([tmp1,tmp2],[pA,pB,pC,pA]);
        if(length(tmp)<2,
          veB=pB-pA;
          veC=pC-pA;
          tmp3=tmp1-pA;
          tmp4=tmp2-pA;
          tmp5=Crossprod(veB,veC);
          tmp1=(tmp3_1*veC_2-tmp3_2*veC_1)/tmp5;
          tmp2=(-tmp3_1*veB_2+tmp3_2*veB_1)/tmp5;
          if(tmp1>-Eps & tmp2>-Eps & tmp1+tmp2<1+Eps,flg1=1,flg1=0);
          tmp1=(tmp4_1*veC_2-tmp4_2*veC_1)/tmp5;
          tmp2=(-tmp4_1*veB_2+tmp4_2*veB_1)/tmp5;
          if(tmp1>-Eps & tmp2>-Eps & tmp1+tmp2<1+Eps,flg2=1,flg2=0);
          if(flg1==1 & flg2==0,
            if(length(tmp)>0,
              tmp1=tmp_1_2-1;
              tmp1=sghid_1+(sghid_2-sghid_1)*tmp1;
            ,
              tmp1=sghid_1;
            );
            added=[tmp1,sghid_2];
          );
          if(flg1==0 & flg2==1,
            if(length(tmp)>0,
              tmp1=tmp_1_2-1;
              tmp1=sghid_1+(sghid_2-sghid_1)*tmp1;
            ,
              tmp1=sghid_2;
            );
            added=[sghid_1,tmp1];
          );
          if(flg1+flg2==0,
            added=sghid;
          );
        );
        if(length(tmp)==2,
          if(min([flg1,flg2])>=0,added=sghid,added=[]);
        );
      );
      if(length(added)>0,
        if(length(sgnoh)==0,
          sgnoh=added;
        ,
          if(sgnoh_(length(sgnoh))<added_1-Eps,
             sgnoh=concat(sgnoh,added);
          ,
             sgnoh=sgnoh_(1..(length(sgnoh)-1));
             sgnoh=concat(sgnoh,added_(2..length(added)));
          );
        );
      );
    );
  );
  sgnoh=apply(sgnoh,rng_1+#*(rng_2-rng_1));
  sgnoh;
);
IntersectsgpL(name,sgstr,pLstr):=
   IntersectsgpL(name,sgstr,pLstr,["ie"]);
IntersectsgpL(name,sgstr,pLstr,optionsorg):=(
  regional(options,eqL, strL,ptflg,out,pP,pQ,pA,pB,pC,pH,pK,pR,tseg,tt,ss,Eps,
    flg,scrflg,nvec,tmp,tmp1,tmp2,tmp3,tmp4);
  options=optionsorg; //181026from
  tmp1="";
  if(isstring(options),
    tmp1=options;
    options=[];
  );
  options=remove(options,["draw","Draw"]);
  tmp=Divoptions(options);
  eqL=tmp_5;
  strL=tmp_7;
  if(length(tmp1)>0,
    strL=append(strL,tmp1);
  );
  ptflg=["D","ie"];
  forall(strL,
    tmp=Toupper(substring(#,0,1));
    if(tmp=="P",
      ptflg_1="P";
    );
    if((tmp=="I")%(tmp=="E"),
      if(length(#)==1,
        ptflg_2=#+"e";
      ,
        ptflg_2=#;
      );
     );
  );
  options=remove(options,strL);
  scrflg="Y"; //181031from
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1)); //181111
    if(tmp1=="S",
      scrflg=Toupper(substring(tmp_2,0,1));
      options=remove(options,[#]);
    );
  ); //181031to
  tmp=select(options,substring(#,0,1)=="C");
  if(length(tmp)==0,options=append(options,"Color=green"));//181026to
  Eps=10^(-4);
  flg=0;
  if(!isstring(sgstr),  // 15.05.29
    pP=sgstr_1;
    pQ=sgstr_2;
  ,
    tmp=indexof(sgstr,"-");
    if(tmp>0,  // 15.05.28
      pP=parse(substring(sgstr,0,tmp-1)+"3d");
      pQ=parse(substring(sgstr,tmp,length(sgstr))+"3d");
    ,
      tmp1=parse(sgstr);
      pP=tmp1_1;
      pQ=tmp1_2;
    );
  );
  if(!isstring(pLstr),  // 16.02.02
    pA=pLstr_1;
    pB=pLstr_2;
    pC=pLstr_3;
  ,
    tmp=indexof(pLstr,"-");
    pA=parse(substring(pLstr,0,tmp-1)+"3d");
    tmp1=substring(pLstr,tmp,length(pLstr));
    tmp=indexof(tmp1,"-");
    pB=parse(substring(tmp1,0,tmp-1)+"3d");
    pC=parse(substring(tmp1,tmp,length(tmp1))+"3d");
  );
  nvec=Crossprod(pB-pA,pC-pA);
  if(abs(Dotprod(nvec,pQ-pP))>Eps,
    pH=(Reflectpoint3d(pP,[pA,pB,pC])+pP)/2; //180811[2lines]
    pK=(Reflectpoint3d(pQ,[pA,pB,pC])+pQ)/2;
    tmp1=pP-pH;
    tmp2=tmp1+pK-pQ;
    tmp=select(tmp2,abs(#)==max(apply(tmp2,abs(#))));
    tmp=select(1..3,tmp2_#==tmp_1);
    tmp=tmp_1;
    tseg=tmp1_tmp/tmp2_tmp;
    pR=(1-tseg)*pH+tseg*pK;
    tmp=Dotprod(pB-pA,pC-pA);
    tmp1=Dotprod(pB-pA,pB-pA);
    tmp2=Dotprod(pC-pA,pC-pA);
    tmp3=Dotprod(pR-pA,pB-pA);
    tmp4=Dotprod(pR-pA,pC-pA);
    ss=-(tmp*tmp4-tmp3*tmp2)/(tmp1*tmp2-tmp^2);
    tt=(tmp1*tmp4-tmp*tmp3)/(tmp1*tmp2-tmp^2);
    tmp1=(tseg>-Eps)&(tseg<1+Eps); //181027from
    tmp2=(ss>-Eps)&(ss<1+Eps)&(tt>-Eps)&(tt<1+Eps)&(ss+tt<1+Eps);//181029
    out=[pR,tmp1,tmp2,tseg,ss,tt]; //181027to
    tmp=ptflg_2;
    tmp1=(tmp1)%(substring(tmp,0,1)=="i"); //190114
    tmp2=(tmp2)%(substring(tmp,1,2)=="e");
    if(tmp1&tmp2&(scrflg=="Y"), //181031
      if(ptflg_1=="P", //181025
        Putpoint3d([name,pR],"fix");
      ,
        Drawpoint3d(pR,options);
        tmp=name; //190401from
        if(indexof(name,"3d")==0,
          tmp=name+"3d";
        );
        tmp=tmp+"="+Textformat(pR,10)+";"; //190415 
        parse(tmp); //190401to
      ); 
    );
  ,
    println("   "+sgstr+" and "+pLstr+" may be parallel");//181025to
    out=[[],false,false]; //181029
  );
  out;
);
Reflect3pt(point,vecL):=Reflectpoint3d(point,vecL);
Reflectpoint3d(point,vecL):=(
  regional(ans,v1,v2,v3,tmp,tmp1);
  if(length(vecL)==1,
    v1=vecL_1;
    ans=2*v1-point;
  );
  if(length(vecL)==2,
    v1=vecL_1;
    v2=vecL_2;
    v3=(v2-v1)/|v2-v1|;
    tmp=v1+Dotprod(point-v1,v3)*v3;
    ans=2*tmp-point;
  );
  if(length(vecL)==3,
    v1=vecL_1;
    v2=vecL_2;
    v3=vecL_3;
    tmp=Crossprod(v2-v1,v3-v1);
    tmp1=point-Dotprod(tmp,point-v1)/|tmp|^2*tmp;
    ans=2*tmp1-point;
  );
  ans;
);
Drawpoint3d(pt3):=Drawpoint3d(pt3,["Color=green"]);
Drawpoint3d(pt3,options):=(
  regional(ptL,tmp,tmp1,tmp2);
  tmp=Divoptions(options);
  opcindy=tmp_(length(tmp));
  if(Measuredepth(pt3)==0,ptL=[pt3],ptL=pt3);
  forall(ptL,
    tmp="draw("+Textformat(Parapt(#),10)+opcindy+");";
    parse(tmp);
    if(SUBSCR==1,
      tmp="draw("+Textformat(Parasubpt(#),10)+opcindy+");";
       parse(tmp);
    );
  );
);
Projcoordpara(cc):=(
  regional(tmp);
  tmp=Parapt(cc);
  [tmp_1,tmp_2,Zparapt(cc)];
);
Zparapt(cc):=(
  regional(x,y,z);
  x=cc_1; y=cc_2; z=cc_3;
  x*cos(PHI)*sin(THETA)+y*sin(PHI)*sin(THETA)+z*cos(THETA);
);
Skeletonparadata(nm):=Skeletondatacindy(nm,Datalist3d(),Datalist3d(),[]); //211010[2lines]
Skeletonparadata(nm,options):=Skeletondatacindy(nm,Datalist3d(),Datalist3d(),options); 
Skeletonparadata(nm,pltdata1,pltdata2):=Skeletondatacindy(nm,pltdata1,pltdata2);
Skeletonparadata(nm,pltdata1org,pltdata2org,options):=
    Skeletondatacindy(nm,pltdata1org,pltdata2org,options);
Skeletondatacindy(nm,pltdata1,pltdata2):=
     Skeletondatacindy(nm,pltdata1,pltdata2,[]);
Skeletondatacindy(nm,pltdata1org,pltdata2org,optionsorg):=(
  regional(Eps,Eps2,name2,name3,options,Ltype,Noflg,reL,eqL,strL,opcindy,
     Out,ObjL,Plt3L,Rr,pltdata1,pltdata2,Plt2L,ObjL,ii,Data,wdtL,
     Obj3,jj,Gd,PtD,size,tmp,tmp1,tmp2,tmp3,color,fileflg,
      mkflg,fname,fdname,varL,nn,chkL,flg); //181101
  name2="sk2d"+nm;
  name3="sk3d"+nm;
  pltdata1=[];// 16.01.31
  forall(pltdata1org,tmp1,
    if(isstring(tmp1),tmp=parse(tmp1),tmp=tmp1); //210319
    tmp=apply(tmp,if(isstring(#),parse(#),#));//210620[recoverd]
    pltdata1=append(pltdata1,tmp);
  );
  pltdata2=[];// 211104
  forall(pltdata2org,tmp1,
    if(isstring(tmp1),tmp=parse(tmp1),tmp=tmp1); //210319
    tmp=apply(tmp,if(isstring(#),parse(#),#));//210620[recoverd]
    pltdata2=append(pltdata2,tmp);
  );
  ObjL=Flattenlist(pltdata1);
  Plt3L=Flattenlist(pltdata2);
  options=optionsorg;
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  eqL=tmp_5;
  reL=tmp_6; //16.02.28 
  strL=tmp_7; //211104
  color=tmp_(length(tmp)-2);
  opcindy=tmp_(length(tmp));
  Rr=0.075*1000/2.54/MilliIn;
  fileflg="Y"; //210823
fileflg="N"; mkflg=1; //
  size=1;
  Eps2=0.05;
  Eps=10^(-3);
  tmp=apply(1..(length(Plt3L)),Projcoordcurve(Plt3L_#));
  Plt2L=Flattenlist(tmp);
  if(mkflg==1, 
    Out=[];
    forall(1..(length(ObjL)),ii,
      Obj3=ObjL_ii;
      tmp=Projcoordcurve(Obj3);
      Data=Makeskeletondata([tmp],Plt2L,Rr,Eps2);
      forall(1..(length(Data)),jj,
        Gd=Data_jj;
        if(length(Gd)>1, //220213from
          tmp=apply(1..(length(Gd)-1),Norm(Ptcrv(#,Gd)-Ptcrv(#+1,Gd)));
          tmp=max(tmp);
          if(tmp>Eps,
            PtD=[];
            forall(1..(length(Gd)),nn,
              tmp=Gd_nn;
              tmp1=Invparapt(tmp,Obj3);
              if(length(tmp1)>0,
                PtD=append(PtD,tmp1);
              );
            );
           );
          Out=append(Out,PtD);
        );  //220213to
      );
    );
    Out=select(Out,length(Projcurve(#))>0); // 16.12.19
    tmp1=apply(Out,Textformat(#,6));
    tmp=name3+"="+tmp1+";"; //190415
    parse(tmp);
    Projpara(name3,options); //220212from
    wdtL=concat(wdtL,[name3,parse(name3)]);
    Writeoutdata(fname,wdtL);//220212to
  ,
  );
  forall(pltdata1org,
    if(isstring(#),Changestyle3d(#,["nodisp"]));
  );
  println("generate skeleton :"+name3); //220116[removed from here]
  if(SUBSCR==1,
    Subgraph(name3,opcindy);
  );
);
Flattenlist(pltlist):=(
  regional(Out,nn,Dt,ii,tmp,flg);
  Out=[];
  if(Measuredepth(pltlist)==1,
    Out=[pltlist];
  ,
    forall(1..(length(pltlist)),nn,
      Dt=pltlist_nn;
      if(Measuredepth(Dt)<2,
        Out=append(Out,Dt);
      ,
        forall(1..(length(Dt)),ii,
          tmp=Flattenlist(Dt_ii);
          Out=concat(Out,tmp);
        );
      );
    );
  );
  Out;
);
Projcoordcurve(Curve):=(
  regional(SP,CP,ST,CT,Out,jj,pt,x,y,z,xz,yz,zz);
  SP=sin(PHI); CP=cos(PHI);
  ST=sin(THETA); CT=cos(THETA);
  Out=[];
  forall(1..(length(Curve)),jj,
    pt=Curve_jj;
    x=pt_1; y=pt_2; z=pt_3;
    xz=-x*SP+y*CP;
    yz=-x*CP*CT-y*SP*CT+z*ST;
    zz=x*CP*ST+y*SP*ST+z*CT;
    Out=append(Out,[xz,yz,zz]);
  );
  Out;
);
Makeskeletondata(Obj2L,Plt2L,R0,Eps2):=(
  regional(Allres,Eps,Dmat,Dind,ii,Dt,nn1,nn2,Nind,Nobj,
      Plt2,PhL,ClipL,ns,pt1,pt2,pt,pta,ptb,za,zb,z1,z2,t1,t2,te,
	  koc,KukanL,nn,tt,Rr,Flg,ii,jj,ptq,hh,Ku,Res,contflg,breakflg);
  Eps=10.0^(-4);
  Dmat=[];
  Dind=[];
  forall(1..(length(Plt2L)),ii,
    Dt=Plt2L_ii;
    nn1=length(Dmat)+1;
    Dmat=concat(Dmat,Dt);
    nn2=length(Dmat);
    Dind=append(Dind,[nn1,nn2]);
  );
  Nind=length(Dind);
  Allres=[];
  forall(1..(length(Obj2L)),Nobj,
    Plt2=Obj2L_Nobj;
    PhL=Columnlist(Plt2,1..2);
	ClipL=[];
    forall(1..(length(PhL)-1),ns,
      pt1=PhL_(ns..(ns+1));
      forall(1..(length(Dind)),ii,
        tmp=Dind_ii;
        tmp=Dmat_(Dind_ii_1..Dind_ii_2);
        pt2=Columnlist(tmp,1..2);
        koc=Intersectcrvspp(pt1,pt2,[Eps]);
        if(length(koc)>0,
          breakflg=0;
          forall(1..(length(koc)),jj,
            contflg=0;
            if(breakflg==0,
              pt=Op(1,Op(jj,koc));
              tmp=Op(2,Op(jj,koc));
              if((tmp<1+Eps) & (ns==1), 
                contflg=1;
              );    
              if(contflg==0,
                if((tmp>length(pt1)-Eps) 
                 & (ns==length(PhL)-1),
                  contflg=1;
                );
              );
              if(contflg==0,
                nn1=ns;
                nn2=Op(3,Op(jj,koc));
                tmp=Plt2_nn1;
                pta=tmp_(1..2);
                za=tmp_3;
                tmp=Plt2_(nn1+1);
                ptb=tmp_(1..2);
                zb=tmp_3;
                if(Norm(pta-ptb)<Eps,
                  contflg=1;
                );
              );
              if(contflg==0,
                t1=Norm(pta-pt)/Norm(pta-ptb);
                z1=(1-t1)*za+t1*zb;
                tmp=Dmat_(Dind_ii_1..Dind_ii_2);
                tmp1=tmp_nn2;
                pta=tmp1_(1..2);
                za=tmp1_3;
                tmp2=tmp_(nn2+1);
                ptb=tmp2_(1..2);
                zb=tmp2_3;
                if(Norm(pta-ptb)<Eps,
                  contflg=1;
                );
              );
              if(contflg==0,
                t2=Norm(pta-pt)/Norm(pta-ptb);
                z2=(1-t2)*za+t2*zb;
                if(z1<z2-Eps2,
                   if(length(ClipL)==0, 
                    tmp=1;
                  ,
                    tmp1=column(ClipL,1);
                    tmp1=apply(tmp1,#-pt_1);
                    tmp2=column(ClipL,2);
                    tmp2=apply(tmp2,#-pt_2);
                    tmp3=apply(tmp1,#^2)+apply(tmp2,#^2);
                    tmp=min(tmp3);         
                  );
                  if(tmp>Eps^2,
                    tmp1=pt1_2-pt1_1;
                    tmp2=ptb-pta;
                    tmp3=Dotprod(tmp1,tmp2);
                    tmp3=tmp3/Norm(tmp1)/Norm(tmp2);
                    tmp=1-0.5*tmp3^2;
                    tmp1=concat(pt,[nn1,t1,R0/tmp]);
                    ClipL=append(ClipL,tmp1);
                  );
                );
              );
            );
          );
        );
      );
    );
    te=length(Plt2);
    KukanL=[[1.0,te]];
    pt1=PhL;
    if(length(ClipL)>0,
      forall(1..(length(ClipL)),ii,
        tmp=ClipL_ii;
        pt=tmp_(1..2);
        nn=tmp_3;
        tt=nn+tmp_4;
        Rr=tmp_5;
        Flg=0;
        breakflg=0;
        forall(reverse(1..nn),jj,
          contflg=0;
          if(breakflg==0,
            ptq=Pointoncurve(jj,pt1);
            if(Norm(pt-ptq)<Rr,
              contflg=1;
            );
            if(contflg==0,
              Flg=jj;
              breakflg=1;
              contflg=1;
            );
          );
        );
        if(Flg==0,
          t1=1;
        ,
          t1=Flg; t2=tt;
          hh=t2-t1;
          forall(1..10,
            hh=hh*0.5;
            ptq=Pointoncurve(t1+hh,pt1);
            if(Norm(pt-ptq)<Rr,
              t2=t2-hh;
            ,
              t1=t1+hh;
            );
          );
        );
        Ku=[t1];
        Flg=0;
        breakflg=0;
        forall((nn+1)..te,jj,
          contflg=0;
          if(breakflg==0,
            ptq=Pointoncurve(jj,pt1);
            if(Norm(pt-ptq)<Rr,
              contflg=1;
            );
            if(contflg==0,
              Flg=jj;
              breakflg=1;
              contflg=1;
            );
          );
        );
        if(Flg==0,
          t2=te;
        ,
          t1=tt; t2=Flg;
          hh=t2-t1;
          forall(1..10,
            hh=hh*0.5;
            ptq=Pointoncurve(t1+hh,pt1);
            if(Norm(pt-ptq)<Rr,
              t1=t1+hh;
            ,
              t2=t2-hh;
            );
          );
        );
        Ku=append(Ku,t2);
        KukanL=Kukannozoku(Ku,KukanL);
	  );
    );
    Res=[];
    forall(1..(length(KukanL)),ii,
      tmp=KukanL_ii;
      t1=tmp_1; nn1=re(floor(t1));
      t2=tmp_2; nn2=re(floor(t2));
     PtL=[];
      if(t1-nn1<1-Eps,
        tmp=Pointoncurve(t1,pt1);
        PtL=[tmp];
      );
      forall((nn1+1)..nn2,jj,
        tmp=Pointoncurve(jj,pt1);
        PtL=append(PtL,tmp);
      );
      if(t2-nn2>Eps,
        tmp=Pointoncurve(t2,pt1);
        PtL=append(PtL,tmp);
      );
      tmp=Listplot("",PtL,["nodata"]);
      Res=append(Res,tmp);
    );
    Allres=concat(Allres,Res);
  );

  Allres;
);
Columnlist(dt,list):=( // 16.09.04
  apply(dt,#_list);
);
Kukannozoku(Jokyo,KukanL):=(
  regional(Res,Eps,nn,ii,t1,t2,Ku,Flg,contflg,tmp,tmp1);
  Eps=10^(-6);
  nn=length(KukanL);
  t1=Jokyo_1; t2=Jokyo_2;
  tmp=KukanL_1;
  t1=max(t1,tmp_1);
  tmp=KukanL_nn;
  t2=min(t2,tmp_2);
  Res=[];
  Flg=0;
  contflg=0;
  forall(1..nn,ii,
    if(contflg==0,
      Ku=KukanL_ii;
      if(Flg==0,
        if(Ku_2<t1,
          Res=append(Res,Ku);
        ,
          Flg=1;
          if(Ku_1<t1-Eps, 
            tmp=[Ku_1,t1];
            Res=append(Res,tmp);
          );
          if(Ku_2>t2+Eps,
            tmp=[t2,Ku_2];
            Res=append(Res,tmp);
          );
        );
      ,
        if(Flg==1,
          if(Ku_2<t2,
            contflg=1;
          ,
            if(contflg==0,
              Flg=2;
              if(Ku_1<t2-Eps,
                Ku=[t2,Ku_2];
              );
              Res=append(Res,Ku);
            );
          );
        ,
          if(contflg==0,
            Res=append(Res,Ku);
          );
        );
      );
    );
  );
  Res;
);
Invparapt(pt,pd):=(
  regional(tmp);
  tmp=Invparaptpp(pt,pd);
  if(length(tmp)>0, //220213from
    tmp_1;
  ,
    []
  );  //220213to
);
Invparaptpp(pt,pd):=(
  regional(Eps,fk,nfk,ph,fh,ah,bh,ak,bk,v1,v2,
    nn,s0,t2,out,tmp,tmp1,tmp2,flg);
  Eps=10^(-4);
  if(isstring(pd),
    fk=pd;
  ,
    fk=textformat(pd,10);
  );
  nfk=Numptcrv(parse(fk));
  flg=0;
  tmp=pt;
  if(length(tmp)==1,
    ph=tmp;
    fh=pd;
  ,
    fh=Projpara(fk,["nodata"]);
    if(nfk>2,
      tmp1=Nearestpt(tmp,fh);
      ph=tmp1_2;
    ,
      ah=Ptcrv(1,fh); bh=Ptcrv(2,fh);
      v1=tmp-ah; v2=bh-ah;
      tmp1=Crossprod(v1,v2);
      if(abs(tmp1)>Eps,
        println("  Not on the line");
        out=[];
        flg=1;
      ,
        ph=Dotprod(v1,v2)/|v2|^2+1;
      );
    );
  );
  if(flg==0,
    if(nfk>2,
      nn=re(floor(ph)); //190505
      s0=ph-nn;
      if(ph>Numptcrv(fh)-Eps,
        out=[Ptend(fk),Numptcrv(fh)];
        flg=1;
      );
    ,
      nn=1;
      s0=ph-1;
    );
  );
  if(flg==0,
    ak=Ptcrv(nn,fk); bk=Ptcrv(nn+1,fk);
    ah=Ptcrv(nn,fh); bh=Ptcrv(nn+1,fh);
    ph=(1-s0)*ah+a0*bh;
    t2=s0;
    pk=(1-t2)*ak+t2*bk;
    out=[pk,nn+t2];
  );
  out;
);
Writeoutdata(filename,ptlist):=Writeoutdata(filename,ptlist,[]); //211226
Writeoutdata(filename,ptlist,options):=(//211226
  regional(nn,Gname,Gdata,Str,Gstr,Gj,Pt,Flg,
      msg,tmp,tmp1,tmp2,loopend);
  msg="Y"; //211226from
  forall(options, 
    tmp=Strsplit(#,"=");
    tmp1=substring(tmp_1,0,1); tmp1=Toupper(tmp1);
    tmp2=substring(tmp_2,0,1); tmp2=Toupper(tmp2);
    if(tmp1=="M",
      msg=tmp2;;
      options=remove(options,[#]); //181030
    );
  ); //211226to
  Flg=0;
  if(isstring(ptlist_(length(ptlist))),
    Flg=1;
  );
  SCEOUTPUT = openfile(filename);
  if(Flg==0,
    loopend=length(ptlist)/2;
  ,
    loopend=length(ptlist);
  );
  Gstr="[";
  forall(1..loopend,nn,
    if(Flg==0,
      Gname=ptlist_(2*nn-1);
    ,
      Gname=ptlist_nn;
    );
    Gstr=Gstr+Gname+",";
    println(SCEOUTPUT,Gname+"//");
    if(Flg==0,
      Gdata=ptlist_(2*nn);
    ,
      Gdata=parse(Gname);
    );
    Gdata=Flattenlist(Gdata);
    if(Measuredepth(Gdata)==1,Gdata=[Gdata]);
    forall(Gdata,Gj,
      println(SCEOUTPUT,"start//");
      Str="";
      forall(Gj,Pt,
        if(length(Str)>0,
          Str=Str+","
        );
        Str=Str+"["+format(Pt_1,10)+",";
        Str=Str+format(Pt_2,10);
        if(length(Pt)<3,
          Str=Str+"]";
        ,
          Str=Str+","+format(Pt_3,10)+"]";
        );
        if(length(Str)>80,
          println(SCEOUTPUT,"["+Str+"]//");
          Str="";
        );
      );
      if(length(Str)>0,
        println(SCEOUTPUT,"["+Str+"]//");
      );
      if((nn==loopend) & (Gj==Gdata_(length(Gdata))),  
        println(SCEOUTPUT,"end////");
      ,
        println(SCEOUTPUT,"end//");
      );
    );
  );
  closefile(SCEOUTPUT);
  Gstr=substring(Gstr,0,length(Gstr)-1)+"]";
  if(Msg=="Y",
    println("writeoutdata "+filename+":"+Gstr);
  );
);
Windispg():=(
  if(ADDAXES=="1", //181215from
    Drwxy();
    ADDAXES="0";
  ); //181215to
  Windispg(GCLIST); //190125
);
Windispg(gcLorg):=( //190125
  regional(gcL,Nj,Nk,Dt,Vj,tmp,tmp1,tmp2,tmp3,tmp4,typeL,opcindy,flg);
  gcL=gcLorg; //190125from
  if(length(gcL)>0,
    if(!islist(gcL_1),gcL=[gcL]);
  ); //190125to
  gcL=select(gcL,#_2_1>=0); //190818
  gsave();
  layer(KETPIClAYER); // 210602[spell]
  forall(gcL,Nj,
    flg=0;
    if(isstring(Nj_1),
      if(Nj_2_1>4, //200716from
        parse(Nj_1);
        flg=1; 
      ,
        Dt=parse(Nj_1);
      );  //200716to
    ,
      Dt=Nj_1
    );  // 11.17
    if((flg==0)&(islist(Dt))&(length(Dt)>0),  // 12.19,12.22,200716
      tmp=Measuredepth(Dt);
      if(tmp==1,Dt=[Dt]);
      opcindy=Nj_3;
      typeL=Nj_2; //200620from
      if(isstring(typeL_2),tmp=tokenize(typeL_2,","),tmp=[typeL_2]); //200623
      typeL=prepend(typeL_1,tmp); //200620from
      if(typeL_1<0,typeL_1=0);
      tmp1=typeL_1;
      if(tmp1<10,
        forall(Dt,Nk,
          if(length(Nk)>1,
            tmp3="";
            if(indexof(opcindy,"color")==0, //190122from
              tmp=Colorcmyk2rgb(KCOLOR); //200513[2lines]
              tmp3=tmp3+",linecolor->"+text(tmp);
            );
            tmp3=tmp3+opcindy;
            if(tmp1==0,  //190126from
              if(indexof(opcindy,"size")==0, 
                tmp3=tmp3+",size->"+text(typeL_2);
              ); //190124to
              tmp="connect("+Textformat(Nk,10)+tmp3+");";//190125
              parse(tmp);
            );
            if((tmp1==1)%(tmp1==2),
              if(length(typeL)<4,typeL=append(typeL,1)); //
              if(typeL_(-1)!=1,
                tmp="linesize("+text(typeL_4)+")";
                parse(tmp);
              );
              tmp3=",dashtype->1"+tmp3;
              forall(1..(length(Nk)-1),
                tmp="draw("+Textformat([Nk_#,Nk_(#+1)],10)+tmp3+");";
                parse(tmp);
              );
              if(typeL_(-1)!=1,
                tmp="linesize(1)";
                parse(tmp);
              );  //
            );
            if(tmp1==3,
              if(typeL_3!=1,
                tmp="linesize("+text(typeL_3)+")";
                parse(tmp);
              );
              tmp3=",dashtype->3"+tmp3;
              forall(1..(length(Nk)-1),
                tmp="draw("+Textformat([Nk_#,Nk_(#+1)],10)+tmp3+");";
                parse(tmp);
              );
              if(typeL_3!=1,
                tmp="linesize(1)";
                parse(tmp);
              );
            );
          ,
            if(indexof(opcindy,"size")==0,  //190425from
              opcindy=opcindy+",size->"+text(TenSize/TenSizeInit);
            ); //190425to
            tmp="draw("+text(Nk_1)+opcindy+");"; 
            parse(tmp);
           ); //190126to
        );
      );
    );
  );
  forall(PTSHADElist, //200519from
    parse(#_2);
  ); //200519to

  grestore(); 
  layer(0);
);
Drwxy():=Drwxy(0,[]);
Drwxy(Arg):=( //190901from
  if(islist(Arg),
    Drwxy(0,Arg);
  ,
    Drwxy(Arg,[]);
  ); //190901to
);
Drwxy(add,optionsorg):=(
  regional(options,color,eqL,strL,org,xrng,yrng,ax,st,nn,size,labelsize,
  linesty,colorax,colorla,tmp,tmp1,tmp2);
  options=optionsorg;
  tmp=Divoptions(options);
  color=tmp_(length(tmp)-2);
  eqL=tmp_5;
  org=GENTEN; 
  xrng=[XMIN,XMAX];  //190103
  yrng=[YMIN,YMAX];  //190103
  ax=AXSTYLE_1; //190901from
  labelsize=1.5; //210408
  forall(AXSTYLE_2,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,1));
    if(contains(["S","L"],tmp1), 
      labelsize=parse(tmp_2);
      options=remove(options,[#]);
    );
  );  //190901to
  linesty=ax_8;
  if(length(ax_9)>0, //190427
    if(isstring(ax_9),colorax=ax_9,colorax=text(ax_9));
  ,
    colorax=KCOLOR; //190427
  );
  colorax="Color="+colorax; //190427[if removed]
  if(isstring(ax_10),colorla=ax_10,colorla=text(ax_10));
  if(length(colorla)>0, //181217from
    colorla="Color="+colorla;
  ,
    if(length(colorax)>0,
      colorla=colorax;
    );
  ); //181217to
  forall(eqL,
    if(tmp1=="O", //190103from
      org=parse(tmp_2);
      options=remove(options,[#]);
    );  //190103to
    if(tmp1=="X",
      xrng=parse(tmp_2);
      options=remove(options,[#]);
    );
    if(tmp1=="Y",
      yrng=parse(tmp_2);
      options=remove(options,[#]);
    );
    if(tmp1=="A",
      tmp2=tokenize(tmp_2,",");
      st=1; nn=1;
      if(isreal(tmp2_1),
        st=2;
        nn=tmp2_1;
      );
      forall(st..(length(tmp2)),
        tmp=tmp2_#;
        if(length(tmp)>0,ax_nn=tmp);
        nn=nn+1;
      );
      options=remove(options,[#]);
    );
  );
  options=append(options,linesty); //181216
  if(substring(ax_1,0,1)=="a",
    strL=select(options,isstring(#)); //181216
    tmp=select(strL,contains(["dr","da","do","id"],substring(#,0,2)));
    if(length(tmp)==0,options=append(options,YasenStyle));
    tmp=substring(ax_1,1,length(ax_1)); //181216[2lines]
    if(length(tmp)>0,size=parse(tmp),size=YaSize); 
    tmp1=concat(options,[size,YaAngle,YaPosition,YaCut,colorax]);//210425
    tmp=[[xrng_1,org_2],[xrng_2,org_2]];
    Arrowdataseg("axx"+text(AXCOUNT),tmp,tmp1);
    tmp=[[org_1,yrng_1],[org_1,yrng_2]];
    Arrowdataseg("axy"+text(AXCOUNT),tmp,tmp1); //190419
  ,
    tmp=[[xrng_1,org_2],[xrng_2,org_2]];
    tmp1=concat(options,[colorax,"Msg=n"]);//181216,190325
    Listplot("-axx"+text(AXCOUNT),tmp,tmp1); 
    tmp=[[org_1,yrng_1],[org_1,yrng_2]];
    Listplot("-axy"+text(AXCOUNT),tmp,tmp1); 
  );
  AXCOUNT=AXCOUNT+1;
  tmp=[colorla,"Size="+text(labelsize)]; ///210408
  Expr([[xrng_2,org_2],ax_3,ax_2],tmp); //210407from
  Expr([[org_1,yrng_2],ax_5,ax_4],tmp);
  Letter([org,ax_7,ax_6],tmp); //190901to //
  if(add==0, //190103
    Addax(0);
  );
);
Arrowdataseg(ptlist):=Arrowdataseg(ptlist,[]); //181110from
Arrowdataseg(Arg1,Arg2):=(
  regional(name);
  if(isstring(Arg1),
    Arrowdataseg(Arg1,Arg2,[]);
  ,
    name="";
    forall(Arg1,
      if(ispoint(#),
        name=name+#.name; //190505
      );
    );
    Arrowdataseg(name,Arg1,Arg2);
  );
);  //181110from
Arrowdataseg(nm,ptlistorg,optionsorg):=(
  regional(options,Ltype,Noflg,opstr,opcindy,eqL,reL,strL,color,size,lineflg,
      flg,cutend,tmp,tmp1,tmp2,pA,pB,pC,angle,segpos,cut,scaley,Ev,Nv,pP,ptlist);
  scaley=SCALEY; //190412
  SCALEY=1; //200114
  ptlist=[];
  forall(ptlistorg,
    if(ispoint(#),tmp=[#.x, #.y], tmp=[#_1,scaley*#_2]);
    ptlist=append(ptlist,tmp);
  );
  pA=ptlist_1; pB=ptlist_2;
  options=optionsorg;
  tmp=Divoptions(options);
  Ltype=tmp_1;
  Noflg=tmp_2;
  eqL=tmp_5;
  reL=tmp_6;
  strL=tmp_7;
  color=tmp_(length(tmp)-2);
  opstr=tmp_(length(tmp)-1);
  opcindy=tmp_(length(tmp));
  size=0.2*YaSize*1/2.54*1000/MilliIn; 
  angle=YaAngle*pi/180;
  segpos=YaPosition;
  cut=YaCut;
  if(length(reL)>=1,
    size=0.2*reL_1*1/2.54*1000/MilliIn; 
  );
  if(length(reL)>=2,
    if(reL_2<2.5,angle=reL_2*YaAngle,angle=reL_2);
    angle=angle*pi/180;
  );
  if(length(reL)>=3,
    segpos=reL_3;
  );
  if(length(reL)>=4,
    cut=reL_4;
  );
  options=remove(options,reL); //191202
  cutend=[0,0];//180719
  lineflg=0;
  forall(eqL,
    tmp=Strsplit(#,"=");
    tmp1=Toupper(substring(tmp_1,0,2));
    tmp2=tmp_2;
    if(tmp1=="CU",//180719from
      tmp2=replace(tmp2,"[","");
      tmp2=replace(tmp2,"]","");
      cutend=tokenize(tmp2,",");
      if(length(cutend)==1,cutend=[cutend_1,cutend_1]);
    );
    if(tmp1=="LI",//190504from
      tmp2=Toupper(substring(tmp2,0,1));
      if(tmp2=="Y",lineflg=1);
    );//190504to
  );
  tmp=pB-pA;
  tmp=tmp/|tmp|;
  pA=ptlist_1+tmp*cutend_1;
  pB=ptlist_2-tmp*cutend_2;
  pP=pA+segpos*(pB-pA);
  Ev=-1/|pB-pA|*(pB-pA); Nv=[-Ev_2, Ev_1];
  tmp1=pP+size*cos(angle)*Ev+size*sin(angle)*Nv;
  tmp2=pP+size*cos(angle)*Ev-size*sin(angle)*Nv;
  pC=pP+(1-cut)*((tmp1+tmp2)/2-pP);
  ArrowheadNumber=ArrowheadNumber+1;
  if(Noflg<2,
    if(lineflg==1,
      Listplot("-ar"+nm+"h",[tmp1,pP,tmp2],append(options,"Msg=n")); //210522
    ,
      Listplot("-ar"+nm+"h",[tmp1,pP,tmp2,pC,tmp1],["dr,0.1","Color="+color,"Msg=n"]); //210522
    fillpoly(parse("ar"+nm+"h"),color->color); // 
    );
    if(lineflg==0,
      if(segpos==1,pB=pC); //191202
    );
    Listplot("-ar"+nm,[pA,pB],[Ltype,"Color="+color,"Msg=n"]); 
  );
  SCALEY=scaley; //200114
  [LLcrd(pA),LLcrd(pB)];
);
Ketcindyjsfigure=0;
Ketcindyjsscale=1;

setdirectory(Dircdy);



ch=0;
funflg=0;
texflg=0;
capflg=0;
initflg=1;
initpos=4;
StrL=apply(1..8,"");
BoxL=apply(1..8,#);
strnow="";
npos=0;

Modifyfortex(str):=(
  regional(rep1L,rep2L,nn,tmp,tmp1,out);
  rep1L=["(sp)","(cross)","(cdot)","(deg)","(circ)","(neq)",
         "(geq)","(leq)","(pm)","(mp)","(inf)"];
  rep2L=["\;","{\times}","{\cdot}","^{\circ}","\circ","{\neq}",
         "{\geq}","{\leq}","{\pm}","{\mp}","{\infty}"];
  out=str;
  forall(1..(length(rep1L)),nn,
    out=replace(out,rep1L_nn,rep2L_nn);
  );
  out;
);

Extractvar(strorg):=Extractvar(strorg,",");
Extractvar(strorg,mark):=(
  regional(out,parL,str,cma,nc,first,last,
     tmp,tmp1,tmp2);
  str=strorg;
  out=[];
  first=0; last=0;
  parL=Bracket(str,"()");
  tmp1=select(parL,#_2==1);
  tmp2=select(parL,#_2==-1);
  if(length(tmp1)*length(tmp2)>0,
    first=tmp1_1_1;
    last=tmp2_1_1;
    str=substring(str,0,last);
    cma=Indexall(str,mark);
    parL=select(parL,#_1<=last);
    if(length(cma)==0,
      out=[substring(str,first,last-1)];
    ,
      tmp1=first;
      forall(1..(length(cma)),nc,
        tmp=select(parL,#_1<cma_nc);
        tmp=tmp_(-1)_2;
        if(tmp>0,tmp=tmp,tmp=-tmp-1);
        if(tmp==1,
          tmp2=cma_(nc)-1;
          out=append(out,substring(str,tmp1,tmp2));
          tmp1=tmp2+1;
          if(nc==length(cma),
            out=append(out,substring(str,tmp1,length(str)-1));
          );
        );
      );
    );
  );
  [first,last,out];
);

Replacematdet(str):=(
  regional(sym,out,rest,ctr,eL,np,nc,tmp,tmp1,tmp2,tmp3);
  out=str;
  forall(["mat(","det(","case("],sym,  //210902 case
    tmp=indexof(out,sym);
    ctr=0;
    while((tmp>0)&(ctr<20),
      rest=substring(out,tmp-1,length(out));
      out=substring(out,0,tmp-1);
      tmp1=Bracket(rest,"()");
      tmp1=select(tmp1,#_2==-1);
      if(length(tmp1)>0,tmp1=tmp1_1_1,tmp1=length(rest));
      tmp2=substring(rest,0,tmp1);
      rest=substring(rest,tmp1,length(rest));
      eL=Extractvar(tmp2,";");
      tmp3=eL_3;
      forall(1..(length(tmp3)),np,
        tmp=tmp3_np;
        tmp1=Getlevel(tmp);
        tmp1=select(tmp1,#_2==0);
        tmp1=apply(tmp1,#_1);
        nc=length(tmp1)+1;
        forall(tmp1,
          tmp_#="&";
        );
        tmp3_np=tmp;
      );
      tmp2="\begin{array}{";
      forall(1..nc,tmp2=tmp2+"c");
      tmp2=tmp2+"}";
      forall(tmp3,tmp2=tmp2+#+"\\");
      tmp2=substring(tmp2,0,length(tmp2)-2);
      tmp2=tmp2+"\end{array}";
      if(sym=="mat(",
        tmp2="\left("+tmp2+"\right)";
      );
      if(sym=="det(",
        tmp2="\left|"+tmp2+"\right|";
      );
      if(sym=="case(", //210902from
        tmp2="\left\{"+tmp2+"\right.";
      );

      out=out+tmp2+rest;
      tmp=indexof(out,sym);
      ctr=ctr+1;      
    );
  );
  out;
);

Replacefun(str,name,repL):=(  //new 210604
  regional(out,sub,rest,pre,post,comL,ctr,lev,nn,
     tmp,tmp1,tmp2);
  out="";
  pre=""; post=str; sub="";
  tmp=indexof(post,name);
  ctr=1;
  while((tmp>0)&(ctr<50),
    pre=substring(post,0,tmp-1);
    sub=substring(post,tmp+length(name)-2,length(post));
    tmp1=Bracket(sub,"()");
    tmp1=select(tmp1,#_2==-1);
    tmp1=tmp1_1_1;
    post=substring(sub,tmp1,length(sub));
    sub=substring(sub,0,tmp1);
    tmp1=Bracket(sub,"()");
    tmp2=Getlevel(sub,",");
    if(length(tmp2)==0,
      if(name=="int(",
        pre=pre+"\displaystyle\int\,";
      );
    ,
      tmp2=select(tmp2,#_2==1);
      tmp2=apply(tmp2,#_1);
      tmp2=prepend(1,tmp2);
      tmp2=append(tmp2,length(sub));
      if(length(tmp2)==length(repL),
        forall(1..(length(tmp2)-1),
          tmp=substring(sub,tmp2_#,tmp2_(#+1)-1);
          if(!contains(["e^("],name),
            if(indexof(tmp,"-")+indexof(tmp,"+")>0,tmp="("+tmp+")");
          );
          pre=pre+repL_#+tmp;
        );
        pre=pre+repL_(length(tmp2));
      );
    );
    out=out+pre;
    tmp=indexof(post,name);
    ctr=ctr+1;
  );
  out=out+post;
  out;
);

Morefunction(str):=( //new 210604
  regional(out,name,repL);
  out=str;
  out=Replacematdet(out); //210606
  out;
);

Togreek(str):=(
  regional(chr,alph,Alph,grk,Grk,out,flg,tmp);
  alph="abgdezhtiklmnxprstufcqov";
  grk=["alpha","beta","gamma","delta","epsilon","zeta",
       "eta","theta","iota","kappa","lambda","mu","nu",
       "xi","pi","rho","sigma","tau","upsilon",
       "phi","chi","psi","omega","varphi"];
  Alph="GDTLPSFQO";
  Grk=["Gamma","Delta","Theta","Lambda","Pi",
       "Sigma","Phi","Psi","Omega"];
  out="";
  forall(1..(length(str)),
    chr=str_#;
    flg=0;
    tmp=indexof(alph,chr);
    if(tmp>0,
      out=out+"\"+grk_(tmp)+" ";
      flg=1;
    );
    if(flg==0,
      tmp=indexof(Alph,chr);
      if(tmp>0,
        out=out+"\"+Grk_(tmp)+" ";
        flg=1;
      );
    );
    if(flg==0,out=out+chr);
  );
  out;
);

Noascii(str):=(
  regional(ascii,out,tmp,tmp1);
  ascii=apply(32..126,unicode(text(#),base->10));
  out="";
  forall(1..(length(str)),
    tmp=Op(#,str);
    if(!contains(ascii,tmp),
      out=out+tmp;
    );
  );
  out;
);


Charstyle(str):=(
  regional(ctr,tmp,tmp1,tmp2,tmp3,out);
  out=str;
  tmp=indexof(out,"{C}");
  ctr=0;
  while((tmp>0)&(ctr<20),
    tmp3=substring(out,tmp+2,tmp+3);
    tmp3=Toupper(tmp3);
    tmp3=substring(out,0,tmp-1)+tmp3;
    out=tmp3+substring(out,tmp+3,length(out));
    tmp=indexof(out,"{C}");
    ctr=ctr+1;
  );
  tmp=indexof(out,"{G}");
  ctr=0;
  while((tmp>0)&(ctr<20),
    tmp3=substring(out,tmp+2,tmp+3);
    tmp3=Togreek(tmp3);
    tmp3=substring(out,0,tmp-1)+tmp3;
    out=tmp3+substring(out,tmp+3,length(out));
    tmp=indexof(out,"{G}");
    ctr=ctr+1;
  );
  tmp=indexof(out,"{B}");
  ctr=0;
  while((tmp>0)&(ctr<20),
    tmp3=substring(out,tmp+2,tmp+3);
    tmp3="\mathbf{"+tmp3+"}";
    tmp3=substring(out,0,tmp-1)+tmp3;
    out=tmp3+substring(out,tmp+3,length(out));
    tmp=indexof(out,"{B}");
    ctr=ctr+1;
  );
  out;
);

Addat(str):=(
  regional(ascii,out,flg,tmp);
  ascii=apply(32..126,unicode(text(#),base->10));
  ascii=remove(ascii,["@"]);
  out="";
  flg=0;
  forall(1..(length(str)),
    tmp=str_#;
    if(tmp=="@",
      flg=1-flg
    ,
      if(!contains(ascii,tmp),
        if(flg==0,
          tmp="@"+tmp+"@";
        );
      );
    );
    out=out+tmp;
  );
  out=replace(out,"@@","");
  out;
);

Sepchar(strorg):=(
  regional(str,out,flg,sharp,tctr,err,tmp,tmp1,tmp2);
  tmp1=strorg; //210907from
  str="";
  tctr=0;
  sharp=[];
  tmp=indexof(tmp1,"tx(");
  while(tmp>0,
    tctr=tctr+1;
    tmp2=substring(tmp1,0,tmp+1);
    tmp1=substring(tmp1,tmp+1,length(tmp1));
    str=str+tmp2+"(#"+text(tctr)+")";
    tmp=indexof(tmp1,")");
    tmp2=substring(tmp1,1,tmp-1);
    sharp=append(sharp,tmp2);
    tmp1=substring(tmp1,tmp,length(tmp1));
    tmp=indexof(tmp1,"tx(");
  );
  str=str+tmp1; //210907to
  str=Addat(str); 
  err="";
  out=[];
  tmp1=Indexall(str,"@");
  tmp=length(tmp1);
  if((length(str)==0)%(tmp==0)%(mod(tmp,2)==1),
    if((length(str)==0)%(tmp==0),
      if(length(str)==0,out=[],out=[str]);
    ,
      err="@";
    );
  ,
    tmp=tmp1_1;
    if(tmp>1,
      out=[substring(str,0,tmp-1)];
    );
    start=tmp;
    flg=1;
    forall(2..(length(tmp1)),
      if(flg==1,
        tmp2=substring(str,start-1,tmp1_#-1);
      ,
        tmp2=substring(str,start,tmp1_#-1);
      );
      out=append(out,tmp2);
      start=tmp1_#;
      flg=1-flg;
    );
    if(start<length(str),
      tmp2=substring(str,start,length(str));
      out=append(out,tmp2);
    );
  );
  forall(1..(length(sharp)),tmp,  //210907from
    out=apply(out,replace(#,"#"+tmp,sharp_tmp));
  ); //210907to
  [out,err];
);

Instr(key):=(
  regional(out,tmp,tmp1);
  if(length(key)==1,out=key);
  if(length(key)==2,
    tmp=substring(key,0,1);
    tmp1=substring(key,1,2);
    if((tmp=="L")%(tmp=="n"),
      out=tmp1;
      if(capflg==1,
        if((out>="a")&(out<="z"),
          out=Toupper(out);
        );
        capflg=0;
      );
    ,
      out=key;
    );
  );
  if(length(key)>=3,
    out=key;
    if(indexof(key,"()")>0,
      if(indexof(key,"Delete")>0,out="";Delete());
      if(indexof(key,"Allclear")>0,out="";Allclear());
    );
  );
  out;
);

Greekletter(str):=(
  regional(tmp,tmp1,tmp2,tmp3,tmp4,out,ctr);
  out=replace(str,"g r(","gr(");
  tmp2=indexof(out,"gr(");
  ctr=1;
  while((tmp2>0)&(ctr<100),
    tmp=Bracket(out,"()");
    tmp=select(tmp,(tmp2<#_1)&(#_2<0));
    tmp3=tmp_1_1;
    tmp=substring(out,tmp2+2,tmp3-1);
    tmp4=Togreek(tmp);
    tmp=substring(out,0,tmp2-1)+tmp4;
    out=tmp+substring(out,tmp3,length(out));
    tmp2=indexof(out,"gr(");
    ctr=ctr+1;
  );
  out;
);

Capitalletter(str):=(
  regional(tmp,tmp1,tmp2,tmp3,tmp4,out,ctr);
  out=replace(str,"c a(","ca(");
  tmp2=indexof(out,"ca(");
  ctr=1;
  while((tmp2>0)&(ctr<100),
    tmp=Bracket(out,"()");
    tmp=select(tmp,(tmp2<#_1)&(#_2<0));
    tmp3=tmp_1_1;
    tmp=substring(out,tmp2+2,tmp3-1);
    tmp4=Toupper(tmp);
    tmp=substring(out,0,tmp2-1)+tmp4;
    out=tmp+substring(out,tmp3,length(out));
    tmp2=indexof(out,"ca(");
    ctr=ctr+1;
  );
  out;
);

Boldletter(str):=(
  regional(tmp,tmp1,tmp2,tmp3,tmp4,out,ctr);
  out=replace(str,"b o(","bo(");
  tmp2=indexof(out,"bo(");
  ctr=1;
  while((tmp2>0)&(ctr<100),
    tmp=Bracket(out,"()");
    tmp=select(tmp,(tmp2<#_1)&(#_2<0));
    tmp3=tmp_1_1;
    tmp=substring(out,tmp2+2,tmp3-1);
    tmp4="\mathbf{"+tmp+"}";
    tmp=substring(out,0,tmp2-1)+tmp4;
    out=tmp+substring(out,tmp3,length(out));
    tmp2=indexof(out,"bo(");
    ctr=ctr+1;
  );
  out;
);

Gettexform(str):=(
  regional(err,subL,strt,tmp,tmp1,tmp2,tmp3,tmp4);
  err="";
  tmp=Sepchar(str);
  subL=tmp_1;
  err=tmp_2;
  strt="";
  forall(subL,
    if(substring(#,0,1)=="@",
      strt=strt+substring(#,1,length(#));
    ,
      tmp=#;
      tmp=replace(#," ","(sp)");
      tmp=Modifyfortex(tmp);
      tmp=Morefunction(tmp);
      tmp1=Totexform(tmp);
      tmp1=replace(tmp1,"a r r a y","array"); //210606[2lines]
      repeat(5,tmp1=replace(tmp1,"c c","cc"));
      tmp1=replace(tmp1,"c i r c","\circ");
      tmp1=Greekletter(tmp1); //210514[3lines]
      tmp1=Capitalletter(tmp1);
      tmp1=Boldletter(tmp1);
      strt=strt+"$"+tmp1+"$";
    );
  );
  strt;
);

Dispposition(pos,npos,str):=Dispposition(pos,3,npos,str);
Dispposition(pos,len,npos,str):=(
  regional(ascii,tmp,tmp1,tmp2,dp,p1,p2,p3,p4,n,ctr);
  ascii=apply(32..126,unicode(text(#),base->10));
  dp=[0,len];
  tmp=[0.1,0];
  p1=pos-tmp;  p2=pos+tmp;
  p3=p1+dp; p4=p2+dp;
  Listplot("-disp",[p1,p2,p4,p3,p1],["nodisp","Msg=n"]);
  Shade(["disp"],["Color=red"]);
  if(length(str)>0, //211109from
    n=npos;
    ctr=0;
    while((n>0)&(ctr<4),
      tmp=substring(str,n-1,n);
      if(contains(ascii,tmp),ctr=ctr+1,ctr=ctr+2);
      n=n-1;
    ); 
    tmp1=substring(str,n,npos);
    n=npos+1;
    ctr=0;
    while((n<=length(str))&(ctr<4),
      tmp=substring(str,n-1,n);
      if(contains(ascii,tmp),ctr=ctr+1,ctr=ctr+2);
      n=n+1;
    );  
    tmp2=substring(str,npos,n-1);
    p1=pos+1/3*dp;
    drawtext(p1,tmp1,size->22,align->"right");
    drawtext(p1,tmp2,size->22,align->"left");
  ); //211109to
);

Addfunstr(name,npos,strnow):=(
  regional(str,tmp,out);
  str=Instr(name);
  tmp="";
  tmp=substring(strnow,0,npos)+str;
  tmp=tmp+substring(strnow,npos,length(strnow));
  out=[tmp,npos+length(str)];
  funflg=0;
  out;
);

Keytable(nx,dx,ny,dy,plb,clr):=Keytable(nx,dx,ny,dy,plb,clr,[],0,22,1); //210629
Keytable(nx,dx,ny,dy,plb,clr,nameL,nmove,sz):=Keytable(nx,dx,ny,dy,plb,clr,nameL,nmove,sz,1);
Keytable(nx,dx,ny,dy,plb,clr,nameL,nmove,sz,shade):=(
  regional(xL,yL,plt,prt,prb,row,col,name,tmp1,tmp2,pos);
  if(nx>0,  //211012from
    xL=apply(0..nx,#/10*dx+plb_1);
  ,
    xL=[plb_1];
    forall(dx,
      tmp=xL_(-1)+#/10;
      xL=append(xL,tmp);
    );
  );
  if(ny>0,
    yL=apply(0..ny,(ny-#)/10*dy+plb_2);
  ,
    yL=[plb_2];
    forall(dy,
      tmp=yL_(-1)+#/10;
      yL=append(yL,tmp);
    );
  );  //211012to
  plt=[xL_1,yL_1]; prt=[xL_(-1),yL_1]; prb=[xL_(-1),yL_(-1)];
  if(shade==1,
    fillpoly([plb,plt,prt,prb,plb],color->clr);
  );
  forall(xL,draw([#,plb_2],[#,plt_2],color->[0,0,0]));
  forall(yL,draw([plb_1,#],[prb_1,#],color->[0,0,0]));
  if(length(nameL)>0,
    forall(1..(length(yL)-1),row,
      tmp1=yL_row;
      tmp2=yL_(row+1);
      pos=[0,(tmp1+tmp2)/2];
      forall(1..(length(xL)-1),col,
        name=nameL_row_col;
        tmp1=xL_col;
        tmp2=xL_(col+1);
        pos_1=(tmp1+tmp2)/2;
       drawtext(pos+nmove,name,align->"mid",size->sz);
      );
    );
  );
);

Allclear():=(
  StrL_ch="";
  strnow="";
  npos=0;
  Subsedit(BoxL_ch,"");
  funflg=0;
);

Deletekey():=(
  regional(tmp1,tmp2);
  if(npos>0,
    tmp1=substring(strnow,0,npos-1);
    tmp2=substring(strnow,npos,length(strnow));
    StrL_ch=tmp1+tmp2;
    strnow=StrL_ch;
    Subsedit(BoxL_ch,strnow);
    npos=npos-1;
    funflg=0;
  );
);

LFmark=unicode("000a");
CRmark=unicode("000d");
Dq=unicode("0022");
Dqq(str):=(
  unicode("0022")+str+unicode("0022");
);




List2line(stLL):=(
  regional(tab,nn,nc,tmp,str,st,out);
  tab=unicode("0009");
  out="";
  forall(1..(length(stLL)),nn,
    st=stLL_nn;
    str="";
    forall(1..(length(st)),
      tmp=st_#;
      if(!isstring(tmp),tmp=format(tmp,10));
      str=str+tmp+tab;
    );
    str=substring(str,0,length(str)-1);
    out=out+str;
    if(nn<length(stLL),out=out+"CR");
  );
  out;  
);

Line2list(strorg):=(
  regional(tab,stL,st,nn,tL,mx,flg,tmp);
  tab=unicode("0009");
  str=replace(strorg,";;",tab);
  flg=indexof(str,"::");
   tL=[];
  if(indexof(str,"CR")>0,
    stL=tokenize(str,"CR");
    forall(1..(length(stL)),nn,
      st=stL_nn;
      if(!isstring(st),st=format(st,10));
      stL_nn=tokenize(st,tab);
    );
  ,
    stL=tokenize(str,tab);
    forall(1..(length(stL)),
      tmp=stL_#;
      if(indexof(tmp,"::")>0,tmp=tokenize(tmp,"::"));
      stL_#=tmp;
    );
  );
  stL;
);
Seteditable(5,["","Size=18","Width=160"]);
Seteditable(116,["","Size=18","Width=530"]);
Text5.xy=[11.5,1.5];
Str="";
StrL=[];
Strnow="";
Strt="";
Strc="";
Strnq="";
Texstr="";
Nfun=1;
npos=2;
dispflg=0;
tpos=[11,9.8];
dpos=[0,-1];

Keyname():=(
  regional(nL);
  nL=[
    ["BS","CL","<-","->"],
    ["fr(",",",")","OK"],
    ["x","7","8","9"],
    ["y","4","5","6"],
    ["z","1","2","3"],
    ["","","","0"]
  ];
  nL;
);


Addfunstr(name,npos,strnow):=(
  regional(str,tmp,out);
  str=Instr(name);
  tmp="";
  tmp=substring(strnow,0,npos)+str;
  tmp=tmp+substring(strnow,npos,length(strnow));
  out=[tmp,npos+length(str)];
  funflg=0;
  out;
);

Gettexform(str):=(
  regional(err,subL,strt,tmp,tmp1,tmp2,tmp3,tmp4);
  err="";
  tmp=Sepchar(str);
  subL=tmp_1;
  err=tmp_2;
  strt="";
  forall(subL,
    if(substring(#,0,1)=="@",
      strt=strt+substring(#,1,length(#));
    ,
      tmp=#;
      tmp=replace(#," ","(sp)");
      tmp=Modifyfortex(tmp);
      tmp=Morefunction(tmp);
      tmp1=Totexform(tmp);
      tmp1=replace(tmp1,"a r r a y","array"); //210606[2lines]
      repeat(5,tmp1=replace(tmp1,"c c","cc"));
      tmp1=replace(tmp1,"c i r c","\circ");
      tmp1=Greekletter(tmp1); //210514[3lines]
      tmp1=Capitalletter(tmp1);
      tmp1=Boldletter(tmp1);
      strt=strt+"$"+tmp1+"$";
    );
  );
  strt;
);

GetplotL(str):=(
  regional(out,fd,fun,rng,clr,num,exc,op,tmpL,tmp,tmp1,tmp2,tmp3);
  tmpL=Strsplit(str,"//");
  out=[];
  forall(tmpL,fd,
    fun="";
    rng="x=[XMIN,XMAX]";
    clr="Color=black";
    num="Num=50";
    exc="Exc=[]";
    tmp1=Indexall(fd,"=");
    forall(tmp1,
      tmp=substring(fd,#-2,#-1);
      tmp2=substring(fd,#,length(fd));
      tmp3=indexof(tmp2,"=");
      if(tmp3>0,
        tmp2=substring(tmp2,0,tmp3-2);
      );
      if(tmp=="y",
        fun=Tocindyform(tmp2);
        fun=replace(fun,"e^(","exp(");
      );
      if(tmp=="C",
        if(indexof(tmp2,",")>0,
          clr="Color=["+tmp2+"]";
        ,
          clr="black";
          if(tmp2=="1",clr="red");
          if(tmp2=="2",clr="blue");
          if(tmp2=="3",clr="green");
          if(tmp2=="4",clr="yellow");
          if(tmp2=="5",clr="[1,0,1]");
          if(tmp2=="6",clr="[0.5,0.5,0]");
          if(indexof(tmp2,",")>0,clr="["+tmp2+"]");
          clr="Color="+clr;
       );
      );
      if(tmp=="x",
        rng=Tocindyform(tmp2);
        rng="x=["+replace(rng,"e^(","exp(")+"]";
      );
      if(tmp=="N",
        num="Num="+tmp2;
      );
      if(tmp=="E",
        exc=Tocindyform(tmp2);
        exc="Exc=["+replace(exc,"e^(","exp(")+"]";
      );
    );
    out=append(out,[fun,rng,clr,num,exc]);
  );
  out;
);






Keytable(nx,dx,ny,dy,plb,clr):=Keytable(nx,dx,ny,dy,plb,clr,[],0,22,1); //210629
Keytable(nx,dx,ny,dy,plb,clr,nameL,nmove,sz):=Keytable(nx,dx,ny,dy,plb,clr,nameL,nmove,sz,1);
Keytable(nx,dx,ny,dy,plb,clr,nameL,nmove,sz,shade):=(
  regional(xL,yL,plt,prt,prb,row,col,name,tmp1,tmp2,pos);
  if(nx>0,  //211012from
    xL=apply(0..nx,#/10*dx+plb_1);
  ,
    xL=[plb_1];
    forall(dx,
      tmp=xL_(-1)+#/10;
      xL=append(xL,tmp);
    );
  );
  if(ny>0,
    yL=apply(0..ny,(ny-#)/10*dy+plb_2);
  ,
    yL=[plb_2];
    forall(dy,
      tmp=yL_(-1)+#/10;
      yL=append(yL,tmp);
    );
  );  //211012to
  plt=[xL_1,yL_1]; prt=[xL_(-1),yL_1]; prb=[xL_(-1),yL_(-1)];
  if(shade==1,
    fillpoly([plb,plt,prt,prb,plb],color->clr);
  );
  forall(xL,draw([#,plb_2],[#,plt_2],color->[0,0,0]));
  forall(yL,draw([plb_1,#],[prb_1,#],color->[0,0,0]));
  if(length(nameL)>0,
    forall(1..(length(yL)-1),row,
      tmp1=yL_row;
      tmp2=yL_(row+1);
      pos=[0,(tmp1+tmp2)/2];
      forall(1..(length(xL)-1),col,
        name=nameL_row_col;
        tmp1=xL_col;
        tmp2=xL_(col+1);
        pos_1=(tmp1+tmp2)/2;
        drawtext(pos+nmove,name,align->"mid",size->sz);
      );
    );
  );
);


Key2fun():=(
  regional(out);
  out="";
  forall(keyL,
    out=out+#;
  );
  out;
);

Manifun=["Display()","Delete()","Clear()","Left()","Right()"];

Delete():=(
  regional(tmp,tmp1,tmp2,tmp3);
  if(length(Str)>0,
    tmp=indexof(Str,"?");
    if(tmp>1,
      tmp1=substring(Str,0,tmp-2)+"?";
      tmp2=substring(Str,tmp,length(Str));
      Str=tmp1+tmp2;
      npos=tmp-1;
    );
    if(tmp==0,
      Str=substring(Str,0,length(Str)-1);
      npos=length(Str);
    );
  );
);

Clear():=(
  regional(tmp);
  Str="";
  Strnq="";
  npos=0;
  Strnow=Str;
  Subsedit(5,Str);
);

Left():=(
  regional(tmp,tmp1,tmp2,tmp3);
  if(length(Str)>0,
    tmp=indexof(Str,"?");
    if(tmp>1,
      tmp1=substring(Str,0,tmp-2)+"?";
      tmp2=substring(Str,tmp-2,tmp-1);
      tmp3=substring(Str,tmp,length(Str));
      Str=tmp1+tmp2+tmp3;
      npos=length(tmp1+"?");
    );
    if(tmp==0,
      tmp1=substring(Str,0,length(Str)-1)+"?";
      tmp3=substring(Str,length(Str)-1,length(Str));
      Str=tmp1+tmp3;  
      npos=length(tmp1);
    );
  );
);

Right():=(
  regional(tmp,tmp1,tmp2,tmp3);
  if(length(Str)>0,
    tmp=indexof(Str,"?");
    if(tmp>0,
      if(tmp<length(Str)-1,
        tmp1=substring(Str,0,tmp-1);
        tmp2=substring(Str,tmp,tmp+1)+"?";
        tmp3=substring(Str,tmp+1,length(Str));
        Str=tmp1+tmp2+tmp3;
        npos=length(tmp1+"?");
      );
      if(tmp==length(Str)-1,
        tmp1=substring(Str,0,tmp-1);
        tmp3=substring(Str,tmp,length(Str));
        Str=tmp1+tmp3;
        npos=length(Str);
      );
    );
  );
);

Gridpaper():=(
  regional(mv,tmp,tmp1);
  mv=0.3;
  Drwexpr([XMAX,-mv],"x",15);
  Drwexpr([-mv,YMAX],"y",15);
  draw([XMIN,0],[XMAX,0],color->[0,0,0]);
  draw([0,YMIN],[0,YMAX],color->[0,0,0]);
  tmp=apply(remove((-10)..(10),[0]),[#,text(#)]);
  tmp=flatten(tmp);;
  Htickmark(tmp);
  Vtickmark(tmp);
);



drwt(line,str):=(
  drawtext([-6,poy],text(line)+" "+str,size->15);
  poy=poy-0.8;
);

Makeplanes(c1L,c2L):=(
  regional(dd,dx,dy,nv1,nv2,vv,tmp,tmp1);
  dd=Crossprod(c1L_[1,2],c2L_[1,2]);
  dx=Crossprod(c1L_[4,2],c2L_[4,2]);
  dy=Crossprod(c1L_[1,4],c2L_[1,4]);
  tmp=[dx,dy,0]/dd;
  Pointdata3d("A",tmp,["Size=4","L=ne"]);
  nv1=c1L_[1,2,3];
  nv2=c2L_[1,2,3];
  Perpplane("B1-C1","A",nv1,["L=ne,0.8","Size=3","Color=red"]);
  Perpplane("B2-C2","A",nv2,["L=ne,0.8","Size=3","Color=cyan"]);
  tmp=A3d+2*(B13d-A3d);
  Pointdata3d("D1",tmp,["Size=3"]);
  tmp=D13d+4*(C13d-A3d);
  Pointdata3d("E1",tmp,["Size=3"]);
  tmp=A3d-2*(B13d-A3d);
  Pointdata3d("G1",tmp,["Size=3"]);
  tmp=G13d+4*(C13d-A3d);
  Pointdata3d("F1",tmp,["Size=3"]);
  Spaceline("1",[D13d,E13d,F13d,G13d,D13d],["nodisp"]);
  tmp=A3d+2*(B23d-A3d);
  Pointdata3d("D2",tmp,["Size=3"]);
  tmp=D23d+4*(C23d-A3d);
  Pointdata3d("E2",tmp,["Size=3"]);
  tmp=A3d-2*(B23d-A3d);
  Pointdata3d("G2",tmp,["Size=3"]);
  tmp=G23d+4*(C23d-A3d);
  Pointdata3d("F2",tmp,["Size=3"]);
  Spaceline("2",[D23d,E23d,F23d,G23d,D23d],["nodisp"]);
  vv=Crossprod(nv1,nv2);
  vv=vv/Norm(vv);
  if(vv_3<0,vv=-vv);
  Spaceline("3",[A3d-vv,A3d+5*vv],["Color=red"]);
);

nohidflg=0;
skeleflg=0;

okflg=0;
Ketinit(1);
Ketinit3d(0);

;

</script>
<script id="csdraw" type="text/x-cindyscript">
poy=4.5;

Start3d([]);

nameL=Keyname();
Keytable(4,12,6,9,[5,-4],[1,1,0],nameL,[0,-0.1],22);


if(okflg==0,
  Str=Textedit(2,"","");
  if(funflg==1,
    if(contains(Manifun,name),
      parse(name+";");
    ,
      tmp=indexof(Str,"?");
      if(tmp>0,npos=tmp,npos=length(Str));
      out=Addfunstr(name,npos,Str);
      tmp=length(out_1)-length(Str);
      npos=npos+tmp;
      Str=out_1; //npos=out_2;
      if(npos<length(Str),
        tmp=replace(Str,"?","");
        tmp1=substring(tmp,0,npos-1)+"?";
        Str=tmp1+substring(tmp,npos-1,length(tmp));
      );
    );
    Subsedit(5,Str);
    funflg=0;
  );
);

if(length(Str)>0,
  Subsedit(2,Str);
  Strnq=replace(Str,"?","");
  Texstr=Gettexform(Strnq);
  if(okflg==0,
    Letter([5.5,3],"e",Texstr,["Size=1.5"]);
  );
);

if(okflg==1,
  Strnq=replace(Str,"?","");
  tmp=Getlevel(Strnq,",");
  tmp1=select(tmp,#_2==0);
  forall(tmp1,
    Strnq_(#_1)="%";
  );
  tmp2=Strsplit(Strnq,"%");
  py=5;
  forall(tmp2,
    tmp=Gettexform(#);
    Letter([5,py],"e",tmp,["Size=1.5"]);
    py=py-1;
  );
);

Pointdata3d("O",[0,0,0]);
Xyzax3data("","x=[-4,4]","y=[-4,4]","z=[-1,4]");

c1L=[2,3,1,1];
c2L=[1,-1,2,3];
tmp=Makeplanes(c1L,c2L);
tmp=[["D1","E1","F1","G1"],["D2","E2","F2","G2"]];
tmp2=Concatobj(tmp);
Vertexedgeface("1",tmp2);

if(nohidflg==1,
  Nohiddenbyfaces("1",
    ["ax3d","phe3d1"],["phf3d1"]);
);
if(skeleflg==1,
  tmp=["ax3d","phe3d1"];
  Skeletonparadata("1",tmp,tmp,[1.5]);
);

Windispg();

;

</script>
    <script type="text/javascript">
var cdy = CindyJS({
  scripts: "cs*",
  use: ["katex"],
  defaultAppearance: {
    dimDependent: 0.7,
    fontFamily: "sans-serif",
    lineSize: 1,
    pointSize: 5.0,
    textsize: 12.0
  },
  angleUnit: "",
  geometry: [
    {name: "FI", type: "Free", pos: [4.0, 2.9486804139327703, -0.8424801182665058], color: [1.0, 0.0, 0.0], labeled: true, size: 5.5, border: true },
    {name: "SW", type: "Free", pos: [4.0, 2.097132613295496, -0.8331647024895681], color: [1.0,1.0,1.0], labeled: false, size: 2.0, border:false },
    {name: "NE", type: "Free", pos: [-3.5662650602409176, -4.0, -0.7711833476450137], color: [1.0,1.0,1.0], labeled: false, size: 2.0, border:false },
    {name: "LB", type: "Free", pos: [4.0, 2.5454545454545454, -0.7272727272727273], color: [1.0, 0.0, 0.0], size: 0.0, border: true },
    {name: "TH", type: "Free", pos: [-2.469899972188156, -4.0, 1.3333333333333333], color: [1.0, 0.0, 0.0], labeled: true, size: 5.5, border: true },
    {name: "Text0", type: "Button", pos: [0.38766519823788553, -4.0, 0.9501641815693157], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 0.737, 0.467], fillalpha: 0.27272728085517883, script: "nohidflg=1-nohidflg;\nskeleflg=0;", text: "Nohid", textsize: 18.0},
    {name: "Text1", type: "Button", pos: [-0.986784140969163, -4.0, 0.9501641815693157], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 0.737, 0.467], fillalpha: 0.29914529914529914, script: "skeleflg=1-skeleflg;\nnohidflg=0;", text: "Skele", textsize: 18.0},
    {name: "Text23", type: "Button", pos: [4.0, -1.6509433962264148, 0.45288833387639527], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"n0\";", text: "", textsize: 18.0},
    {name: "Text25", type: "Button", pos: [4.0, -1.7216828478964399, 0.621439008296413], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"n2\";", text: "", textsize: 18.0},
    {name: "Text26", type: "Button", pos: [4.0, -1.4545454545454546, 0.5289935359878557], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"n2\";", text: " ", textsize: 18.0},
    {name: "Text27", type: "Button", pos: [4.0, -1.2582159624413147, 0.4507620975671165], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"n3\";", text: "", textsize: 18.0},
    {name: "Text29", type: "Button", pos: [4.0, -1.1779935275080906, 0.621439008296413], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"n4\";", text: "", textsize: 18.0},
    {name: "Text30", type: "Button", pos: [4.0, -0.9700272479564034, 0.5232279388653722], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"n5\";", text: "", textsize: 18.0},
    {name: "Text31", type: "Button", pos: [4.0, -0.8450704225352114, 0.4507620975671165], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"n6\";", text: "", textsize: 18.0},
    {name: "Text33", type: "Button", pos: [4.0, -0.6233766233766234, 0.6234566674142584], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"n7\";;", text: "", textsize: 18.0},
    {name: "Text34", type: "Button", pos: [4.0, -0.5108695652173912, 0.5218061238141076], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"8\";", text: "", textsize: 18.0},
    {name: "Text35", type: "Button", pos: [4.0, -0.4245283018867924, 0.45288833387639527], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"9\";", text: "", textsize: 18.0},
    {name: "Text20", type: "Button", pos: [4.0, -2.766798418972332, 0.758990725547793], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"=\";", text: "", textsize: 18.0},
    {name: "Text21", type: "Button", pos: [4.0, -2.2564102564102564, 0.6154636332166398], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"+\";", text: "", textsize: 18.0},
    {name: "Text22", type: "Button", pos: [4.0, -1.9130434782608696, 0.5218061238141076], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"-\";", text: "", textsize: 18.0},
    {name: "Text24", type: "Button", pos: [4.0, -2.110236220472441, 0.7560025730850064], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"z\";", text: "", textsize: 18.0},
    {name: "Text28", type: "Button", pos: [4.0, -1.402390438247012, 0.7650384604127156], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"y\";", text: "", textsize: 18.0},
    {name: "Text32", type: "Button", pos: [4.0, -0.7114624505928855, 0.758990725547793], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"x\";", text: "", textsize: 18.0},
    {name: "Text36", type: "Button", pos: [4.0, -0.06349206349206349, 0.7620025935063159], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"fr(\";", text: "", textsize: 18.0},
    {name: "Text40", type: "Button", pos: [4.0, 0.6349206349206349, 0.7620025935063159], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"Delete()\";;", text: "", textsize: 18.0},
    {name: "Text41", type: "Button", pos: [4.0, 0.4630225080385853, 0.6174426159601017], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"Clear()\";", text: "", textsize: 18.0},
    {name: "Text42", type: "Button", pos: [4.0, 0.4456521739130435, 0.5218061238141076], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"Left()\";", text: "", textsize: 18.0},
    {name: "Text43", type: "Button", pos: [4.0, 0.3764705882352941, 0.45182271426727433], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"Right()\";", text: "", textsize: 18.0},
    {name: "Text37", type: "Button", pos: [4.0, -0.025889967637540458, 0.621439008296413], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"L,\";", text: "", textsize: 18.0},
    {name: "Text38", type: "Button", pos: [4.0, -0.021739130434782608, 0.5218061238141076], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "funflg=1;name=\"L)\";", text: "", textsize: 18.0},
    {name: "Text39", type: "Button", pos: [4.0, 0.009389671361502348, 0.4507620975671165], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 0.27272728085517883, script: "okflg=1;", text: "", textsize: 18.0},
    {name: "Text2", type: "EditableText", pos: [4.0, 1.4634146341463414, 0.7805880226162261], color: [0.0, 0.0, 0.0], fillcolor: [1.0, 1.0, 1.0], fillalpha: 1.0, minwidth: 300, textsize: 18.0}
  ],
  ports: [{
    id: "CSCanvas",
    width: 943,
    height: 559,
    transform: [{visibleRect: [-7.342807154358745, 6.384596859038171, 12.300503899713018, -5.259741294966194]}],
    grid: 1.0,
    background: "rgb(247,247,247)"
  }],
  csconsole: false,
  use: ["katex"],
  cinderella: {build: 2044, version: [3, 0, 2044]}
});
    </script>
</head>
<body>
    <div id="CSCanvas"></div>
</body>
</html>
